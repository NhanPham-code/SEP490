@{
    var userId = Context.Session.GetInt32("UserId");
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewBag.Title</title>

    <!-- Enhanced Styles -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/CustomerUI.styles.css" asp-append-version="true" />
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    <!-- Enhanced Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Hide Google Translate banner and unwanted elements */
        .goog-te-banner-frame,
        iframe.goog-te-banner-frame,
        .goog-logo-link,
        .goog-tooltip,
        .goog-tooltip:hover,
        .goog-text-highlight,
        .goog-te-balloon-frame,
        #goog-gt-tt,
        .goog-te-banner,
        .skiptranslate iframe,
        iframe[src*="translate.googleapis.com"] {
            display: none !important;
            visibility: hidden !important;
        }

        body {
            top: 0px !important;
            margin: 0 !important;
            position: static !important;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .goog-te-gadget {
            color: transparent !important;
            font-size: 0 !important;
        }

            .goog-te-gadget .goog-te-combo {
                margin: 0 !important;
            }

        /* Style the translate dropdown to match navbar */
        .goog-te-combo {
            appearance: none !important;
            background: transparent !important;
            border: none !important;
            color: #475569 !important;
            font-weight: 600 !important;
            padding: 0 !important;
            font-size: 14px !important;
            cursor: pointer !important;
        }

            .goog-te-combo:hover {
                color: #2563eb !important;
            }

            .goog-te-combo option {
                background: white !important;
                color: #475569 !important;
                font-weight: 600 !important;
            }

        /* Custom translate container styling */
        .translate-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .translate-icon {
            color: #475569;
            font-size: 16px;
        }

        .nav-link.active {
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            color: #2563eb !important;
        }

        .nav-link:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        /* Demo content styling */
        .demo-content {
            background: rgba(255,255,255,0.15);
            padding: 25px;
            border-radius: 15px;
            margin: 25px auto;
            max-width: 800px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            color: white;
        }
    </style>
    <style>
        #translate-toggle, #reset-translate-btn {
            padding: 2px 4px !important;
            font-size: 11px !important;
            min-width: 32px !important;
            min-height: 32px !important;
            height: 36px !important;
            width: auto !important;
            line-height: 1;
        }

        #translate-menu {
            width: 110px !important;
            font-size: 12px !important;
            padding: 2px 0 !important;
        }

            #translate-menu button {
                padding: 4px 8px !important;
                font-size: 11px !important;
                line-height: 1.2;
            }
        @@media (max-width: 400px) {
            #translate-toggle span, #reset-translate-btn span

        {
            display: none;
        }

        #translate-menu {
            width: 75px !important;
        }

        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'poppins': ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                            DEFAULT: '#3b82f6',
                        },
                        secondary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                            DEFAULT: '#22c55e',
                        },
                        accent: {
                            DEFAULT: '#a855f7',
                            50: '#faf5ff',
                            100: '#f3e8ff',
                            200: '#e9d5ff',
                            300: '#d8b4fe',
                            400: '#c084fc',
                            500: '#a855f7',
                            600: '#9333ea',
                            700: '#7c2d12',
                            800: '#6b21a8',
                            900: '#581c87',
                        },
                    },
                    borderRadius: {
                        'xl': '12px',
                        '2xl': '16px',
                        '3xl': '20px',
                        '4xl': '24px',
                        'button': '12px',
                        'card': '16px',
                    },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
                        'card': '0 4px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 15px -3px rgba(0, 0, 0, 0.05)',
                        'hover': '0 10px 40px -10px rgba(59, 130, 246, 0.3)',
                        'glow': '0 0 20px rgba(59, 130, 246, 0.4)',
                        'glass': '0 8px 32px rgba(0, 0, 0, 0.1)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'slide-down': 'slideDown 0.3s ease-out',
                        'bounce-subtle': 'bounceSubtle 2s infinite',
                        'pulse-glow': 'pulseGlow 2s ease-in-out infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    backdropBlur: {
                        'xs': '2px',
                        'glass': '20px',
                    }
                },
            },
        };
    </script>

    <!-- Section for custom styles from view -->
    @RenderSection("Styles", required: false)

    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            position: relative;
        }

        /* Enhanced Animations */
        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @@keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @@keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @@keyframes bounceSubtle {
            0%, 100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        @@keyframes pulseGlow {
            0% {
                box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
            }

            100% {
                box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
            }
        }

        @@keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        @@keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Glass Effects */
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px) saturate(120%);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.15);
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px) saturate(120%);
        }

        /* Enhanced Gradient Backgrounds */
        .gradient-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .gradient-secondary {
            background: linear-gradient(135deg, #22c55e 0%, #15803d 100%);
        }

        .gradient-accent {
            background: linear-gradient(135deg, #a855f7 0%, #7c2d12 100%);
        }

        /* Logo Gradient Animation */
        .logo-gradient {
            background: linear-gradient(135deg, #3b82f6, #a855f7, #22c55e);
            background-size: 300% 300%;
            animation: gradientShift 8s ease-in-out infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Enhanced Search */
        .search-enhanced {
            background: rgba(255, 255, 255, 1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .search-enhanced:focus-within {
            background: rgba(255, 255, 255, 1);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        /* Enhanced Buttons */
        .btn-enhanced {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-enhanced::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: all 0.4s ease;
            transform: translate(-50%, -50%);
        }

        .btn-enhanced:active::before {
            width: 300px;
            height: 300px;
        }

        /* Enhanced Bottom Navigation - Responsive */
        .bottom-nav-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 44px; /* Minimum touch target */
            min-height: 44px;
        }

        .bottom-nav-item.active {
            color: #3b82f6;
            transform: translateY(-2px);
        }

        .bottom-nav-item.active::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: #3b82f6;
            border-radius: 50%;
        }

        /* Profile Avatar in Bottom Nav - Responsive sizes */
        .profile-avatar-nav {
            width: 24px;
            height: 24px;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Small screen optimization */
        @@media (max-width: 375px) {
            .profile-avatar-nav {
                width: 20px;
                height: 20px;
                border: 1px solid #3b82f6;
            }

            .bottom-nav-item {
                padding: 0.5rem 0.25rem !important;
            }

            .bottom-nav-item span {
                font-size: 0.6rem !important;
            }

            .bottom-nav-item .w-8 {
                width: 1.5rem !important;
                height: 1.5rem !important;
            }

            .bottom-nav-item .text-xl {
                font-size: 1rem !important;
            }
        }

        /* Very small screens (320px) */
        @@media (max-width: 320px) {
            .bottom-nav-item {
                padding: 0.5rem 0.125rem !important;
            }

            .bottom-nav-item span {
                display: none; /* Hide text labels on very small screens */
            }

            .profile-avatar-nav {
                width: 18px;
                height: 18px;
            }
        }

        /* Enhanced Badge */
        .notification-badge {
            background: linear-gradient(135deg, #ef4444, #f97316);
            animation: bounceSubtle 2s infinite;
        }

        /* Solid backgrounds */
        .dropdown-solid {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .drawer-solid {
            background: #ffffff !important;
            backdrop-filter: none !important;
            box-shadow: 2px 0 30px rgba(0, 0, 0, 0.4);
            border-right: 1px solid #e2e8f0;
        }

        .mobile-menu-container {
            background: #ffffff !important;
            backdrop-filter: none !important;
        }

        .mobile-menu-content {
            background: #ffffff !important;
        }

        /* Quick Action Button - Responsive positioning */
        .quick-action {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 30;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease;
        }

        .quick-action:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(59, 130, 246, 0.6);
        }

        /* Small screen quick action positioning */
        @@media (max-width: 375px) {
            .quick-action {
                width: 48px;
                height: 48px;
                bottom: 90px;
                right: 15px;
            }
        }

        /* Profile dropdown responsive positioning */
        .profile-dropdown {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 0.5rem;
            width: 16rem;
        }

        @@media (max-width: 425px) {
            .profile-dropdown {
                right: -50%;
                width: 14rem;
            }
        }

        @@media (max-width: 375px) {
            .profile-dropdown {
                right: -75%;
                width: 12rem;
            }
        }

        @@media (max-width: 320px) {
            .profile-dropdown {
                right: -100%;
                width: 11rem;
            }
        }

        /* Bottom safe area for modern phones */
        @@supports (padding: max(0px)) {
            .bottom-nav-safe {
                padding-bottom: max(8px, env(safe-area-inset-bottom));
            }
        }

        /* Bottom navigation container responsive */
        .bottom-nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0.5rem 0.25rem;
            min-height: 60px;
        }

        @@media (max-width: 375px) {
            .bottom-nav-container {
                padding: 0.25rem 0.125rem;
                min-height: 56px;
            }
        }

        @@media (max-width: 320px) {
            .bottom-nav-container {
                padding: 0.25rem 0;
                min-height: 52px;
            }
        }
        #header-mobile{
            position: relative;
        }
    </style>

</head>

<body id="body-mobile" class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 text-slate-800 font-inter">

@{
var accessToken = Context.Request.Cookies["AccessToken"];
var fullName = Context.Session.GetString("FullName");
var avatarUrl = Context.Session.GetString("AvatarUrl");
var userEmail = Context.Session.GetString("Email");
var isLoggedIn = !string.IsNullOrEmpty(accessToken) && !string.IsNullOrEmpty(fullName);
}

<!-- Enhanced Mobile Header - Simplified -->
<header x-data="{
        mobileMenuOpen: false,
        searchOpen: false,
        notificationCount: 3
    }"
        id="header-mobile"
        class="mobile-nav glass-effect  top-0 z-50 shadow-soft">
    <div class="flex justify-between items-center h-16 px-4">

        <!-- Left: Menu Button -->
        <button x-on:click="mobileMenuOpen = true"
                class="w-12 h-12 flex items-center justify-center rounded-xl hover:bg-white/40 transition-all duration-200 active:scale-95">
            <i class="ri-menu-3-line text-xl text-slate-700"></i>
        </button>

        <!-- Center: Logo -->
        <a asp-controller="Home" asp-action="Index" class="flex items-center space-x-2">
            <div class="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center shadow-soft">
                <i class="ri-football-line text-white text-lg animate-float"></i>
            </div>
            <h1 class="font-poppins font-bold text-xl logo-gradient">Sportivey</h1>
        </a>

            <!-- Right: Actions (Simplified for better UX) -->
            <div class="flex items-center space-x-2">
                @if (isLoggedIn)
                {

                    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
                    <!-- Đổi từ <a ...> sang <button ...> -->
                    <button type="button"
                            x-data="chatBadge()"
                            x-init="init()"
                            class="relative w-12 h-12 flex items-center justify-center rounded-xl gradient-secondary shadow-soft hover:shadow-hover transition-all duration-300 active:scale-95"
                            title="Messages"
                            x-on:click.prevent="openChat">
                        <i class="ri-message-3-line text-lg text-white"></i>
                        <span x-show="unreadCount > 0"
                              class="notification-badge absolute -top-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center text-xs text-white font-bold"
                              x-text="unreadCount"></span>
                    </button>

                }
                else
                {
                    <!-- Sign In Button -->
                    <a asp-controller="Common" asp-action="Login">
                        <button class="w-12 h-12 flex items-center justify-center rounded-xl gradient-primary shadow-soft hover:shadow-hover transition-all duration-200 active:scale-95">
                            <i class="ri-user-line text-xl text-white"></i>
                        </button>
                    </a>
                }
            </div>
        </div>

    <!-- Enhanced Mobile Menu Overlay -->
    <div x-show="mobileMenuOpen"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-1"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-1"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 z-40"
         x-on:click="mobileMenuOpen = false">
        <div x-show="mobileMenuOpen"
             x-transition:enter="transition ease-out duration-300 transform"
             x-transition:enter-start="-translate-x-full"
             x-transition:enter-end="translate-x-0"
             x-transition:leave="transition ease-in duration-200 transform"
             x-transition:leave-start="translate-x-0"
             x-transition:leave-end="-translate-x-full"
             x-on:click.stop
             class="fixed left-0 top-0 h-full w-80 bg-white shadow-2xl z-50 mobile-menu-container">

            <div class="p-6 bg-white mobile-menu-content">
                <!-- Menu Header -->
                <div class="flex justify-between items-center mb-8">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center shadow-soft">
                            <i class="ri-football-line text-white text-lg"></i>
                        </div>
                        <h2 class="font-poppins font-bold text-xl logo-gradient">Sportivey</h2>
                    </div>
                    <button x-on:click="mobileMenuOpen = false"
                            class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100 transition-all duration-200">
                        <i class="ri-close-line text-xl text-slate-700"></i>
                    </button>
                </div>

                <!-- Enhanced Navigation -->
                <nav class="space-y-2">
                    <a href="#" class="flex items-center px-4 py-4 text-slate-700 hover:bg-primary/10 hover:text-primary rounded-2xl transition-all duration-200 group">
                        <div class="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center mr-4 group-hover:bg-primary/20 transition-colors">
                            <i class="ri-phone-line text-primary"></i>
                        </div>
                        <span class="font-medium text-lg">Contact Support</span>
                    </a>

                    <a asp-controller="Common" asp-action="Settings" class="flex items-center px-4 py-4 text-slate-700 hover:bg-secondary/10 hover:text-secondary rounded-2xl transition-all duration-200 group">
                        <div class="w-10 h-10 bg-secondary/10 rounded-xl flex items-center justify-center mr-4 group-hover:bg-secondary/20 transition-colors">
                            <i class="ri-settings-3-line text-secondary"></i>
                        </div>
                        <span class="font-medium text-lg">Settings</span>
                    </a>

                    <a href="#" class="flex items-center px-4 py-4 text-slate-700 hover:bg-accent/10 hover:text-accent rounded-2xl transition-all duration-200 group">
                        <div class="w-10 h-10 bg-accent/10 rounded-xl flex items-center justify-center mr-4 group-hover:bg-accent/20 transition-colors">
                            <i class="ri-information-line text-accent"></i>
                        </div>
                        <span class="font-medium text-lg">About</span>
                    </a>

                    <a href="#" class="flex items-center px-4 py-4 text-slate-700 hover:bg-primary/10 hover:text-primary rounded-2xl transition-all duration-200 group">
                        <div class="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center mr-4 group-hover:bg-primary/20 transition-colors">
                            <i class="ri-star-line text-primary"></i>
                        </div>
                        <span class="font-medium text-lg">Rate App</span>
                    </a>
                </nav>

                <!-- User Info in Drawer (if logged in) -->
                @if (isLoggedIn)
                {
                <div class="mt-8 pt-6 border-t border-slate-200">
                    <div class="bg-gradient-to-r from-primary/10 to-secondary/10 p-4 rounded-2xl">
                        <div class="flex items-center space-x-3">
                            <img src="@avatarUrl" alt="Avatar" class="w-12 h-12 rounded-xl border-2 border-white shadow-sm" />
                            <div>
                                <p class="font-semibold text-slate-800">@fullName</p>
                                <p class="text-sm text-slate-500">Premium Member</p>
                            </div>
                        </div>
                    </div>
                </div>
                }
                else
                {
                <div class="mt-8 pt-6 border-t border-slate-200">
                    <a asp-controller="Common" asp-action="Login">
                        <button class="w-full btn-enhanced gradient-primary text-white py-4 rounded-2xl font-semibold shadow-soft hover:shadow-hover transition-all duration-300 flex items-center justify-center space-x-2">
                            <i class="ri-login-circle-line text-lg"></i>
                            <span>Đăng nhập</span>
                        </button>
                    </a>
                </div>
                }
            </div>
        </div>
    </div>
</header>

<!-- Quick Action Button (Floating Action Button) -->
<button class="quick-action">
    <i class="ri-add-line text-2xl text-white"></i>
</button>

<!-- Enhanced Bottom Navigation with Profile - Responsive -->
<nav id="nav-mobile" x-data="{
        activeTab: 'home',
        userMenuOpen: false
    }" class="mobile-nav fixed bottom-0 left-0 right-0 glass-effect border-t border-slate-200 z-40 shadow-soft bottom-nav-safe" >
    <div class="bottom-nav-container">
        <!-- Home -->
        <a asp-controller="Home" asp-action="Index"
           x-on:click="activeTab = 'home'"
           :class="activeTab === 'home' ? 'bottom-nav-item active' : 'bottom-nav-item'"
           class="flex flex-col items-center py-2 px-1 text-slate-400 hover:text-primary transition-all duration-200 hover:scale-105 relative flex-1 max-w-none">
            <div class="w-6 h-6 flex items-center justify-center">
                <i class="ri-home-4-line text-lg"></i>
            </div>
            <span class="text-xs mt-1 font-medium truncate">Trang chủ</span>
        </a>

        <!-- Groups/Teams -->
        <a asp-controller="Findteam" asp-action="Findteam"
           x-on:click="activeTab = 'groups'"
           :class="activeTab === 'groups' ? 'bottom-nav-item active' : 'bottom-nav-item'"
           class="flex flex-col items-center py-2 px-1 text-slate-400 hover:text-accent transition-all duration-200 hover:scale-105 relative flex-1 max-w-none">
            <div class="w-6 h-6 flex items-center justify-center">
                <i class="ri-team-line text-lg"></i>
            </div>
            <span class="text-xs mt-1 font-medium truncate">Tìm nhóm</span>
        </a>

        <!-- Notifications -->
        <a asp-controller="Notification" asp-action="Index"
           x-on:click="activeTab = 'notifications'"
           :class="activeTab === 'notifications' ? 'bottom-nav-item active' : 'bottom-nav-item'"
           class="flex flex-col items-center py-2 px-1 text-slate-400 hover:text-orange-500 transition-all duration-200 hover:scale-105 relative flex-1 max-w-none">
            <div class="w-6 h-6 flex items-center justify-center relative">
                <i class="ri-notification-3-line text-lg"></i>
                <span id="notification-badge-bottom"
                      class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full flex items-center justify-center text-xs text-white font-bold"
                      style="font-size: 8px; display:none"></span>
            </div>
            <span class="text-xs mt-1 font-medium truncate">Thông báo</span>
        </a>

            
            <div class="flex flex-col items-center flex-1 max-w-none px-1">
                <div class="relative flex flex-col items-center justify-center" style="min-width:32px;">
                    <button id="translate-toggle"
                            type="button"
                            class="nav-link p-1 text-slate-600 hover:text-blue-600 font-semibold flex flex-col items-center text-[11px] rounded transition-all duration-200"
                            style="min-width: 32px; min-height: 32px; height:36px;">
                        <i class="ri-translate-2 text-base leading-none"></i>
                        <span class="leading-tight text-[10px]">Ngôn ngữ</span>
                        <i class="ri-arrow-up-s-line text-xs leading-none"></i>
                    </button>
                    <!-- Menu xổ lên trên -->
                    <div id="translate-menu"
                         class="absolute right-0 bottom-full mb-1 w-28 bg-white rounded shadow border border-gray-200 hidden z-50"
                         style="transform: translateY(-4px); font-size:12px;">
                        <button data-lang="en" class="block w-full text-left px-2 py-1 text-slate-600 hover:text-blue-600 text-xs">English</button>
                        <button data-lang="vi" class="block w-full text-left px-2 py-1 text-slate-600 hover:text-blue-600 text-xs">Tiếng Việt</button>
                        <button data-lang="ja" class="block w-full text-left px-2 py-1 text-slate-600 hover:text-blue-600 text-xs">日本語</button>
                        <button data-lang="ko" class="block w-full text-left px-2 py-1 text-slate-600 hover:text-blue-600 text-xs">한국어</button>
                        <button data-lang="zh-CN" class="block w-full text-left px-2 py-1 text-slate-600 hover:text-blue-600 text-xs">中文</button>
                        <button data-lang="fr" class="block w-full text-left px-2 py-1 text-slate-600 hover:text-blue-600 text-xs">Français</button>
                        <button data-lang="de" class="block w-full text-left px-2 py-1 text-slate-600 hover:text-blue-600 text-xs">Deutsch</button>
                        <button data-lang="it" class="block w-full text-left px-2 py-1 text-slate-600 hover:text-blue-600 text-xs">Italiano</button>
                        <button data-lang="es" class="block w-full text-left px-2 py-1 text-slate-600 hover:text-blue-600 text-xs">Español</button>
                    </div>
                </div>
            </div>
            <!-- Nút Mặc định (reset nhỏ gọn) -->
            <div class="flex flex-col items-center flex-1 max-w-none px-1">
                <button id="reset-translate-btn"
                        type="button"
                        class="px-1 py-1 text-slate-600 hover:text-blue-600 font-semibold flex flex-col items-center text-[11px] rounded transition-all duration-200"
                        style="min-width: 32px; min-height: 32px; height:36px;">
                    <i class="ri-refresh-line text-base leading-none"></i>
                    <span class="leading-tight text-[10px]">Mặc định</span>
                </button>
            </div>



            <!-- User Profile -->
            <div class="relative flex-1 max-w-none">
                @if (isLoggedIn)
                {
                    <button x-on:click="userMenuOpen = !userMenuOpen; activeTab = 'profile'"
                            :class="activeTab === 'profile' ? 'bottom-nav-item active' : 'bottom-nav-item'"
                            class="flex flex-col items-center py-2 px-1 text-slate-400 hover:text-primary transition-all duration-200 hover:scale-105 relative w-full">
                        <div class="w-6 h-6 flex items-center justify-center">
                            <img src="@avatarUrl" alt="Avatar" class="profile-avatar-nav" />
                        </div>
                        <span class="text-xs mt-1 font-medium truncate">Profile</span>
                    </button>

            <!-- Profile Menu Popup - Responsive positioning -->
            <div x-show="userMenuOpen"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 scale-95 translate-y-4"
                 x-transition:enter-end="opacity-1 scale-100 translate-y-0"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-1 scale-100 translate-y-0"
                 x-transition:leave-end="opacity-0 scale-95 translate-y-4"
                 x-on:click.away="userMenuOpen = false"
                 class="profile-dropdown dropdown-solid rounded-2xl shadow-card z-50">

                <!-- User Info Header -->
                <div class="p-4 border-b border-slate-200">
                    <div class="flex items-center space-x-3">
                        <img src="@avatarUrl" alt="Avatar"
                             class="w-12 h-12 rounded-xl border-2 border-primary/30 shadow-sm" />
                        <div class="flex-1">
                            <p class="font-semibold text-slate-800 leading-tight">@fullName</p>
                            <p class="text-sm text-slate-500 truncate">@userEmail</p>
                            <span class="inline-flex items-center px-2 py-1 bg-gradient-to-r from-primary to-accent text-white text-xs rounded-full font-medium mt-1">
                                        <i class="ri-vip-crown-line mr-1"></i>Premium
                                    </span>
                        </div>
                    </div>
                </div>

                <!-- Menu Items -->
                <div class="p-2">
                    <!-- Profile Link -->
                    <a asp-controller="Common" asp-action="Profile"
                       x-on:click="userMenuOpen = false"
                       class="flex items-center px-4 py-3 text-slate-700 hover:bg-primary/10 hover:text-primary rounded-xl transition-all duration-200 group">
                        <div class="w-8 h-8 bg-primary/10 rounded-lg flex items-center justify-center mr-3 group-hover:bg-primary/20 transition-colors">
                            <i class="ri-user-3-line text-primary"></i>
                        </div>
                        <div>
                            <span class="font-medium">Thông tin tài khoản</span>
                            <p class="text-xs text-slate-400">Hồ sơ cá nhân</p>
                        </div>
                    </a>

                    <!-- Booking History - Fixed as proper menu item -->
                    <a href="#"
                       x-on:click="userMenuOpen = false"
                       class="flex items-center px-4 py-3 text-slate-700 hover:bg-purple-50 hover:text-purple-600 rounded-xl transition-all duration-200 group">
                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3 group-hover:bg-purple-200 transition-colors">
                            <i class="ri-calendar-check-line text-purple-600"></i>
                        </div>
                        <div>

                            <span class="font-medium">Lịch sử đặt sân</span>
                            <p class="text-xs text-slate-400">Lịch đã đặt</p>
                        </div>
                    </a>

                    <!-- Booking Schedule -->
                    <a asp-controller="Booking" asp-action="BookingSchedule"
                       x-on:click="userMenuOpen = false"
                       class="flex items-center px-4 py-3 text-slate-700 hover:bg-blue-50 hover:text-blue-600 rounded-xl transition-all duration-200 group">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3 group-hover:bg-blue-200 transition-colors">
                            <i class="ri-calendar-todo-line text-blue-600"></i>
                        </div>
                        <div>
                            <span class="font-medium">Lịch chơi</span>
                            <p class="text-xs text-slate-400">Lịch chơi sắp đến</p>
                        </div>
                    </a>
                            <!-- Settings -->
                            <button id="chat-with-admin-btn" type="button"
                                    class="flex items-center px-4 py-3 text-slate-700 hover:bg-purple-50 hover:text-purple-600 rounded-xl transition-all duration-200 group w-full">
                                <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3 group-hover:bg-purple-200 transition-colors">
                                    <i class="ri-message-2-line text-purple-600 text-base"></i>
                                </div>
                                <div>
                                    <span class="font-medium">Admin</span>
                                    <p class="text-xs text-slate-400">Hỗ trợ trực tuyến</p>
                                </div>
                            </button>
                            <input type="hidden" id="senderId" value="@userId" />

                    <!-- Divider -->
                    <hr class="my-3 border-slate-200">

                    <!-- Sign Out -->
                    <a asp-controller="Common" asp-action="Logout"
                       x-on:click="userMenuOpen = false"
                       class="flex items-center px-4 py-3 text-red-600 hover:bg-red-50 rounded-xl transition-all duration-200 group">
                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mr-3 group-hover:bg-red-200 transition-colors">
                            <i class="ri-logout-circle-line text-red-600"></i>
                        </div>
                        <div>
                            <span class="font-medium">Đăng xuất</span>
                            <p class="text-xs text-red-400">Hẹn gặp lại!</p>
                        </div>
                    </a>
                </div>
            </div>
            }
            else
            {
            <a asp-controller="Common" asp-action="Login"
               x-on:click="activeTab = 'profile'"
               :class="activeTab === 'profile' ? 'bottom-nav-item active' : 'bottom-nav-item'"
               class="flex flex-col items-center py-2 px-1 text-slate-400 hover:text-primary transition-all duration-200 hover:scale-105 relative w-full">
                <div class="w-6 h-6 flex items-center justify-center">
                    <i class="ri-user-3-line text-lg"></i>
                </div>
                <span class="text-xs mt-1 font-medium truncate">Đăng nhập</span>
            </a>
            }
        </div>
    </div>
</nav>

<!-- Main Content -->
<div id="main-body" role="main" class="pb-24 max-w-7xl mx-auto px-4 animate-fade-in">
    @RenderBody()
</div>

<!-- Enhanced Footer -->
<footer id="footer" class="bg-gradient-to-r from-slate-900 to-slate-800 text-white py-16 mt-12 relative overflow-hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <!-- Logo & social -->
            <div>
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center">
                        <i class="ri-football-line text-white text-lg"></i>
                    </div>
                    <h3 class="font-poppins font-bold text-2xl logo-gradient">Sportivey</h3>
                </div>
                <p class="text-slate-300 mb-6 leading-relaxed">Điểm đến hàng đầu của bạn để đặt sân thể thao và kết nối với các đội.</p>
            </div>
        </div>

        <div class="border-t border-slate-700 mt-12 pt-8 text-center">
            <p class="text-slate-300">&copy; 2025 Nền tảng Sportivey. Đã đăng ký bản quyền.</p>
        </div>
    </div>

    <!-- Decorative Elements -->
    <div class="absolute top-0 right-0 w-96 h-96 bg-gradient-to-l from-primary/10 to-transparent rounded-full blur-3xl"></div>
    <div class="absolute bottom-0 left-0 w-96 h-96 bg-gradient-to-r from-secondary/10 to-transparent rounded-full blur-3xl"></div>
</footer>

<!-- === MODAL XÁC THỰC BẢO MẬT (Tailwind Style) === -->
<div id="mobileSecurityModal" class="fixed inset-0 z-[9999] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Backdrop (làm mờ nền) -->
    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0" id="mobileSecurityBackdrop"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center">
            <!-- Modal Panel -->
            <div class="relative transform overflow-hidden rounded-3xl bg-white text-left shadow-2xl transition-all w-full max-w-xs opacity-0 scale-95" id="mobileSecurityPanel">

                <!-- Header -->
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 px-4 py-6 text-center">
                    <div class="mx-auto flex h-14 w-14 items-center justify-center rounded-full bg-white/20 mb-3 backdrop-blur-sm">
                        <i class="ri-shield-keyhole-fill text-3xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Bảo mật tài khoản</h3>
                    <p class="text-blue-100 text-sm mt-1">Xác thực danh tính của bạn</p>
                </div>

                <!-- Form -->
                <div class="px-6 py-6">
                    <form id="mobileVerifyPassForm">
                        <div class="relative mb-4">
                            <input type="password" id="mobileSecurityPassword"
                                   class="w-full rounded-xl border-2 border-slate-100 bg-slate-50 py-3.5 px-4 text-slate-900 placeholder:text-slate-400 focus:border-blue-500 focus:ring-0 text-base transition-all"
                                   placeholder="Nhập mật khẩu..." required>
                            <button type="button" onclick="toggleMobilePassVisibility()" class="absolute right-0 top-0 h-full px-4 text-slate-400 active:text-blue-600">
                                <i class="ri-eye-line text-xl" id="mobileEyeIcon"></i>
                            </button>
                        </div>

                        <div id="mobileVerifyErrorMsg" class="mb-4 text-sm text-red-500 text-center hidden bg-red-50 py-2 rounded-lg font-medium"></div>

                        <div class="flex flex-col gap-3">
                            <button type="submit" id="btnMobileConfirm"
                                    class="w-full justify-center rounded-xl bg-blue-600 py-3.5 text-base font-bold text-white shadow-lg shadow-blue-500/30 active:scale-95 transition-all flex items-center">
                                <span id="mobileVerifySpinner" class="hidden mr-2 animate-spin"><i class="ri-loader-4-line"></i></span>
                                Xác nhận truy cập
                            </button>

                            <button type="button" onclick="closeMobileSecurityModal()"
                                    class="w-full justify-center rounded-xl bg-slate-100 py-3.5 text-base font-semibold text-slate-600 hover:bg-slate-200 active:scale-95 transition-all">
                                Hủy bỏ
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="~/js/site.js" asp-append-version="true"></script>

<script>
    // --- MOBILE SECURITY LOGIC ---

    function toggleMobilePassVisibility() {
        const input = document.getElementById('mobileSecurityPassword');
        const icon = document.getElementById('mobileEyeIcon');
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.replace('ri-eye-line', 'ri-eye-off-line');
        } else {
            input.type = 'password';
            icon.classList.replace('ri-eye-off-line', 'ri-eye-line');
        }
    }

    function closeMobileSecurityModal() {
        const modal = document.getElementById('mobileSecurityModal');
        const backdrop = document.getElementById('mobileSecurityBackdrop');
        const panel = document.getElementById('mobileSecurityPanel');

        backdrop.classList.remove('opacity-100');
        panel.classList.remove('opacity-100', 'scale-100');

        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    function openMobileSecurityModal() {
        const modal = document.getElementById('mobileSecurityModal');
        const backdrop = document.getElementById('mobileSecurityBackdrop');
        const panel = document.getElementById('mobileSecurityPanel');
        const input = document.getElementById('mobileSecurityPassword');
        const errMsg = document.getElementById('mobileVerifyErrorMsg');

        input.value = '';
        errMsg.classList.add('hidden');
        modal.classList.remove('hidden');

        // Animation
        setTimeout(() => {
            backdrop.classList.add('opacity-100');
            panel.classList.add('opacity-100', 'scale-100');
            input.focus();
        }, 10);
    }

    $(document).ready(function () {
        // 1. Bắt sự kiện click vào link Profile
        // Selector này tìm các thẻ a có href chứa "Profile" trong Layout Mobile
        const profileLinks = $('a[href*="/Common/Profile"]');

        if (profileLinks.length > 0) {
            profileLinks.on('click', function (e) {
                e.preventDefault();
                // Đóng menu người dùng nếu đang mở (để trải nghiệm mượt hơn)
                if (window.Alpine) {
                    // Tìm component Alpine đang mở userMenu và đóng nó (optional)
                    // document.dispatchEvent(new CustomEvent('close-user-menu'));
                }
                openMobileSecurityModal();
            });
        }

        // 2. Submit Form
        $('#mobileVerifyPassForm').on('submit', function (e) {
            e.preventDefault();

            const password = $('#mobileSecurityPassword').val();
            const btn = $('#btnMobileConfirm');
            const spinner = $('#mobileVerifySpinner');
            const errMsg = $('#mobileVerifyErrorMsg');

            btn.prop('disabled', true).addClass('opacity-75');
            spinner.removeClass('hidden');
            errMsg.addClass('hidden');

            $.ajax({
                url: '/Common/VerifyPassword',
                type: 'POST',
                data: { password: password },
                success: function (res) {
                    if (res.success) {
                        window.location.href = '/Common/Profile';
                    } else {
                        errMsg.text(res.message || "Mật khẩu không đúng").removeClass('hidden');
                        btn.prop('disabled', false).removeClass('opacity-75');
                        spinner.addClass('hidden');
                        // Rung nhẹ báo lỗi
                        $('#mobileSecurityPanel').addClass('animate-bounce');
                        setTimeout(() => $('#mobileSecurityPanel').removeClass('animate-bounce'), 500);
                    }
                },
                error: function () {
                    errMsg.text("Lỗi kết nối").removeClass('hidden');
                    btn.prop('disabled', false).removeClass('opacity-75');
                    spinner.addClass('hidden');
                }
            });
        });
    });
</script>

<!-- Enhanced JavaScript -->
<script>
    // Enhanced performance monitoring
    window.addEventListener('load', function () {
        console.log('🚀 SportVenue Mobile loaded successfully!');
        document.body.classList.add('loaded');
    });

    // Enhanced touch interactions
    document.addEventListener('DOMContentLoaded', function () {
        // Add touch feedback to all buttons
        const buttons = document.querySelectorAll('button, .btn-enhanced');
        buttons.forEach(button => {
            button.addEventListener('touchstart', function () {
                this.style.transform = 'scale(0.95)';
            }, { passive: true });

            button.addEventListener('touchend', function () {
                this.style.transform = '';
            }, { passive: true });
        });

        // Enhanced scroll behavior for bottom nav
        let lastScrollTop = 0;
        const bottomNav = document.querySelector('.mobile-nav:last-of-type');
        const quickAction = document.querySelector('.quick-action');

        window.addEventListener('scroll', function () {
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop;

            if (scrollTop > lastScrollTop && scrollTop > 100) {
                // Scrolling down - hide navigation
                bottomNav.style.transform = 'translateY(100%)';
                if (quickAction) quickAction.style.transform = 'scale(0)';
            } else {
                // Scrolling up - show navigation
                bottomNav.style.transform = 'translateY(0)';
                if (quickAction) quickAction.style.transform = 'scale(1)';
            }
            lastScrollTop = scrollTop;
        }, { passive: true });
    });
</script>

@RenderSection("Scripts", required: false)

// Function to update user info in header dynamically
<script>
    // Enhanced global function for header update from session
    window.refreshHeaderFromSession = function () {
        console.log('🔄 Refreshing header with session data...');

        fetch('/Common/GetUserHeaderInfo')
            .then(response => response.json())
            .then(data => {
                console.log('📊 Session data received:', data);

                // Update avatar images
                const avatarImages = document.querySelectorAll('img[alt="Avatar"]');
                avatarImages.forEach(img => {
                    if (img) {
                        const updatedAvatarUrl = data.avatarUrl + '?t=' + Date.now();
                        console.log(`Updating avatar: ${img.src} → ${updatedAvatarUrl}`);
                        img.src = updatedAvatarUrl;
                        img.onerror = function () {
                            this.src = '/images/default-avatar.png';
                        };
                    }
                });

                // Update full name
                const fullNameElements = document.querySelectorAll('.p-4 .font-semibold'); // Selector của FullName
                fullNameElements.forEach(element => {
                    if (element && data.fullName) {
                        console.log(`Updating full name: ${element.textContent} → ${data.fullName}`);
                        element.textContent = data.fullName;
                    }
                });

                // Update email
                const emailElements = document.querySelectorAll('.p-4 .text-sm');
                emailElements.forEach(element => {
                    if (element && data.email) {
                        console.log(`Updating email: ${element.textContent} → ${data.email}`);
                        element.textContent = data.email;
                    }
                });

                console.log('✅ Header refreshed successfully!');
            })
            .catch(error => {
                console.error('❌ Error refreshing header from session:', error);
            });
    };

    // Auto-initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 Mobile layout header refresh initialized');
        console.log('💡 Available functions: refreshHeaderFromSession()');

        // Test function for development
        if (window.location.hostname === 'localhost') {
            window.testSessionRefresh = function () {
                console.log('🧪 Testing session refresh...');
                return window.refreshHeaderFromSession();
            };
        }
    });
</script>

    <script>
        async function updateMobileNotificationBadges() {
            try {
                const resp = await fetch('/Notification/GetUnreadNotificationCount');
                if (resp.ok) {
                    const count = await resp.json();
                    // Bottom nav badge
                    const badgeBottom = document.getElementById('notification-badge-bottom');
                    if (badgeBottom) {
                        if (count > 0) {
                            badgeBottom.textContent = count;
                            badgeBottom.style.display = 'flex';
                        } else {
                            badgeBottom.style.display = 'none';
                        }
                    }
                }
            } catch (err) {
                // Nếu cần xử lý lỗi
                console.error('Error fetching notification count:', err);
            }
        }
        document.addEventListener('DOMContentLoaded', updateMobileNotificationBadges);
    </script>

    <script>
        window.currentUserId = @userId;
        console.log("🔑 UserId từ Session:", @userId);
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getDatabase, ref, get, set, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCg6rxISbUgZKNqqLlkBrYS_sQtkYRaByo",
            authDomain: "chatbox-993b2.firebaseapp.com",
            databaseURL: "https://chatbox-993b2-default-rtdb.firebaseio.com",
            projectId: "chatbox-993b2",
            storageBucket: "chatbox-993b2.appspot.com",
            messagingSenderId: "168483987205",
            appId: "1:168483987205:web:c9ef776901ec2882bb616c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        async function getUserRooms(userId) {
            const snapshot = await get(ref(db, "chats"));
            const rooms = [];

            if (snapshot.exists()) {
                snapshot.forEach(roomSnap => {
                    const roomId = roomSnap.key;
                    if (roomId.split("_").includes(String(userId))) {
                        rooms.push(roomId);
                    }
                });
            }

            return rooms;
        }

        function showNotification(msg) {
            if (Notification.permission === "granted") {
                new Notification(`${msg.senderName}`, { body: msg.message });
            }
        }

        // ✅ Tăng số tin chưa đọc trong Firebase
               import { runTransaction } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
        async function incrementUnread(userId) {
            const unreadRef = ref(db, `unreadMessages/${userId}`);
            await runTransaction(unreadRef, (current) => (current || 0) + 1);
        }

        async function listenForUserMessages(userId, badgeHandler) {
            const rooms = await getUserRooms(userId);

            // ✅ Lắng nghe thay đổi số tin chưa đọc từ Firebase
            const unreadRef = ref(db, `unreadMessages/${userId}`);
            onValue(unreadRef, (snapshot) => {
                const count = snapshot.exists() ? snapshot.val() : 0;
                badgeHandler(count);
            });

            // ✅ Lắng nghe tin mới
            const startTime = Date.now();

            rooms.forEach(roomId => {
                const roomRef = ref(db, `chats/${roomId}`);

                onChildAdded(roomRef, (snapshot) => {
                    const msg = snapshot.val();

                    if (msg.timestamp > startTime && msg.senderId != userId) {

                        showNotification(msg);
                    }
                });
            });
        }

        const currentUserId = window.currentUserId;

        if (currentUserId) {
            window.listenForUserMessages = (badgeHandler) => {
                return listenForUserMessages(currentUserId, badgeHandler);
            };

            // ✅ Reset số tin chưa đọc về 0 khi mở chat
            window.resetUnreadMessages = async () => {
                const unreadRef = ref(db, `unreadMessages/${currentUserId}`);
                await set(unreadRef, 0);
            };
        }
    </script>

    <script>
              function chatBadge() {
            return {
                unreadCount: 0,
                async openChat() {
                    if (typeof window.resetUnreadMessages === "function") {
                        await window.resetUnreadMessages();
                    }
                    this.unreadCount = 0;
                    setTimeout(() => {
                        window.location.href = '@Url.Action("Chat", "Chat")';
                    }, 150);
                },
                setBadge(count) {
                    this.unreadCount = count;
                },
                init() {
                    setTimeout(() => {
                        if (typeof window.listenForUserMessages === "function") {
                            window.listenForUserMessages((count) => {
                                this.setBadge(count);
                            });
                        }
                    }, 500);
                }
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        $(document).ready(function () {

        // --- BẮT ĐẦU PHẦN CẬP NHẬT THEO CHIẾN LƯỢC MỚI ---

        function updateNotificationBadge() {
            console.log("[AJAX] 🟡 Bước 2: Bắt đầu gọi AJAX để lấy số thông báo (gọi action local)...");

            $.ajax({
                // === SỬA LỖI CORS ===
                // Gọi đến Action "GetUnreadNotificationCount" của "NotificationController"
                // ngay trên project UI này. Đây là đường dẫn tương đối.
                url: '/Notification/GetUnreadNotificationCount',
                type: 'GET',
                // KHÔNG cần "beforeSend" (Authorization) nữa,
                // vì "NotificationController" bên C# sẽ tự lấy token từ session/cookie.
                success: function (count) {
                    console.log(`[AJAX] ✅ Thành công! Server trả về số thông báo chưa đọc là: ${count}`);

                    const badge = $('#notification-badge');

                    if (badge.length) {
                        if (count > 0) {
                            badge.text(count);
                            badge.show();
                            console.log("[UI] 🟢 Đã cập nhật huy hiệu với số " + count);
                        } else {
                            badge.hide();
                            console.log("[UI] ⚪️ Không có thông báo mới, đã ẩn huy hiệu.");
                        }
                    } else {
                        console.warn("[UI] ⚠️ Không tìm thấy phần tử #notification-badge trên trang.");
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    // Lỗi này giờ sẽ là lỗi 500 (lỗi server) hoặc 401 (chưa đăng nhập)
                    // chứ không còn là lỗi CORS (status 0) nữa.
                    console.error(`[AJAX] ❌ Lỗi AJAX: ${textStatus}`, errorThrown);
                    console.error(`  - Status: ${jqXHR.status}`);
                    console.error(`  - URL: ${this.url}`);
                }
            });
        }

        function connectToSignalR() {
            const userId = @(Context.Session.GetInt32("UserId") ?? 0);
            if (!userId) {
                console.log("Người dùng chưa đăng nhập, không kết nối SignalR.");
                return;
            }

            // URL này VẪN ĐÚNG (SignalR vẫn kết nối thẳng đến Hub 7072)
            const hubUrl = `https://localhost:7072/notificationHub?userId=${userId}`;
            const connection = new signalR.HubConnectionBuilder()
                .withUrl(hubUrl, {
                    // Vẫn cần AccessTokenFactory để xác thực kết nối SignalR
                    accessTokenFactory: () => {
                        return document.cookie.split('; ').find(row => row.startsWith('AccessToken='))?.split('=')[1];
                    }
                })
                .withAutomaticReconnect()
                .build();

            // Logic này của bạn đã đúng: SignalR nhận tín hiệu -> gọi AJAX
            connection.on("ReceiveNotification", function (notification) {
                console.log('%c[SignalR] 🔴 Bước 1: TÍN HIỆU "ReceiveNotification" ĐÃ ĐƯỢC NHẬN!', 'color: red; font-weight: bold;', notification);
                updateNotificationBadge(); // <-- Chính xác!
            });

            connection.start()
                .then(() => console.log(`[SignalR] ✅ Đã kết nối tới hub thông báo với UserId = ${userId}`))
                .catch(err => console.error("[SignalR] ❌ Lỗi khi kết nối (Có thể do thiếu AccessToken):", err));
        }

        console.log("Bắt đầu thực thi script layout...");
        connectToSignalR();
        console.log("Đang gọi updateNotificationBadge() lần đầu khi tải trang...");
        updateNotificationBadge();

            // --- KẾT THÚC PHẦN CẬP NHẬT ---
        });

    </script>
    <script src="https://translate.google.com/translate_a/element.js?cb=initGoogleTranslate"></script>
    <script>
        function initGoogleTranslate() {
          new google.translate.TranslateElement({
            pageLanguage: 'en',
            includedLanguages: 'en,vi,ja,ko,zh-CN,fr,de,it,es',
            autoDisplay: false,
            multilanguagePage: true
          }, 'google_translate_element');
          // Ẩn banner Google
          const handleGoogleUI = () => {
            document.querySelectorAll('.goog-te-banner-frame, .goog-te-banner').forEach(b => b.remove());
            document.body.style.top = '0px';
          };
          const observer = new MutationObserver(() => handleGoogleUI());
          observer.observe(document.body, { childList: true, subtree: true });
        }

        document.addEventListener('DOMContentLoaded', function () {
          const toggleBtn = document.getElementById("translate-toggle");
          const menu = document.getElementById("translate-menu");
          let translateLoaded = false;

          // Khi Google Translate đã sẵn sàng (check có select trong #google_translate_element)
          function waitForTranslateReady(cb) {
            if (document.querySelector("#google_translate_element select")) {
              translateLoaded = true;
              if (cb) cb();
            } else {
              setTimeout(() => waitForTranslateReady(cb), 100);
            }
          }
          waitForTranslateReady();

          toggleBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            menu.classList.toggle("hidden");
          });

          document.addEventListener("click", function (e) {
            if (!toggleBtn.contains(e.target) && !menu.contains(e.target)) {
              menu.classList.add("hidden");
            }
          });

          // Sự kiện chọn ngôn ngữ
          document.querySelectorAll("#translate-menu [data-lang]").forEach(btn => {
            btn.addEventListener("click", function () {
              function changeLang() {
                const lang = btn.getAttribute("data-lang");
                const select = document.querySelector("#google_translate_element select");
                if (select) {
                  select.value = lang;
                  select.dispatchEvent(new Event("change"));
                }
                menu.classList.add("hidden");
                setTimeout(() => {
                  document.querySelectorAll("[data-translate-placeholder]").forEach(el => {
                    el.setAttribute("placeholder", el.getAttribute("data-translate-" + lang) || el.placeholder);
                  });
                }, 500);
              }
              if (translateLoaded) {
                changeLang();
              } else {
                waitForTranslateReady(changeLang);
              }
            });
          });

          document.getElementById("reset-translate-btn").addEventListener("click", function () {
            document.cookie = 'googtrans=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;';
            if (window.localStorage) localStorage.removeItem('googtrans');
            window.location.reload();
          });
        });
    </script>
    <script type="module">
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
        const db = getDatabase();

        document.addEventListener("DOMContentLoaded", () => {
            const chatWithAdminBtn = document.getElementById("chat-with-admin-btn");
            if (chatWithAdminBtn) {
                chatWithAdminBtn.addEventListener("click", async function() {
                    const senderId = document.getElementById("senderId")?.value;
                    const senderName = "@fullName"; // hoặc lấy từ biến JS/session
                    const receiverId = "1";
                    const receiverName = "Admin";

                    if (!senderId || !senderName) {
                        alert("Bạn cần đăng nhập để chat với Admin.");
                        return;
                    }
                    if (senderId === receiverId) {
                        alert("Bạn không thể chat với chính mình!");
                        return;
                    }
                    await createChatRoomAndRedirect(senderId, senderName, receiverId, receiverName);
                });
            }
        });

        async function createChatRoomAndRedirect(senderId, senderName, receiverId, receiverName) {
            const timestamp = Date.now();
            const updates = {};
            updates[`userChats/${senderId}/${receiverId}`] = {
                name: receiverName,
                timestamp,
                lastMessage: ""
            };
            updates[`userChats/${receiverId}/${senderId}`] = {
                name: senderName,
                timestamp,
                lastMessage: ""
            };
            try {
                await Promise.all(
                    Object.keys(updates).map(path => set(ref(db, path), updates[path]))
                );
            } catch (e) {}
            redirectToChat(senderId, senderName, receiverId, receiverName);
        }

        function redirectToChat(senderId, senderName, receiverId, receiverName) {
            const params = new URLSearchParams({
                senderId,
                senderName,
                receiverId,
                receiverName
            });
            window.location.href = `/Chat/Chat?${params.toString()}`;
        }
    </script>
    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import {
          getDatabase,
          ref,
          get,
          set,
          update,
          onValue,
          onChildAdded,
          off,
          push,
          onDisconnect,
          runTransaction
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCg6rxISbUgZKNqqLlkBrYS_sQtkYRaByo",
          authDomain: "chatbox-993b2.firebaseapp.com",
          databaseURL: "https://chatbox-993b2-default-rtdb.firebaseio.com",
          projectId: "chatbox-993b2",
          storageBucket: "chatbox-993b2.appspot.com",
          messagingSenderId: "168483987205",
          appId: "1:168483987205:web:c9ef776901ec2882bb616c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Request Notification permission
        if (Notification.permission !== "granted") {
          Notification.requestPermission().catch(() => {});
        }

        // ---------------- PRESENCE ----------------
        // SERVER timestamp helper
        const SERVER_TIMESTAMP = { '.sv': 'timestamp' };

        // Heartbeat and threshold (tùy chỉnh nếu cần)
        const HEARTBEAT_INTERVAL_MS = 25_000; // gửi heartbeat mỗi 25s
        const OFFLINE_THRESHOLD_MS = 60_000;  // nếu lastSeen > 60s trước -> coi là offline

        // Mark this client online for the given userId (per-tab).
        // Registers onDisconnect handlers so server sets connection child removed when connection lost.
        // Returns a cleanup function to call on page unload if desired.
        export function initPresenceFor(userId) {
          if (!userId) return;
          try {
            const connectedRef = ref(db, '.info/connected');
            const statusRef = ref(db, `userStatus/${userId}`);
            const connectionsRef = ref(db, `userStatus/${userId}/connections`);

            let heartbeatTimer = null;
            let currentConnRef = null;

            // Listen connected
            const connectedListener = onValue(connectedRef, async (snap) => {
              const connected = !!snap.val();
              if (!connected) return;

              try {
                // create a connection child for this tab
                const newConnRef = push(connectionsRef);
                currentConnRef = newConnRef;

                // Register onDisconnect for the connection child: remove only this child
                try {
                         // đăng ký onDisconnect để remove connection child và đặt trạng thái offline
        onDisconnect(newConnRef).remove().catch(e => console.warn('onDisconnect remove child failed', e));
        onDisconnect(statusRef).set({ online: false, lastSeen: SERVER_TIMESTAMP }).catch(e => console.warn('onDisconnect set root failed', e));
                } catch (e) {
                  console.warn('onDisconnect registration failed', e);
                }

                // Write child and set root online + lastSeen
                await set(newConnRef, true).catch(e => console.warn('set connection child failed', e));
                // Use update to avoid accidentally deleting other fields if extant
                await set(statusRef, { online: true, lastSeen: SERVER_TIMESTAMP }).catch(e => console.warn('set status root failed', e));

                // Start heartbeat to keep lastSeen fresh (so quick reloads/navigation keeps user treated as online)
                try {
                  if (heartbeatTimer) clearInterval(heartbeatTimer);
                  heartbeatTimer = setInterval(() => {
                    // Update lastSeen and online flag
                    set(statusRef, { online: true, lastSeen: SERVER_TIMESTAMP }).catch(e => console.warn('heartbeat failed', e));
                  }, HEARTBEAT_INTERVAL_MS);
                } catch (e) {
                  console.warn('heartbeat setup failed', e);
                }

              } catch (err) {
                console.error('initPresenceFor error', err);
              }
            }, (err) => {
              console.error('.info/connected listener error', err);
            });

            // return cleanup function if needed
            return () => {
              try {
                if (heartbeatTimer) clearInterval(heartbeatTimer);
                if (currentConnRef) {
                  // best-effort: remove our connection child and update lastSeen before unload
                  try { set(currentConnRef, null).catch(() => {}); } catch (e) {}
                  try { set(statusRef, { online: true, lastSeen: Date.now() }).catch(() => {}); } catch (e) {}
                }
              } catch (e) {}
              try { off(connectedRef); } catch (e) {}
            };
          } catch (ex) {
            console.error('initPresenceFor exception', ex);
          }
        }

        // One-time check whether a userId is online
        // Uses lastSeen TTL rather than trusting `online` boolean alone.
        export async function checkUserOnline(userId) {
          try {
            if (!userId) return false;
            const snap = await get(ref(db, `userStatus/${userId}`));
            if (!snap || !snap.exists()) return false;
            const val = snap.val();
            const lastSeen = val && val.lastSeen ? Number(val.lastSeen) : 0;
            const now = Date.now();
            return (now - lastSeen) <= OFFLINE_THRESHOLD_MS;
          } catch (err) {
            console.error('checkUserOnline error', err);
            return false;
          }
        }

        // Subscribe to realtime status changes for a userId
        // onChange(isOnline:boolean, rawVal:object)
        export function subscribeUserStatus(userId, onChange) {
          if (!userId || typeof onChange !== 'function') return () => {};
          const statusRef = ref(db, `userStatus/${userId}`);

          const listener = (snap) => {
            const v = snap.val();
            try {
              const lastSeen = v && v.lastSeen ? Number(v.lastSeen) : 0;
              const now = Date.now();
              const isOnline = (now - lastSeen) <= OFFLINE_THRESHOLD_MS;
              onChange(isOnline, v);
            } catch (e) {
              console.error('subscribeUserStatus onChange handler error', e);
            }
          };

          onValue(statusRef, listener, (err) => {
            console.error('subscribeUserStatus error', err);
          });

          return () => {
            try { off(statusRef); } catch (e) {}
          };
        }

        // ---------------- MESSAGES / NOTIFICATIONS ----------------

        async function getUserRooms(userId) {
          const snapshot = await get(ref(db, "chats"));
          const rooms = [];
          if (snapshot && snapshot.exists()) {
            snapshot.forEach(roomSnap => {
              const roomId = roomSnap.key;
              if (roomId && roomId.split("_").includes(String(userId))) {
                rooms.push(roomId);
              }
            });
          }
          return rooms;
        }

        function showNotification(msg) {
          if (Notification.permission === "granted") {
            try {
              new Notification(`${msg.senderName}`, { body: msg.message });
            } catch (e) {
              console.warn('Notification creation failed', e);
            }
          }
        }

        export async function incrementUnread(userId) {
          const unreadRef = ref(db, `unreadMessages/${userId}`);
          await runTransaction(unreadRef, (current) => (current || 0) + 1);
        }

        export async function listenForUserMessages(userId, badgeHandler) {
          if (!userId) return;
          const rooms = await getUserRooms(userId);

          // unread count listener
          const unreadRef = ref(db, `unreadMessages/${userId}`);
          onValue(unreadRef, (snapshot) => {
            const count = snapshot.exists() ? snapshot.val() : 0;
            try { badgeHandler(count); } catch (e) { console.error('badgeHandler error', e); }
          });

          // Listen for new messages
          const startTime = Date.now();
          rooms.forEach(roomId => {
            const roomRef = ref(db, `chats/${roomId}`);
            onChildAdded(roomRef, (snapshot) => {
              const msg = snapshot.val();
              if (msg && msg.timestamp > startTime && String(msg.senderId) !== String(userId)) {
                showNotification(msg);
              }
            });
          });
        }

        // ---------------- EXPOSE GLOBAL HELPERS ----------------
        window._chatPresence = {
          initPresenceFor,
          checkUserOnline,
          subscribeUserStatus,
          listenForUserMessages,
          incrementUnread
        };

        // ---------------- AUTO-INIT PRESENCE FOR LAYOUT USER ----------------
        try {
          const layoutUserId = (typeof window.currentUserId !== 'undefined' && window.currentUserId != null)
            ? String(window.currentUserId)
            : null;

          if (layoutUserId) {
            console.log('[PRESENCE] auto init for user:', layoutUserId);
            initPresenceFor(layoutUserId);
          } else {
            console.log('[PRESENCE] no currentUserId, presence not initialized');
          }
        } catch (e) {
          console.warn('[PRESENCE] auto init error', e);
        }
    </script>
</body>
</html>