<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="~/css/Booking/BookingSchedule.css">
</head>

<body>
<div class="container">
    <h1>Lịch Đặt Sân Của Bạn</h1>

    <div class="filters">
        <div class="filter-group">
            <label for="year"><i class="fas fa-calendar-alt"></i> Năm:</label>
            <select id="year" class="select-control">
                <!-- Populated by JavaScript -->
            </select>
        </div>
        <div class="filter-group">
            <label for="week"><i class="fas fa-calendar-week"></i> Tuần:</label>
            <select id="week" class="select-control" autocomplete="off">
                <!-- Populated by JavaScript -->
            </select>
        </div>
    </div>

    <div class="table-container">
        <table id="booking-table" class="booking-table">
            <thead>
            <tr>
                <th class="day-header" data-day="1">THỨ 2<div class="date-display"></div></th>
                <th class="day-header" data-day="2">THỨ 3<div class="date-display"></div></th>
                <th class="day-header" data-day="3">THỨ 4<div class="date-display"></div></th>
                <th class="day-header" data-day="4">THỨ 5<div class="date-display"></div></th>
                <th class="day-header" data-day="5">THỨ 6<div class="date-display"></div></th>
                <th class="day-header" data-day="6">THỨ 7<div class="date-display"></div></th>
                <th class="day-header" data-day="0">CHỦ NHẬT<div class="date-display"></div></th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td id="day-1" class="day-cell" data-day="1"></td>
                <td id="day-2" class="day-cell" data-day="2"></td>
                <td id="day-3" class="day-cell" data-day="3"></td>
                <td id="day-4" class="day-cell" data-day="4"></td>
                <td id="day-5" class="day-cell" data-day="5"></td>
                <td id="day-6" class="day-cell" data-day="6"></td>
                <td id="day-0" class="day-cell" data-day="0"></td>
            </tr>
            </tbody>
        </table>

        <div id="no-data-message" class="no-data-message">
            <i class="fas fa-exclamation-circle"></i> Không có sân nào đã đặt trong tuần này
        </div>
    </div>
</div>

<script>
    // Function to show a loading overlay
    function showLoader() {
        $('body').append('<div id="loader-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;"><div class="loader" style="border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite;"></div></div>');
    }

    // Function to hide the loading overlay
    function hideLoader() {
        $('#loader-overlay').remove();
    }

    async function goToCheckout(data) {
        const form = document.createElement('form');
        form.method = 'POST';

        if (data.Type === 'month') {
            showLoader();
            try {
                const fullData = await $.ajax({
                    url: '@Url.Action("GetMonthlyBookingForCheckout", "Booking")',
                    type: 'GET',
                    data: { monthlyBookingId: data.MonthlyBookingId }
                });

                form.action = '@Url.Action("MonthlyCheckout", "Booking")';
                for (const key in fullData) {
                    if (fullData.hasOwnProperty(key)) {
                        const hiddenField = document.createElement('input');
                        hiddenField.type = 'hidden';
                        hiddenField.name = key;
                        hiddenField.value = fullData[key];
                        form.appendChild(hiddenField);
                    }
                }

                if (data.CourtNames) {
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.name = 'CourtNames';
                    hiddenField.value = data.CourtNames;
                    form.appendChild(hiddenField);
                }

            } catch (error) {
                console.error("Lỗi khi lấy chi tiết gói đặt tháng:", error);
                alert('Không thể lấy chi tiết gói đặt sân. Vui lòng thử lại.');
                hideLoader();
                return;
            }

        } else {
            form.action = '@Url.Action("Checkout", "Booking")';
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.name = key;
                    hiddenField.value = data[key];
                    form.appendChild(hiddenField);
                }
            }
        }

        document.body.appendChild(form);
        form.submit();
    }

    $(document).ready(function () {
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const stadiumCache = {};

        // --- NEW: Hàm cập nhật URL ---
        function updateUrlState(year, weekIndex) {
            const url = new URL(window.location);
            url.searchParams.set('year', year);
            url.searchParams.set('week', weekIndex);
            // Dùng pushState để đổi URL mà không reload trang
            window.history.pushState({}, '', url);
        }

        function populateYears() {
            const $yearSelect = $('#year');
            for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                const $option = $('<option>', {
                    value: year,
                    text: year,
                    selected: false // Sẽ set selected ở hàm initializePage
                });
                $yearSelect.append($option);
            }
        }

        function getWeeksInYear(year) {
            const weeks = [];
            const firstDayOfYear = new Date(year, 0, 1);
            let firstMonday = new Date(firstDayOfYear);
            const dayOfWeek = firstMonday.getDay() || 7;

            if (dayOfWeek !== 1) {
                firstMonday.setDate(firstMonday.getDate() + (8 - dayOfWeek) % 7);
            }

            let currentMonday = new Date(firstMonday);
            let weekNum = 1;

            while (currentMonday.getFullYear() === year ||
            (currentMonday.getFullYear() === year + 1 && currentMonday.getMonth() === 0 && currentMonday.getDate() <= 7)) {

                const endOfWeek = new Date(currentMonday);
                endOfWeek.setDate(currentMonday.getDate() + 6);

                const startStr = formatDate(currentMonday);
                const endStr = formatDate(endOfWeek);

                weeks.push({
                    weekNum: weekNum,
                    startDate: new Date(currentMonday),
                    endDate: new Date(endOfWeek),
                    label: `${startStr} đến ${endStr}`
                });

                currentMonday.setDate(currentMonday.getDate() + 7);
                weekNum++;
            }

            return weeks;
        }

        function formatDate(date) {
            return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`;
        }

        function formatTime(timeString) {
            const date = new Date(timeString);
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function populateWeeks(year) {
            const weeks = getWeeksInYear(year);
            const $weekSelect = $('#week');
            $weekSelect.empty();

            weeks.forEach((week, index) => {
                const $option = $('<option>', {
                    value: index,
                    text: `Tuần ${week.weekNum}: ${week.label}`,
                    'data-start': week.startDate.toISOString(),
                    'data-end': week.endDate.toISOString()
                });
                $weekSelect.append($option);
            });
            // Logic chọn tuần mặc định sẽ chuyển vào initializePage
        }

        function findCurrentWeekIndex(weeks) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < weeks.length; i++) {
                const weekStart = new Date(weeks[i].startDate);
                const weekEnd = new Date(weeks[i].endDate);
                weekStart.setHours(0, 0, 0, 0);
                weekEnd.setHours(23, 59, 59, 999);

                if (today >= weekStart && today <= weekEnd) {
                    return i;
                }
            }
            return -1;
        }

        async function fetchJoinedBookings(startDate, endDate) {
            try {
                const response = await $.ajax({
                    url: '@Url.Action("GetJoinedBookingIds", "FindTeam")',
                    type: 'GET',
                    data: {
                        startDate: startDate.toISOString(),
                        endDate: endDate.toISOString()
                    }
                });
                return response || [];
            } catch (error) {
                console.error("❌ Lỗi khi gọi API joined bookings:", error);
                return [];
            }
        }

        async function fetchAndDisplayBookings(startDate, endDate) {
            console.log(`Đang tải dữ liệu...`);
            $('#no-data-message').hide();
            $('.day-cell').html('<div class="loader"></div>');

            try {
                const [personalBookings, teamResponse] = await Promise.all([
                    $.ajax({
                        url: '@Url.Action("GetBookingsForWeek", "Booking")',
                        type: 'GET',
                        data: { startDate: startDate.toISOString(), endDate: endDate.toISOString() }
                    }),
                    fetchJoinedBookings(startDate, endDate)
                ]);

                const mergedMap = new Map();

                (personalBookings || []).forEach(b => {
                    mergedMap.set(b.id, { ...b, postId: null });
                });

                (teamResponse || []).forEach(item => {
                    const b = item.bookingData; 
                    const pId = item.postId;
                    const bookingWithPostId = { ...b, postId: pId };
                    mergedMap.set(b.id, bookingWithPostId);
                });

                const allBookings = Array.from(mergedMap.values());

                if (allBookings.length === 0) {
                    displayBookingsOnTable([]);
                    return;
                }

                const uniqueStadiumIds = [...new Set(allBookings.map(b => b.stadiumId))];
                const stadiumPromises = uniqueStadiumIds.map(id => getStadiumById(id));
                await Promise.all(stadiumPromises);

                displayBookingsOnTable(allBookings);

            } catch (error) {
                console.error("Lỗi tải dữ liệu:", error);
                clearTable();
                $('#no-data-message').show();
            }
        }

        async function getStadiumById(stadiumId) {
            if (stadiumCache[stadiumId]) {
                return stadiumCache[stadiumId];
            }

            const searchTerm = `&$filter=Id eq ${stadiumId}`;
            try {
                const data = await $.ajax({
                    url: `/Home/Stadiums`,
                    type: 'GET',
                    data: { searchTerm: searchTerm }
                });

                if (data.value && data.value.length > 0) {
                    const stadium = data.value[0];
                    stadiumCache[stadiumId] = stadium;
                    return stadium;
                } else {
                    stadiumCache[stadiumId] = null;
                    return null;
                }
            } catch (error) {
                console.error(`Lỗi khi tải dữ liệu cho sân vận động ID: ${stadiumId}:`, error);
                stadiumCache[stadiumId] = null;
                return null;
            }
        }

        function getCourtName(stadium, courtId) {
            if (!stadium || !stadium.Courts) {
                return `Court ${courtId}`;
            }
            const court = stadium.Courts.find(c => c.Id === courtId);
            return court ? court.Name : `Court ${courtId}`;
        }

        function clearTable() {
            $('.day-cell').empty();
        }

        function equalizeBookingItemHeights() {
            const bookingItems = document.querySelectorAll('.booking-item');
            if (bookingItems.length === 0) return;
            bookingItems.forEach(item => item.style.height = 'auto');
            setTimeout(() => {
                let maxHeight = 0;
                bookingItems.forEach(item => {
                    if (item.offsetHeight > maxHeight) maxHeight = item.offsetHeight;
                });
                if (maxHeight > 0) {
                    bookingItems.forEach(item => item.style.height = `${maxHeight}px`);
                }
            }, 50);
        }

        function displayBookingsOnTable(bookings) {
            clearTable();
            $('#no-data-message').hide();
            if (!bookings || bookings.length === 0) {
                $('#no-data-message').show();
                return;
            }

            const bookingsByDate = {};
            bookings.forEach(booking => {
                const bookingDate = new Date(booking.date);
                const dayOfWeek = bookingDate.getDay();
                if (!bookingsByDate[dayOfWeek]) bookingsByDate[dayOfWeek] = {};

                booking.bookingDetails.forEach(detail => {
                    const timeKey = `${detail.startTime}-${detail.endTime}`;
                    if (!bookingsByDate[dayOfWeek][timeKey]) {
                        bookingsByDate[dayOfWeek][timeKey] = {
                            bookingData: booking, 
                            startTime: detail.startTime,
                            endTime: detail.endTime,
                            courtsForDisplay: []
                        };
                    }
                    bookingsByDate[dayOfWeek][timeKey].courtsForDisplay.push(detail.courtId);
                });
            });

            Object.keys(bookingsByDate).forEach(dayOfWeek => {
                const dayBookings = bookingsByDate[dayOfWeek];
                const $dayCell = $(`#day-${dayOfWeek}`);
                const timeSlots = Object.values(dayBookings).sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

                timeSlots.forEach(timeSlot => {
                    const bData = timeSlot.bookingData;
                    const stadium = stadiumCache[bData.stadiumId];
                    const stadiumName = stadium ? stadium.Name : `Sân ${bData.stadiumId}`;

                    const sortedCourts = timeSlot.courtsForDisplay.sort((a, b) => a - b);
                    let courtChips = '';
                    if (sortedCourts.length <= 2) {
                        courtChips = sortedCourts.map(cid => `<span class="court-chip">${getCourtName(stadium, cid)}</span>`).join('');
                    } else {
                        courtChips = `<span class="court-chip">${getCourtName(stadium, sortedCourts[0])}</span><span class="court-chip more-courts-chip">+${sortedCourts.length - 1} sân khác</span>`;
                    }

                    const startTimeFormatted = formatTime(timeSlot.startTime);
                    const endTimeFormatted = formatTime(timeSlot.endTime);

                    let buttonHtml = '';

                    if (bData.postId) {
                        const teamUrl = `@Url.Action("TeamManage", "TeamMember")?postId=${bData.postId}`;
                        buttonHtml = `
                        <a href="${teamUrl}" class="detail-btn" style="text-decoration: none; display: inline-block; text-align: center;">
                            <i class="fas fa-users"></i> Xem Team
                        </a>
                    `;
                    } else {
                        const bookingType = bData.monthlyBookingId ? 'month' : 'day';
                        let checkoutData = {};

                        if (bookingType === 'day') {
                            const courtsForCheckout = bData.bookingDetails.map(detail => ({
                                courtId: detail.courtId,
                                times: [`${formatTime(detail.startTime)}-${formatTime(detail.endTime)}`]
                            }));
                            checkoutData = {
                                BookingId: bData.id,
                                Type: bookingType,
                                StadiumId: bData.stadiumId,
                                Date: new Date(bData.date).toISOString().split('T')[0],
                                TotalPrice: bData.originalPrice,
                                Courts: JSON.stringify(courtsForCheckout),
                                AfterPrice: bData.totalPrice,
                                DiscountId: bData.discountId
                            };
                        } else {
                            const courtNamesList = sortedCourts.map(courtId => getCourtName(stadium, courtId));
                            checkoutData = {
                                MonthlyBookingId: bData.monthlyBookingId,
                                Type: bookingType,
                                CourtNames: courtNamesList.join(', ')
                            };
                        }

                        const checkoutDataString = JSON.stringify(checkoutData);
                        buttonHtml = `
                        <button class="detail-btn checkout-btn" data-checkout='${checkoutDataString}'>
                            <i class="fas fa-shopping-cart"></i> Chi tiết
                        </button>
                    `;
                    }

                    const $bookingItem = $(`
                    <div class="booking-item ${bData.status}" data-booking-id="${bData.id}">
                        <div class="stadium-name">${stadiumName}</div>
                        <div class="booking-content-top">
                            <div class="booking-time">${startTimeFormatted} - ${endTimeFormatted}</div>
                            <div class="courts-container">${courtChips}</div>
                        </div>
                        <div class="detail-container">
                            ${buttonHtml}
                        </div>
                    </div>
                `);
                    $dayCell.append($bookingItem);
                });
            });

            setTimeout(equalizeBookingItemHeights, 150);
        }

        function updateTableDates() {
            const selectedOption = $('#week option:selected');
            if (selectedOption.length === 0) return;
            const startDate = new Date(selectedOption.data('start'));
            const endDate = new Date(selectedOption.data('end'));
            $('.day-header').each(function () {
                const dayIndex = parseInt($(this).data('day'));
                const date = new Date(startDate);
                date.setDate(date.getDate() + (dayIndex === 0 ? 6 : dayIndex - 1));
                $(this).find('.date-display').text(formatDate(date));
            });
            fetchAndDisplayBookings(startDate, endDate);
        }

        // --- UPDATED: Hàm khởi tạo trang có đọc URL param ---
        async function initializePage() {
            populateYears();
            
            // 1. Đọc Param từ URL
            const urlParams = new URLSearchParams(window.location.search);
            const urlYear = parseInt(urlParams.get('year'));
            const urlWeek = parseInt(urlParams.get('week'));

            // 2. Set Year
            if (!isNaN(urlYear) && $(`#year option[value="${urlYear}"]`).length > 0) {
                $('#year').val(urlYear);
            } else {
                $('#year').val(currentYear);
            }

            // 3. Populate Week theo Year đã chọn
            populateWeeks(parseInt($('#year').val()));

            // 4. Set Week (nếu có trong URL) hoặc Default (Hiện tại)
            if (!isNaN(urlWeek) && $(`#week option[value="${urlWeek}"]`).length > 0) {
                $('#week').val(urlWeek);
            } else {
                // Nếu không có URL param thì mới tìm tuần hiện tại
                if (parseInt($('#year').val()) === currentYear) {
                    const weeks = getWeeksInYear(currentYear);
                    const currentWeekIndex = findCurrentWeekIndex(weeks);
                    if (currentWeekIndex >= 0) {
                        $('#week').val(currentWeekIndex);
                    }
                }
            }

            // Trigger load dữ liệu
            setTimeout(function () {
                // Chỉ trigger để gọi hàm load data, không update URL nữa (tránh ghi đè nếu vừa back lại)
                updateTableDates(); 
            }, 0);
        }

        // --- UPDATED: Sự kiện change có update URL ---
        $('#year').on('change', function () {
            const selectedYear = parseInt($(this).val());
            populateWeeks(selectedYear);
            $('#week').val(0); // Reset về tuần đầu
            
            // Update URL
            updateUrlState(selectedYear, 0);
            
            updateTableDates();
        });

        $('#week').on('change', function () {
            const selectedYear = parseInt($('#year').val());
            const selectedWeek = parseInt($(this).val());
            
            // Update URL
            updateUrlState(selectedYear, selectedWeek);
            
            updateTableDates();
        });

        $(document).on('click', '.checkout-btn', function () {
            const checkoutData = $(this).data('checkout');
            goToCheckout(checkoutData);
        });

        initializePage();
    });

    $(window).on('resize', () => setTimeout(equalizeBookingItemHeights, 300));
</script>
</body>
</html>