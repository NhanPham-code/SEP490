<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="~/css/Booking/BookingSchedule.css">
</head>

<body>
<div class="container">
    <h1>L·ªãch ƒê·∫∑t S√¢n C·ªßa B·∫°n</h1>

    <div class="filters">
        <div class="filter-group">
            <label for="year"><i class="fas fa-calendar-alt"></i> NƒÉm:</label>
            <select id="year" class="select-control">
                <!-- Populated by JavaScript -->
            </select>
        </div>
        <div class="filter-group">
            <label for="week"><i class="fas fa-calendar-week"></i> Tu·∫ßn:</label>
            <select id="week" class="select-control" autocomplete="off">
                <!-- Populated by JavaScript -->
            </select>
        </div>
    </div>

    <div class="table-container">
        <table id="booking-table" class="booking-table">
            <thead>
            <tr>
                <th class="day-header" data-day="1">TH·ª® 2<div class="date-display"></div>
                </th>
                <th class="day-header" data-day="2">TH·ª® 3<div class="date-display"></div>
                </th>
                <th class="day-header" data-day="3">TH·ª® 4<div class="date-display"></div>
                </th>
                <th class="day-header" data-day="4">TH·ª® 5<div class="date-display"></div>
                </th>
                <th class="day-header" data-day="5">TH·ª® 6<div class="date-display"></div>
                </th>
                <th class="day-header" data-day="6">TH·ª® 7<div class="date-display"></div>
                </th>
                <th class="day-header" data-day="0">CH·ª¶ NH·∫¨T<div class="date-display"></div>
                </th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td id="day-1" class="day-cell" data-day="1"></td>
                <td id="day-2" class="day-cell" data-day="2"></td>
                <td id="day-3" class="day-cell" data-day="3"></td>
                <td id="day-4" class="day-cell" data-day="4"></td>
                <td id="day-5" class="day-cell" data-day="5"></td>
                <td id="day-6" class="day-cell" data-day="6"></td>
                <td id="day-0" class="day-cell" data-day="0"></td>
            </tr>
            </tbody>
        </table>

        <div id="no-data-message" class="no-data-message">
            <i class="fas fa-exclamation-circle"></i> Kh√¥ng c√≥ s√¢n n√†o ƒë√£ ƒë·∫∑t trong tu·∫ßn n√†y
        </div>
    </div>
</div>

<script>
    // --- NEW ---
    // Function to show a loading overlay
    function showLoader() {
        $('body').append('<div id="loader-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;"><div class="loader" style="border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite;"></div></div>');
    }

    // Function to hide the loading overlay
    function hideLoader() {
        $('#loader-overlay').remove();
    }

    async function goToCheckout(data) {
        const form = document.createElement('form');
        form.method = 'POST';

        if (data.Type === 'month') {
            showLoader(); // Show loader before making the API call
            try {
                // Call the new controller action to get full monthly booking details
                const fullData = await $.ajax({
                    url: '@Url.Action("GetMonthlyBookingForCheckout", "Booking")',
                    type: 'GET',
                    data: { monthlyBookingId: data.MonthlyBookingId }
                });

                // Now use the complete data from the server to build the form
                form.action = '@Url.Action("MonthlyCheckout", "Booking")';
                for (const key in fullData) {
                    if (fullData.hasOwnProperty(key)) {
                        const hiddenField = document.createElement('input');
                        hiddenField.type = 'hidden';
                        hiddenField.name = key;
                        hiddenField.value = fullData[key];
                        form.appendChild(hiddenField);
                    }
                }

                if (data.CourtNames) {
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.name = 'CourtNames';
                    hiddenField.value = data.CourtNames;
                    form.appendChild(hiddenField);
                }

            } catch (error) {
                console.error("L·ªói khi l·∫•y chi ti·∫øt g√≥i ƒë·∫∑t th√°ng:", error);
                alert('Kh√¥ng th·ªÉ l·∫•y chi ti·∫øt g√≥i ƒë·∫∑t s√¢n. Vui l√≤ng th·ª≠ l·∫°i.');
                hideLoader();
                return; // Stop execution if API call fails
            }

        } else {
            // For daily bookings, the logic remains the same
            form.action = '@Url.Action("Checkout", "Booking")';
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.name = key;
                    hiddenField.value = data[key];
                    form.appendChild(hiddenField);
                }
            }
        }

        document.body.appendChild(form);
        form.submit(); // The page will navigate, so the loader will disappear automatically
    }


    $(document).ready(function () {
        // Initialize variables
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const stadiumCache = {}; // Cache ƒë·ªÉ l∆∞u d·ªØ li·ªáu s√¢n v·∫≠n ƒë·ªông

        function populateYears() {
            const $yearSelect = $('#year');
            for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                const $option = $('<option>', {
                    value: year,
                    text: year,
                    selected: year === currentYear
                });
                $yearSelect.append($option);
            }
        }

        function getWeeksInYear(year) {
            const weeks = [];
            const firstDayOfYear = new Date(year, 0, 1);
            let firstMonday = new Date(firstDayOfYear);
            const dayOfWeek = firstMonday.getDay() || 7;

            if (dayOfWeek !== 1) {
                firstMonday.setDate(firstMonday.getDate() + (8 - dayOfWeek) % 7);
            }

            let currentMonday = new Date(firstMonday);
            let weekNum = 1;

            while (currentMonday.getFullYear() === year ||
            (currentMonday.getFullYear() === year + 1 && currentMonday.getMonth() === 0 && currentMonday.getDate() <= 7)) {

                const endOfWeek = new Date(currentMonday);
                endOfWeek.setDate(currentMonday.getDate() + 6);

                const startStr = formatDate(currentMonday);
                const endStr = formatDate(endOfWeek);

                weeks.push({
                    weekNum: weekNum,
                    startDate: new Date(currentMonday),
                    endDate: new Date(endOfWeek),
                    label: `${startStr} ƒë·∫øn ${endStr}`
                });

                currentMonday.setDate(currentMonday.getDate() + 7);
                weekNum++;
            }

            return weeks;
        }

        function formatDate(date) {
            return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`;
        }

        function formatTime(timeString) {
            const date = new Date(timeString);
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function populateWeeks(year) {
            const weeks = getWeeksInYear(year);
            const $weekSelect = $('#week');
            $weekSelect.empty();

            weeks.forEach((week, index) => {
                const $option = $('<option>', {
                    value: index,
                    text: `Tu·∫ßn ${week.weekNum}: ${week.label}`,
                    'data-start': week.startDate.toISOString(),
                    'data-end': week.endDate.toISOString()
                });
                $weekSelect.append($option);
            });

            if (year === currentYear) {
                const currentWeekIndex = findCurrentWeekIndex(weeks);
                if (currentWeekIndex >= 0) {
                    $weekSelect.val(currentWeekIndex);
                }
            }
        }

        function findCurrentWeekIndex(weeks) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < weeks.length; i++) {
                const weekStart = new Date(weeks[i].startDate);
                const weekEnd = new Date(weeks[i].endDate);
                weekStart.setHours(0, 0, 0, 0);
                weekEnd.setHours(23, 59, 59, 999);

                if (today >= weekStart && today <= weekEnd) {
                    return i;
                }
            }
            return -1;
        }

        async function fetchAndDisplayBookings(startDate, endDate) {
            console.log(`ƒêang t·∫£i d·ªØ li·ªáu t·ª´ ${startDate} ƒë·∫øn ${endDate}`);
            $('#no-data-message').hide();
            $('.day-cell').html('<div class="loader"></div>');

            try {
                const bookings = await $.ajax({
                    url: '@Url.Action("GetBookingsForWeek", "Booking")',
                    type: 'GET',
                    data: {
                        startDate: startDate.toISOString(),
                        endDate: endDate.toISOString()
                    }
                });

                console.log("D·ªØ li·ªáu API GetBookingsForWeek tr·∫£ v·ªÅ:", bookings);

                if (!bookings || bookings.length === 0) {
                    displayBookingsOnTable([]);
                    return;
                }

                const uniqueStadiumIds = [...new Set(bookings.map(b => b.stadiumId))];
                const stadiumPromises = uniqueStadiumIds.map(id => getStadiumById(id));

                await Promise.all(stadiumPromises);
                displayBookingsOnTable(bookings);

            } catch (error) {
                console.error("L·ªói khi t·∫£i d·ªØ li·ªáu booking:", error);
                clearTable();
                $('#no-data-message').show();
            }
        }

        async function getStadiumById(stadiumId) {
            if (stadiumCache[stadiumId]) {
                return stadiumCache[stadiumId];
            }

            const searchTerm = `&$filter=Id eq ${stadiumId}`;
            try {
                const data = await $.ajax({
                    url: `/Home/Stadiums`,
                    type: 'GET',
                    data: { searchTerm: searchTerm }
                });

                if (data.value && data.value.length > 0) {
                    const stadium = data.value[0];

                    // Log ri√™ng t√™n s√¢n v·∫≠n ƒë·ªông l·ªõn
                    console.log(`üèüÔ∏è S√¢n l·ªõn (ID ${stadiumId}):`, stadium.Name);

                    // Log ri√™ng danh s√°ch s√¢n con (n∆°i ch·ª©a t√™n Court 1, Court 2...)
                    console.log(`üè∏ Danh s√°ch s√¢n con (Courts) c·ªßa ID ${stadiumId}:`, stadium.Courts);
                    
                    stadiumCache[stadiumId] = stadium;
                    return stadium;
                } else {
                    stadiumCache[stadiumId] = null;
                    return null;
                }
            } catch (error) {
                console.error(`L·ªói khi t·∫£i d·ªØ li·ªáu cho s√¢n v·∫≠n ƒë·ªông ID: ${stadiumId}:`, error);
                stadiumCache[stadiumId] = null;
                return null;
            }
        }

        function getCourtName(stadium, courtId) {
            if (!stadium || !stadium.Courts) {
                return `Court ${courtId}`;
            }
            const court = stadium.Courts.find(c => c.Id === courtId);
            return court ? court.Name : `Court ${courtId}`;
        }

        function clearTable() {
            $('.day-cell').empty();
        }

        function equalizeBookingItemHeights() {
            const bookingItems = document.querySelectorAll('.booking-item');
            if (bookingItems.length === 0) return;

            bookingItems.forEach(item => item.style.height = 'auto');

            setTimeout(() => {
                let maxHeight = 0;
                bookingItems.forEach(item => {
                    if (item.offsetHeight > maxHeight) maxHeight = item.offsetHeight;
                });
                if (maxHeight > 0) {
                    bookingItems.forEach(item => item.style.height = `${maxHeight}px`);
                }
            }, 50);
        }

        function displayBookingsOnTable(bookings) {
            clearTable();

            if (!bookings || bookings.length === 0) {
                $('#no-data-message').show();
                return;
            }

            $('#no-data-message').hide();

            const bookingsByDate = {};
            bookings.forEach(booking => {
                const bookingDate = new Date(booking.date);
                const dayOfWeek = bookingDate.getDay();
                if (!bookingsByDate[dayOfWeek]) bookingsByDate[dayOfWeek] = {};

                booking.bookingDetails.forEach(detail => {
                    const timeKey = `${detail.startTime}-${detail.endTime}`;
                    if (!bookingsByDate[dayOfWeek][timeKey]) {
                        bookingsByDate[dayOfWeek][timeKey] = {
                            bookingData: booking,
                            startTime: detail.startTime,
                            endTime: detail.endTime,
                            courtsForDisplay: []
                        };
                    }
                    bookingsByDate[dayOfWeek][timeKey].courtsForDisplay.push(detail.courtId);
                });
            });

            Object.keys(bookingsByDate).forEach(dayOfWeek => {
                const dayBookings = bookingsByDate[dayOfWeek];
                const $dayCell = $(`#day-${dayOfWeek}`);

                const timeSlots = Object.values(dayBookings).sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

                timeSlots.forEach(timeSlot => {
                    const stadium = stadiumCache[timeSlot.bookingData.stadiumId];
                    const stadiumName = stadium ? stadium.Name : `S√¢n ${timeSlot.bookingData.stadiumId}`;

                    const sortedCourts = timeSlot.courtsForDisplay.sort((a, b) => a - b);
                    const totalCourts = sortedCourts.length;
                    let courtChips = '';

                    if (totalCourts <= 2) {
                        // If 2 or fewer courts, show all of them
                        courtChips = sortedCourts.map(courtId => {
                            const courtName = getCourtName(stadium, courtId);
                            return `<span class="court-chip">${courtName}</span>`;
                        }).join('');
                    } else {
                        // If more than 2 courts, show the first one + a "more" chip
                        const firstCourtName = getCourtName(stadium, sortedCourts[0]);
                        const remainingCount = totalCourts - 1;
                        courtChips = `
                                <span class="court-chip">${firstCourtName}</span>
                                <span class="court-chip more-courts-chip">+${remainingCount} s√¢n kh√°c</span>
                            `;
                    }

                    const startTimeFormatted = formatTime(timeSlot.startTime);
                    const endTimeFormatted = formatTime(timeSlot.endTime);

                    const courtNamesList = sortedCourts.map(courtId => getCourtName(stadium, courtId));

                    const bookingType = timeSlot.bookingData.monthlyBookingId ? 'month' : 'day';
                    let checkoutData;

                    if (bookingType === 'day') {
                        const courtsForCheckout = timeSlot.bookingData.bookingDetails.map(detail => ({
                            courtId: detail.courtId,
                            times: [`${formatTime(detail.startTime)}-${formatTime(detail.endTime)}`]
                        }));
                        checkoutData = {
                            BookingId: timeSlot.bookingData.id,
                            Type: bookingType,
                            StadiumId: timeSlot.bookingData.stadiumId,
                            Date: new Date(timeSlot.bookingData.date).toISOString().split('T')[0],
                            TotalPrice: timeSlot.bookingData.originalPrice,
                            Courts: JSON.stringify(courtsForCheckout),
                            AfterPrice: timeSlot.bookingData.totalPrice,
                            DiscountId: timeSlot.bookingData.discountId
                        };
                    } else { // bookingType === 'month'
                        // For monthly bookings, we only need the ID to fetch full details later
                        checkoutData = {
                            MonthlyBookingId: timeSlot.bookingData.monthlyBookingId,
                            Type: bookingType,
                            CourtNames: courtNamesList.join(', ') // N·ªëi t√™n s√¢n th√†nh chu·ªói
                        };
                    }

                    const checkoutDataString = JSON.stringify(checkoutData);

                    const $bookingItem = $(`
                            <div class="booking-item ${timeSlot.bookingData.status}" data-booking-id="${timeSlot.bookingData.id}">
                                <div class="stadium-name">${stadiumName}</div>
                                <div class="booking-content-top">
                                    <div class="booking-time">${startTimeFormatted} - ${endTimeFormatted}</div>
                                    <div class="courts-container">${courtChips}</div>
                                </div>
                                <div class="detail-container">
                                    <button class="detail-btn checkout-btn" data-checkout='${checkoutDataString}'>
                                        <i class="fas fa-shopping-cart"></i>
                                        Chi ti·∫øt
                                    </button>
                                </div>
                            </div>
                        `);
                    $dayCell.append($bookingItem);
                });
            });

            setTimeout(equalizeBookingItemHeights, 150);
        }

        function updateTableDates() {
            const selectedOption = $('#week option:selected');
            if (selectedOption.length === 0) return;
            const startDate = new Date(selectedOption.data('start'));
            const endDate = new Date(selectedOption.data('end'));
            $('.day-header').each(function () {
                const dayIndex = parseInt($(this).data('day'));
                const date = new Date(startDate);
                date.setDate(date.getDate() + (dayIndex === 0 ? 6 : dayIndex - 1));
                $(this).find('.date-display').text(formatDate(date));
            });
            fetchAndDisplayBookings(startDate, endDate);
        }

        function initializePage() {
            populateYears();
            populateWeeks(currentYear);
            // *** THAY ƒê·ªîI QUAN TR·ªåNG ·ªû ƒê√ÇY ***
            // K√≠ch ho·∫°t s·ª± ki·ªán change m·ªôt c√°ch t∆∞·ªùng minh sau khi ƒë√£ ch·∫Øc ch·∫Øn DOM ƒë∆∞·ª£c c·∫≠p nh·∫≠t
            setTimeout(function () {
                $('#week').trigger('change');
            }, 0);
        }

        $('#year').on('change', function () {
            populateWeeks(parseInt($(this).val()));
            // K√≠ch ho·∫°t s·ª± ki·ªán change cho dropdown tu·∫ßn ƒë·ªÉ t·∫£i l·∫°i d·ªØ li·ªáu
            setTimeout(function () {
                $('#week').trigger('change');
            }, 0);
        });

        $('#week').on('change', updateTableDates);

        $(document).on('click', '.checkout-btn', function () {
            const checkoutData = $(this).data('checkout');
            goToCheckout(checkoutData);
        });

        initializePage();
    });


    $(window).on('resize', () => setTimeout(equalizeBookingItemHeights, 300));
</script>
</body>

</html>