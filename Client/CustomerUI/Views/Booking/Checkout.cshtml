@using System.Text.Json
@using DTOs.BookingDTO
@{
    ViewBag.Title = "Thanh Toán";
}
@if (TempData["BookingSuccess"] != null && (bool)TempData["BookingSuccess"])
{
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        Swal.fire({
            icon: 'success',
            title: 'Thành công!',
            text: '@TempData["SuccessMessage"]',
            showConfirmButton: false,
            timer: 2500
        });
    </script>
}

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            transition: opacity 0.3s ease-in-out;
        }

        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }

        .modal-overlay.open {
            display: flex;
            opacity: 1;
        }
    </style>
</head>

<body class="min-h-screen p-4 flex items-center justify-center">

    <div id="discount-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center opacity-0">
        <div class="modal-content bg-white rounded-lg p-6 shadow-xl max-w-lg w-full mx-4">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Chọn Mã Giảm Giá</h3>
            <div id="discount-list" class="space-y-4 max-h-80 overflow-y-auto mb-4">
            </div>
            <div class="text-right">
                <button type="button" id="close-discount-modal"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2">
                    Đóng
                </button>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center opacity-0">
        <div class="modal-content bg-white rounded-lg p-6 shadow-xl max-w-sm w-full mx-4">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-2"></h3>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <div class="text-right">
                <button id="modal-close-btn"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">
                    Đóng
                </button>
            </div>
        </div>
    </div>

    <form id="booking-form" action="/Booking/CreateBooking" method="post">
        <input type="hidden" id="booking-date" name="Date" value="" />
        <input type="hidden" id="booking-start-time" name="StartTime" value="" />
        <input type="hidden" id="booking-end-time" name="EndTime" value="" />
        <input type="hidden" id="booking-original-price" name="OriginalPrice" value="" />
        <input type="hidden" id="booking-total-price" name="TotalPrice" value="" />
        <input type="hidden" id="booking-note" name="Note" value="" />
        <input type="hidden" id="booking-discount-id" name="DiscountId" value="" />
        <input type="hidden" id="payment-amount" name="PaymentAmount" value="" />
        <div id="court-ids-container"></div>
        <input type="hidden" id="payment-method-input" name="PaymentMethod" value="bank_transfer" />
        <input type="hidden" id="booking-stadium-id" name="StadiumId" value="" />

        <div id="checkout-container" class="bg-white rounded-2xl shadow-lg p-6 md:p-8 max-w-xl w-full mx-auto">
            <h1 class="text-3xl font-bold text-indigo-600 text-center mb-6">Thông Tin Đặt Sân</h1>

            <div class="p-6 bg-gray-50 rounded-xl shadow-inner mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Chi tiết hóa đơn</h2>
                <div class="space-y-3 text-gray-700">
                    <div class="flex justify-between">
                        <span>Sân vận động:</span>
                        <span id="checkout-stadium-name" class="font-bold"></span>
                    </div>
                    <table class="w-full text-sm text-gray-700 mb-4">
                        <thead>
                            <tr class="border-b font-semibold">
                                <th class="py-2 text-left">Sân</th>
                                <th class="py-2 text-center">Khung giờ</th>
                                <th class="py-2 text-right">Giá mỗi giờ</th>
                                <th class="py-2 text-right">Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody id="checkout-invoice-body">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>

                    <div class="flex justify-between border-t pt-3 mt-3 border-gray-200">
                        <span>Giá gốc:</span>
                        <span id="checkout-original-price"></span>
                    </div>
                    <div class="flex justify-between text-green-600 font-bold hidden" id="discount-amount-row">
                        <span>Giảm giá:</span>
                        <span id="checkout-discount-amount"></span>
                    </div>
                    <div class="flex justify-between font-bold text-lg border-t pt-3 mt-3 border-gray-200 text-gray-900">
                        <span>Tổng cộng:</span>
                        <span id="checkout-total-price" class="text-indigo-600"></span>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-gray-50 rounded-xl shadow-inner mb-6" id="profileForm">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Thông tin người đặt</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Họ và tên</label>
                        <input type="text" id="customerName" class="mt-1 w-full p-3 rounded-lg border border-gray-300"
                               disabled>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Số điện thoại</label>
                        <input type="text" id="customerPhone" value="@ViewBag.CustomerPhone"
                               class="mt-1 w-full p-3 rounded-lg border border-gray-300" disabled>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="customerEmail" class="mt-1 w-full p-3 rounded-lg border border-gray-300"
                               disabled>
                    </div>
                </div>
            </div>

            <div id="discount-section" class="p-6 bg-gray-50 rounded-xl shadow-inner mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Mã giảm giá</h2>

                <!-- Khi chưa chọn mã -->
                <div id="no-discount-selected" class="flex items-center justify-between">
                    <span class="text-gray-500 italic">Chưa có mã giảm giá nào được chọn</span>
                    <button type="button" id="select-discount-button"
                            class="px-5 py-3.5 rounded-lg font-semibold text-white bg-indigo-500 hover:bg-indigo-600 transition">
                        Chọn mã
                    </button>
                </div>

                <!-- Khi đã chọn mã (ẩn mặc định) -->
                <div id="discount-selected" class="hidden">
                    <div class="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div>
                                <p id="selected-code-name" class="font-bold text-green-700">MaGiamGia2</p>
                                <p id="selected-code-amount" class="text-sm text-green-600">Giảm 200. 000₫</p>
                            </div>
                        </div>
                        <button type="button" id="remove-discount-button"
                                class="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition"
                                title="Bỏ chọn mã">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <button type="button" id="change-discount-button"
                            class="mt-3 text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                        Đổi mã khác
                    </button>
                </div>
            </div>

            <div id="payment-section" class="p-6 bg-gray-50 rounded-xl shadow-inner mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Chọn phương thức thanh toán</h2>
                <div class="space-y-4">
                    <label class="flex items-center p-4 bg-white rounded-lg shadow-sm cursor-pointer border border-gray-200">
                        <input type="radio" name="payment-method" value="vnpay_100" class="form-radio text-indigo-600 h-5 w-5" checked>
                        <span class="ml-3 text-sm font-medium text-gray-700">Trả trước 100% qua VNPay</span>
                    </label>
                </div>
            </div>

            <div id="action-buttons-container" class="flex justify-between items-center gap-4 mt-8">
                <button type="button" id="back-button"
                        class="min-w-[150px] px-8 py-3 rounded-xl font-bold text-indigo-600 border border-indigo-600">
                    Quay lại
                </button>
                <button type="submit" id="complete-booking-button"
                        class="w-full px-12 py-3 rounded-xl font-bold text-white bg-indigo-600">
                    Hoàn tất đặt sân
                </button>
            </div>
        </div>
    </form>

    <script>
        const bookingData = {
            stadiumId: @ViewBag.StadiumId,
            date: "@ViewBag.Date",
            totalPrice: @ViewBag.TotalPrice,
            afterPrice: @((ViewBag.AfterPrice != null && ViewBag.AfterPrice > 0) ? ViewBag.AfterPrice : ViewBag.TotalPrice),
            discountId: @(ViewBag.DiscountId ?? "null"),
            type: "@ViewBag.Type",
            bookingId: @(ViewBag.BookingId ?? "null"),
            courts: @Html.Raw(ViewBag.Courts ?? "[]")
        };

        // *** FIX: Khởi tạo các biến state dựa trên bookingData ban đầu ***
        let subtotalPrice = bookingData.totalPrice;
        let totalPrice = bookingData.afterPrice;
        let discountAmount = subtotalPrice - totalPrice;
        let selectedDiscountId = bookingData.discountId;

        // Utility functions
        function showModal(title, message) { $('#modal-title').text(title); $('#modal-message').text(message); $('#custom-modal').removeClass('opacity-0').addClass('open').fadeIn(); }
        function hideModal() { $('#custom-modal').removeClass('open').addClass('opacity-0').fadeOut(); }
        function showDiscountModal() { $('#discount-modal').removeClass('opacity-0').addClass('open').fadeIn(); }
        function hideDiscountModal() { $('#discount-modal').removeClass('open').addClass('opacity-0').fadeOut(); }
        function formatCurrency(amount) { return `${amount.toLocaleString('vi-VN')}`; }

        function mergeTimeRanges(times) {
            if (!times || times.length === 0) return [];
            times.sort();
            const merged = [];
            let [currentStart, currentEnd] = times[0].split('-');
            for (let i = 1; i < times.length; i++) {
                const [nextStart, nextEnd] = times[i].split('-');
                if (nextStart === currentEnd) {
                    currentEnd = nextEnd;
                } else {
                    merged.push({ start: currentStart, end: currentEnd });
                    [currentStart, currentEnd] = [nextStart, nextEnd];
                }
            }
            merged.push({ start: currentStart, end: currentEnd });
            return merged;
        }

        // Data fetching functions
        function fetchStadiumData(id) {
            const searchTerm = `&$filter=Id eq ${id}`;
            $.ajax({
                url: `/Home/Stadiums`,
                type: 'GET',
                data: { searchTerm: searchTerm },
                success: function (data) {
                    if (data.value && data.value.length > 0) {
                        stadiumData = data.value[0];
                        updateInvoiceDetails();
                        if (selectedDiscountId) {
                            fetchAndDisplayAppliedDiscount(selectedDiscountId);
                        }
                    }
                },
                error: (jqXHR, textStatus, errorThrown) => console.error('Lỗi khi tải dữ liệu sân vận động:', textStatus, errorThrown)
            });
        }

        function fetchAndDisplayAppliedDiscount(discountId) {
            $.ajax({
                url: `/Booking/GetDiscountById?id=${discountId}`,
                type: 'GET',
                success: function (discount) {
                    if (discount) {
                        const currentDiscountAmount = subtotalPrice - totalPrice;
                        $('#selected-discount-code').text(`Mã: ${discount.code} (-${formatCurrency(currentDiscountAmount)})`);
                    }
                },
                error: function () {
                    const currentDiscountAmount = subtotalPrice - totalPrice;
                    $('#selected-discount-code').text(`Đã áp dụng mã giảm giá (-${formatCurrency(currentDiscountAmount)})`);
                }
            });
        }

        function loadUserProfile() {
            $.ajax({
                url: `/Booking/GetUserProfile`,
                type: 'GET',
                dataType: 'json',
                success: function (response) { if (response.success) { $('#customerName').val(response.data.fullName || ''); $('#customerPhone').val(response.data.phoneNumber || ''); $('#customerEmail').val(response.data.email || ''); } },
                error: (xhr, status, error) => { console.error('Lỗi khi lấy thông tin người dùng:', error); },
            });
        }

        function fetchDiscounts() {
            $.ajax({
                url: `/Booking/GetDiscounts?stadiumId=${bookingData.stadiumId}`,
                type: 'GET',
                success: (response) => renderDiscounts(response && response.length > 0 ? response : []),
                error: (xhr) => $('#discount-list').html(`<p class="text-red-500 italic">${xhr.responseJSON?.message || 'Lỗi khi lấy danh sách mã giảm giá.'}</p>`)
            });
        }

        // UI Rendering
        function updateInvoiceDetails() {
            if (!stadiumData || !bookingData.courts) return;
            $('#checkout-stadium-name').text(stadiumData.Name);
            const invoiceBody = $('#checkout-invoice-body');
            invoiceBody.empty();
            let calculatedOriginalPrice = 0;
            bookingData.courts.forEach(court => {
                const matchedCourt = stadiumData.Courts.find(c => c.Id === court.courtId);
                const pricePerHour = matchedCourt?.PricePerHour || 0;
                const courtName = matchedCourt?.Name || 'Không xác định';
                mergeTimeRanges(court.times).forEach(range => {
                    const duration = parseInt(range.end.split(':')[0]) - parseInt(range.start.split(':')[0]);
                    const total = duration * pricePerHour;
                    calculatedOriginalPrice += total;
                    invoiceBody.append(`<tr class="border-b"><td class="py-2">${courtName}</td><td class="py-2 text-center">${range.start} - ${range.end}</td><td class="py-2 text-right">${formatCurrency(pricePerHour)}</td><td class="py-2 text-right font-bold">${formatCurrency(total)}</td></tr>`);
                });
            });

            subtotalPrice = calculatedOriginalPrice;
            $('#checkout-original-price').text(formatCurrency(subtotalPrice));
            $('#checkout-total-price').text(formatCurrency(totalPrice));

            if (discountAmount > 0) {
                $('#discount-amount-row').removeClass('hidden');
                $('#checkout-discount-amount').text(`- ${formatCurrency(discountAmount)}`);
            } else {
                $('#discount-amount-row').addClass('hidden');
            }
        }

        function renderDiscounts(discounts) {
            const listContainer = $('#discount-list');
            listContainer.empty();
            if (discounts.length === 0) {
                listContainer.html('<p class="text-gray-500 italic">Không có mã giảm giá nào hợp lệ.</p>');
                return;
            }
            discounts.forEach(discount => {
                listContainer.append(`<div class="p-4 bg-gray-100 rounded-lg border flex flex-col hover:bg-gray-200 cursor-pointer" data-id="${discount.id}" data-percent="${discount.percentValue}" data-min-amount="${discount.minOrderAmount}" data-max-amount="${discount.maxDiscountAmount}" data-code="${discount.code}"><div class="flex justify-between items-start"><span class="text-lg font-bold text-indigo-600">${discount.code}</span><span class="text-sm font-semibold text-green-600">${discount.percentValue}% giảm</span></div><p class="text-gray-500 text-sm mt-1">${discount.description || 'Không có mô tả'}</p><p class="text-gray-500 text-xs mt-1">Áp dụng cho đơn từ ${formatCurrency(discount.minOrderAmount)} | Tối đa ${formatCurrency(discount.maxDiscountAmount)}</p><button type="button" class="apply-discount-btn mt-2 px-4 py-2 bg-green-500 text-white rounded-lg text-sm self-end">Áp dụng</button></div>`);
            });
        }

                function applyDiscount(id, percent, minAmount, maxAmount, code) {
            if (subtotalPrice < minAmount) {
                showModal('Lỗi', `Đơn hàng phải có giá trị tối thiểu là ${formatCurrency(minAmount)} để áp dụng mã này.`);
                return;
            }
            const calculatedDiscount = subtotalPrice * (percent / 100);
            discountAmount = Math.min(calculatedDiscount, maxAmount);
            totalPrice = subtotalPrice - discountAmount;
            selectedDiscountId = id;

            // Cập nhật UI
            $('#selected-code-name').text(code);
            $('#selected-code-amount').text(`Giảm ${formatCurrency(discountAmount)}₫`);
            $('#no-discount-selected'). addClass('hidden');
            $('#discount-selected'). removeClass('hidden');

            updateInvoiceDetails();
            updateHiddenFields();
            hideDiscountModal();
            showModal('Thành công', `Mã giảm giá "${code}" đã được áp dụng! `);
        }

        function removeDiscount() {
            discountAmount = 0;
            totalPrice = subtotalPrice;
            selectedDiscountId = null;

            // Cập nhật UI
            $('#no-discount-selected'). removeClass('hidden');
            $('#discount-selected').addClass('hidden');

            updateInvoiceDetails();
            updateHiddenFields();
        }

        // Event listeners
        $('#remove-discount-button'). click(removeDiscount);
        $('#change-discount-button').click(() => { fetchDiscounts(); showDiscountModal(); });

        function updateHiddenFields() {
            const rawDate = String(bookingData.date).trim();
            const dateISO = /^\d{4}-\d{2}-\d{2}$/.test(rawDate) ? rawDate : (() => { const [d, m, y] = rawDate.split(/[\/\-\.]/); return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`; })();

            $('#booking-date').val(dateISO);
            $('#booking-original-price').val(subtotalPrice);
            $('#booking-total-price').val(totalPrice);
            $('#booking-note').val('');
            $('#booking-discount-id').val(selectedDiscountId || '');
            $('#booking-stadium-id').val(bookingData.stadiumId);

            const courtIdsContainer = $('#court-ids-container');
            courtIdsContainer.empty();
            let detailIndex = 0;
            bookingData.courts.forEach(court => {
                mergeTimeRanges(court.times).forEach(({ start, end }) => {
                    const baseName = `BookingDetails[${detailIndex}]`;
                    courtIdsContainer.append($('<input>').attr({ type: 'hidden', name: `${baseName}.CourtId`, value: court.courtId }));
                    courtIdsContainer.append($('<input>').attr({ type: 'hidden', name: `${baseName}.StartTime`, value: `${dateISO}T${start}:00` }));
                    courtIdsContainer.append($('<input>').attr({ type: 'hidden', name: `${baseName}.EndTime`, value: `${dateISO}T${end}:00` }));
                    detailIndex++;
                });
            });
            $('#payment-method-input').val($('input[name="payment-method"]:checked').val());
        }

        // Event Listeners
        $(document).ready(function () {
            fetchStadiumData(bookingData.stadiumId);
            updateHiddenFields();
            loadUserProfile();

            // *** LOGIC UPDATE: Sửa lại luồng xử lý discount ***
            if (bookingData.type === 'day') {
                // Đây là chế độ xem chi tiết, không cho thanh toán hay sửa đổi. Logic này đúng.
                $('#discount-section, #payment-section').hide();
                const actionContainer = $('#action-buttons-container');
                actionContainer.empty().append(`<button type="button" id="back-button" class="w-full px-8 py-3 rounded-xl font-bold text-indigo-600 border border-indigo-600">Quay lại</button>`);
                $('#back-button').click(() => window.history.back());
            } else {
                // Đây là chế độ thanh toán (cho đơn pending/payfail)
                if (selectedDiscountId) {
                    // Nếu đơn hàng đã có mã giảm giá từ trước, hiển thị nó và khóa nút chọn.
                    fetchAndDisplayAppliedDiscount(selectedDiscountId);
                    $('#select-discount-button').prop('disabled', true).addClass('bg-gray-400 cursor-not-allowed').removeClass('bg-indigo-500').text('Đã áp dụng');
                } else {
                    // Nếu đơn hàng chưa có mã, cho phép người dùng chọn.
                    $('#select-discount-button').click(() => { fetchDiscounts(); showDiscountModal(); });
                }
            }

            $('#modal-close-btn').click(hideModal);
            $('#close-discount-modal').click(hideDiscountModal);
            $('#remove-discount-button').click(removeDiscount);
            if (bookingData.type !== 'day') {
                $('#back-button').click(() => window.history.back());
            }

            // Gắn sự kiện cho nút "Áp dụng" trong modal
            $('#discount-list').on('click', '.apply-discount-btn', function () {
                const card = $(this).closest('[data-id]');
                applyDiscount(
                    parseInt(card.data('id')),
                    parseFloat(card.data('percent')),
                    parseInt(card.data('min-amount')),
                    parseInt(card.data('max-amount')),
                    card.data('code')
                );
            });

            $('input[name="payment-method"]').change(updateHiddenFields);

            $('#booking-form').submit(function (e) {
                e.preventDefault();
                updateHiddenFields();
                this.submit();
            });
        });
    </script>
</body>
</html>
```