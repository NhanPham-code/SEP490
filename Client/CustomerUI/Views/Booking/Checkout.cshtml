@{
    ViewBag.Title = "Thanh Toán";
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .modal {
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
        }
    </style>
</head>
<body class="min-h-screen p-4 flex items-center justify-center">

    <!-- Modal -->
    <div id="custom-modal" class="modal fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full mx-4">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-2"></h3>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <div class="text-right">
                <button id="modal-close-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Form chính để submit booking -->
    <form id="booking-form" action="/Booking/CreateBooking" method="post">
        <!-- Hidden fields chứa dữ liệu booking -->
        <input type="hidden" id="booking-date" name="Date" value="" />
        <input type="hidden" id="booking-start-time" name="StartTime" value="" />
        <input type="hidden" id="booking-end-time" name="EndTime" value="" />
        <input type="hidden" id="booking-total-price" name="TotalPrice" value="" />
        <input type="hidden" id="booking-note" name="Note" value="" />
        <input type="hidden" id="booking-discount-id" name="DiscountId" value="" />
        <div id="court-ids-container"></div>
        <input type="hidden" id="payment-method-input" name="PaymentMethod" value="bank_transfer" />
        <input type="hidden" id="booking-stadium-id" name="StadiumId" value="" />

        <!-- Nội dung -->
        <div id="checkout-container" class="bg-white rounded-2xl shadow-lg p-6 md:p-8 max-w-xl w-full mx-auto">
            <h1 class="text-3xl font-bold text-indigo-600 text-center mb-6">Thông Tin Đặt Sân</h1>

            <!-- Thông tin hóa đơn -->
            <div class="p-6 bg-gray-50 rounded-xl shadow-inner mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Chi tiết hóa đơn</h2>
                <div class="space-y-3 text-gray-700">
                    <div class="flex justify-between">
                        <span>Sân vận động:</span>
                        <span id="checkout-stadium-name" class="font-bold"></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Sân:</span>
                        <span id="checkout-court-name" class="font-bold text-indigo-600"></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Thời gian:</span>
                        <span id="checkout-time" class="font-bold"></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Tổng số giờ:</span>
                        <span id="checkout-duration" class="font-bold"></span>
                    </div>
                    <div class="flex justify-between border-t pt-3 mt-3 border-gray-200">
                        <span>Tạm tính:</span>
                        <span id="checkout-subtotal-price"></span>
                    </div>
                    <div class="flex justify-between text-green-600 font-bold hidden" id="discount-amount-row">
                        <span>Giảm giá:</span>
                        <span id="checkout-discount-amount"></span>
                    </div>
                    <div class="flex justify-between font-bold text-lg border-t pt-3 mt-3 border-gray-200 text-gray-900">
                        <span>Tổng cộng:</span>
                        <span id="checkout-total-price" class="text-indigo-600"></span>
                    </div>
                </div>
            </div>

            <!-- Thông tin người đặt -->
            <div class="p-6 bg-gray-50 rounded-xl shadow-inner mb-6" id="profileForm">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Thông tin người đặt</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Họ và tên</label>
                        <input type="text" id="customerName" class="mt-1 w-full p-3 rounded-lg border border-gray-300" disabled>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Số điện thoại</label>
                        <input type="text" id="customerPhone" value="@ViewBag.CustomerPhone" class="mt-1 w-full p-3 rounded-lg border border-gray-300" disabled>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="customerEmail" class="mt-1 w-full p-3 rounded-lg border border-gray-300" disabled>
                    </div>
                </div>
            </div>

            <!-- Mã giảm giá -->
            <div class="p-6 bg-gray-50 rounded-xl shadow-inner mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Mã giảm giá</h2>
                <div class="flex gap-2">
                    <input type="text" id="discount-code" class="flex-grow p-3 rounded-lg border border-gray-300" placeholder="Nhập mã giảm giá">
                    <button type="button" id="apply-discount-button" class="px-6 py-3 rounded-lg font-bold text-white bg-green-500">Áp dụng</button>
                </div>
            </div>

            <!-- Phương thức thanh toán -->
            <div class="p-6 bg-gray-50 rounded-xl shadow-inner mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Chọn phương thức thanh toán</h2>
                <div class="space-y-4">
                    <label class="flex items-center p-4 bg-white rounded-lg shadow-sm cursor-pointer border border-gray-200">
                        <input type="radio" name="payment-method" value="bank_transfer" class="form-radio text-indigo-600 h-5 w-5" checked>
                        <span class="ml-3 text-sm font-medium text-gray-700">Chuyển khoản ngân hàng</span>
                    </label>
                    <label class="flex items-center p-4 bg-white rounded-lg shadow-sm cursor-pointer border border-gray-200">
                        <input type="radio" name="payment-method" value="at_counter" class="form-radio text-indigo-600 h-5 w-5">
                        <span class="ml-3 text-sm font-medium text-gray-700">Thanh toán tại quầy</span>
                    </label>
                </div>
            </div>

            <!-- Nút hành động -->
            <div class="flex justify-between items-center gap-4 mt-8">
                <button type="button" id="back-button" class="px-6 py-2 rounded-xl font-bold text-indigo-600 border border-indigo-600">Quay lại</button>
                <button type="submit" id="complete-booking-button" class="w-full px-12 py-3 rounded-xl font-bold text-white bg-indigo-600">Hoàn tất đặt sân</button>
            </div>
        </div>
    </form>

    <script>
        // Lấy dữ liệu từ ViewBag (ASP.NET MVC truyền sang)
        const bookingData = {
            stadiumId: parseInt("@ViewBag.StadiumId"),
            courtIdsString: "@ViewBag.CourtIdsString", // Lấy chuỗi ID từ ViewBag
            date: "@ViewBag.Date",
            startTime: parseInt("@ViewBag.StartTime"),
            endTime: parseInt("@ViewBag.EndTime"),
            totalPrice: parseFloat("@ViewBag.TotalPrice")
        };

        console.log("stadium ID: ", parseInt("@ViewBag.StadiumId"));

        let subtotalPrice = bookingData.totalPrice;
        let discountAmount = 0;
        let totalPrice = subtotalPrice;
        let discountId = null;

        console.log("Booking Data:", bookingData);

        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('custom-modal').style.display = 'flex';
        }

        function hideModal() {
            document.getElementById('custom-modal').style.display = 'none';
        }

        function formatCurrency(amount) {
            return `${amount.toLocaleString('vi-VN')} VNĐ`;
        }

        function updateInvoiceDetails() {
            document.getElementById('checkout-stadium-name').textContent = bookingData.stadiumId;
            document.getElementById('checkout-court-name').textContent = `Sân ${bookingData.courtId}`;
            document.getElementById('checkout-time').textContent = `${bookingData.startTime}:00 - ${bookingData.endTime}:00`;
            document.getElementById('checkout-duration').textContent = `${bookingData.endTime - bookingData.startTime} giờ`;
            document.getElementById('checkout-subtotal-price').textContent = formatCurrency(subtotalPrice);
            document.getElementById('checkout-discount-amount').textContent = `- ${formatCurrency(discountAmount)}`;
            document.getElementById('checkout-total-price').textContent = formatCurrency(totalPrice);

            let courtNames = "";
            if (bookingData.courtIdsString) {
                const courtIdsArray = bookingData.courtIdsString.split(',');
                courtNames = courtIdsArray.map(id => `Sân ${id}`).join(', ');
            }

            document.getElementById('checkout-court-name').textContent = courtNames;

            const discountRow = document.getElementById('discount-amount-row');
            if (discountAmount > 0) {
                discountRow.classList.remove('hidden');
            } else {
                discountRow.classList.add('hidden');
            }
        }

        function updateHiddenFields() {
            // Chuẩn hoá date về yyyy-MM-dd
            const rawDate = String(bookingData.date).trim();
            const dateISO = /^\d{4}-\d{2}-\d{2}$/.test(rawDate)
                ? rawDate
                : (function () {
                    const [d, m, y] = rawDate.split(/[\/\-\.]/);
                    return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                })();

            const hh = (n) => String(n).padStart(2, "0");
            const startDateTime = `${dateISO}T${hh(bookingData.startTime)}:00:00`;
            const endDateTime = `${dateISO}T${hh(bookingData.endTime)}:00:00`;

            // Cập nhật hidden fields
            document.getElementById('booking-date').value = dateISO;
            document.getElementById('booking-start-time').value = startDateTime;
            document.getElementById('booking-end-time').value = endDateTime;
            document.getElementById('booking-total-price').value = totalPrice;
            document.getElementById('booking-note').value = '';
            document.getElementById('booking-discount-id').value = discountId || '';
            document.getElementById('booking-stadium-id').value = bookingData.stadiumId;
            
            // Xóa các input cũ trước khi tạo lại
            const courtIdsContainer = document.getElementById('court-ids-container');
            courtIdsContainer.innerHTML = '';

            // Tách chuỗi courtIdsString thành mảng
            if (bookingData.courtIdsString) {
                const courtIdsArray = bookingData.courtIdsString.split(',');

                // Tạo các input ẩn cho từng sân
                courtIdsArray.forEach((courtId, index) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = `BookingDetails[${index}].CourtId`; // Tên chuẩn để binding
                    input.value = courtId.trim();
                    courtIdsContainer.appendChild(input);
                });
            }

            // Cập nhật payment method
            const selectedPaymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
            document.getElementById('payment-method-input').value = selectedPaymentMethod;
        }

        function loadUserProfile() {
            $.ajax({
                url: `/Booking/GetUserProfile`,
                type: 'GET',
                dataType: 'json',
                timeout: 30000, // 30 seconds
                cache: false,
                success: function(response) {
                    console.log('API Response:', response);

                    if (response.success) {
                        populateForm(response.data);
                    } 
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        error: error,
                        responseText: xhr.responseText
                    });

                },
            });
        }

        function populateForm(data) {
            $('#customerName').val(data.fullName || '');
            $('#customerPhone').val(data.phoneNumber || '');
            $('#customerEmail').val(data.email || '');
        }

        window.onload = function () {
            updateInvoiceDetails();
            updateHiddenFields();
            loadUserProfile();

            // Event listeners
            document.getElementById('modal-close-btn').onclick = hideModal;
            document.getElementById('back-button').onclick = () => window.history.back();

            // Apply discount
            document.getElementById('apply-discount-button').onclick = (e) => {
                e.preventDefault();
                const code = document.getElementById('discount-code').value.trim().toUpperCase();

                if (code === 'GIAM10') {
                    discountAmount = subtotalPrice * 0.10;
                    totalPrice = subtotalPrice - discountAmount;
                    discountId = 1; // Giả sử discount ID là 1
                    updateInvoiceDetails();
                    updateHiddenFields();
                    showModal('Thành công', `Mã giảm giá "${code}" đã được áp dụng. Bạn được giảm ${formatCurrency(discountAmount)}.`);
                } else if (code === '') {
                    showModal('Thông báo', 'Vui lòng nhập mã giảm giá.');
                } else {
                    showModal('Lỗi', `Mã giảm giá "${code}" không hợp lệ.`);
                }
            };

            // Update payment method when changed
            document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('payment-method-input').value = this.value;
                });
            });

            // Form submission
            document.getElementById('booking-form').onsubmit = function(e) {
                e.preventDefault();

                // Cập nhật lại hidden fields trước khi submit
                updateHiddenFields();

                // Log để debug
                console.log('Form data before submit:');
                const formData = new FormData(this);
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }

                // Submit form
                this.submit();
            };
        };
    </script>
</body>
</html>
