@{
    ViewBag.Title = "Thanh Toán Đặt Sân Hàng Tháng";
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            transition: opacity 0.3s ease-in-out;
        }

        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }

        .modal-overlay.open {
            display: flex;
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen p-4 flex items-center justify-center">

    <!-- Discount Modal -->
    <div id="discount-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center opacity-0">
        <div class="modal-content bg-white rounded-lg p-6 shadow-xl max-w-lg w-full mx-4">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Chọn Mã Giảm Giá</h3>
            <div id="discount-list" class="space-y-4 max-h-80 overflow-y-auto mb-4"></div>
            <div class="text-right">
                <button type="button" id="close-discount-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2">Đóng</button>
            </div>
        </div>
    </div>

    <!-- General Message Modal -->
    <div id="custom-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center opacity-0">
        <div class="modal-content bg-white rounded-lg p-6 shadow-xl max-w-sm w-full mx-4">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-2"></h3>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <div class="text-right">
                <button id="modal-close-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <form id="booking-form" action="/Booking/CreateMonthlyBooking" method="post">
        <!-- Hidden fields for submission matching MonthlyBookingCreateDto -->
        <input type="hidden" name="StadiumId" id="StadiumId" />
        <input type="hidden" name="DiscountId" id="DiscountId" />
        <input type="hidden" name="OriginalPrice" id="OriginalPrice" />
        <input type="hidden" name="TotalPrice" id="TotalPrice" />
        <input type="hidden" name="PaymentMethod" id="PaymentMethod" />
        <input type="hidden" name="StartTime" id="StartTime" />
        <input type="hidden" name="EndTime" id="EndTime" />
        <input type="hidden" name="Month" id="Month" />
        <input type="hidden" name="Year" id="Year" />
        <!-- Hidden inputs for lists (Dates and CourtIds) -->
        <div id="dates-container"></div>
        <div id="courtids-container"></div>

        <div id="checkout-container" class="bg-white rounded-2xl shadow-lg p-6 md:p-8 max-w-2xl w-full mx-auto">
            <h1 class="text-3xl font-bold text-indigo-600 text-center mb-6">Thông Tin Đặt Sân Hàng Tháng</h1>

            <!-- Invoice Details Section -->
            <div class="p-6 bg-gray-50 rounded-xl shadow-inner mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Chi tiết hóa đơn</h2>
                <div class="space-y-3 text-gray-700">
                    <div class="flex justify-between"><span>Sân vận động:</span><span id="checkout-stadium-name" class="font-bold"></span></div>
                    <div class="flex justify-between"><span>Các sân đã chọn:</span><span id="checkout-court-names" class="font-bold text-indigo-600"></span></div>
                    <div class="flex justify-between"><span>Khung giờ mỗi ngày:</span><span id="checkout-time" class="font-bold"></span></div>
                    <div class="flex justify-between"><span>Thời gian:</span><span id="checkout-month-year" class="font-bold"></span></div>
                    <div class="flex justify-between items-start">
                        <span>Các ngày đã chọn:</span>
                        <span id="checkout-selected-days" class="font-bold text-right ml-4" style="word-break: break-word;"></span>
                    </div>
                    <div class="flex justify-between border-t pt-3 mt-3 border-gray-200"><span>Giá gốc:</span><span id="checkout-original-price"></span></div>
                    <div class="flex justify-between text-green-600 font-bold hidden" id="discount-amount-row"><span>Giảm giá:</span><span id="checkout-discount-amount"></span></div>
                    <div class="flex justify-between font-bold text-lg border-t pt-3 mt-3 border-gray-200 text-gray-900"><span>Tổng cộng:</span><span id="checkout-total-price" class="text-indigo-600"></span></div>
                </div>
            </div>

            <!-- User Info Section -->
            <div class="p-6 bg-gray-50 rounded-xl shadow-inner mb-6" id="profileForm">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Thông tin người đặt</h2>
                <div class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">Họ và tên</label><input type="text" id="customerName" class="mt-1 w-full p-3 rounded-lg border border-gray-300" disabled></div>
                    <div><label class="block text-sm font-medium text-gray-700">Số điện thoại</label><input type="text" id="customerPhone" class="mt-1 w-full p-3 rounded-lg border border-gray-300" disabled></div>
                    <div><label class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="customerEmail" class="mt-1 w-full p-3 rounded-lg border border-gray-300" disabled></div>
                </div>
            </div>

            <!-- Discount Section -->
            <div id="discount-section" class="p-6 bg-gray-50 rounded-xl shadow-inner mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Mã giảm giá</h2>

                <!-- Khi chưa chọn mã -->
                <div id="no-discount-selected" class="flex items-center justify-between">
                    <span class="text-gray-500 italic">Chưa có mã giảm giá nào được chọn</span>
                    <button type="button" id="select-discount-button"
                            class="px-5 py-3.5 rounded-lg font-semibold text-white bg-indigo-500 hover:bg-indigo-600 transition">
                        Chọn mã
                    </button>
                </div>

                <!-- Khi đã chọn mã (ẩn mặc định) -->
                <div id="discount-selected" class="hidden">
                    <div class="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div>
                                <p id="selected-code-name" class="font-bold text-green-700"></p>
                                <p id="selected-code-amount" class="text-sm text-green-600"></p>
                            </div>
                        </div>
                        <button type="button" id="remove-discount-button"
                                class="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition"
                                title="Bỏ chọn mã">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <button type="button" id="change-discount-button"
                            class="mt-3 text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                        Đổi mã khác
                    </button>
                </div>
            </div>

            <!-- Payment Method Section -->
            <div id="payment-section" class="p-6 bg-gray-50 rounded-xl shadow-inner mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Chọn phương thức thanh toán</h2>
                <div class="space-y-4">
                    <label class="flex items-center p-4 bg-white rounded-lg shadow-sm cursor-pointer border border-gray-200">
                        <input type="radio" name="payment-method" value="vnpay_100" class="form-radio text-indigo-600 h-5 w-5" checked>
                        <span class="ml-3 text-sm font-medium text-gray-700">Trả trước 100% qua VNPay</span>
                    </label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div id="action-buttons-container" class="flex justify-between items-center gap-4 mt-8">
                <button type="button" id="back-button" class="min-w-[150px] px-8 py-3 rounded-xl font-bold text-indigo-600 border border-indigo-600">Quay lại</button>
                <button type="submit" id="complete-booking-button" class="w-full px-12 py-3 rounded-xl font-bold text-white bg-indigo-600">Hoàn tất đặt sân</button>
            </div>
        </div>
    </form>

    <script>
        function parseStringList(input) {
            if (!input) return [];
            if (Array.isArray(input)) return input.map(Number);

            const stringInput = String(input);
            return stringInput.split(',').map(s => Number(s.trim()));
        }

        const bookingData = {
            stadiumId: parseInt("@ViewBag.StadiumId"),
            year: parseInt("@ViewBag.Year"),
            month: parseInt("@ViewBag.Month"),
            selectedDays: parseStringList("@ViewBag.SelectedDays"),
            selectedCourtIds: parseStringList("@ViewBag.SelectedCourtIds"),
            startTime: parseInt("@ViewBag.StartTime"),
            endTime: parseInt("@ViewBag.EndTime"),
            totalPrice: parseFloat("@ViewBag.TotalPrice"),
            afterPrice: parseFloat("@(ViewBag.AfterPrice ?? ViewBag.TotalPrice)"),
            discountId: @(ViewBag.DiscountId ?? "null"),
            type: "@ViewBag.Type",
            monthlyBookingId: @(ViewBag.MonthlyBookingId ?? "null"),
            courtNames: "@Html.Raw(ViewBag.CourtNames)",
        };


        let stadiumData = null;
        if (bookingData.afterPrice === 0 && bookingData.discountId === null) {
            bookingData.afterPrice = bookingData.totalPrice;
        }

        let originalPrice = bookingData.totalPrice;
        let discountAmount = originalPrice - bookingData.afterPrice;
        let finalPrice = bookingData.afterPrice;
        let selectedDiscountId = bookingData.discountId;

        const showModal = (title, message) => { $('#modal-title').text(title); $('#modal-message').text(message); $('#custom-modal').removeClass('opacity-0').addClass('open').fadeIn(); };
        const hideModal = () => $('#custom-modal').removeClass('open').addClass('opacity-0').fadeOut();
        const showDiscountModal = () => $('#discount-modal').removeClass('opacity-0').addClass('open').fadeIn();
        const hideDiscountModal = () => $('#discount-modal').removeClass('open').addClass('opacity-0').fadeOut();
        const formatCurrency = (amount) => `${amount.toLocaleString('vi-VN')} VNĐ`;
        const pad = (num) => String(num).padStart(2, '0');

        function fetchStadiumData(id) {
            $.ajax({
                url: `/Home/Stadiums?searchTerm=&$filter=Id eq ${id}&$expand=Courts`,
                type: 'GET',
                success: (data) => {
                    // --- SỬA ĐỔI 1 ---
                    // GIẢI THÍCH: Dữ liệu API trả về có dạng { "value": [ ... ] }.
                    // Đối tượng sân vận động thực sự nằm ở phần tử đầu tiên của mảng "value".
                    // Mã cũ gán `stadiumData = data` là sai. Mã mới truy cập đúng vào `data.value[0]`.
                    if (data.value && data.value.length > 0) {
                        stadiumData = data.value[0];
                        console.log("stadiumData:", stadiumData);
                        updateInvoiceDetails();
                    }
                },
                error: (err) => console.error('Lỗi khi tải dữ liệu sân vận động:', err)
            });
        }

        function loadUserProfile() {
            $.ajax({
                url: `/Booking/GetUserProfile`,
                type: 'GET',
                success: (response) => {
                    if (response.success) {
                        $('#customerName').val(response.data.fullName || '');
                        $('#customerPhone').val(response.data.phoneNumber || '');
                        $('#customerEmail').val(response.data.email || '');
                    }
                },
                error: (err) => console.error('Lỗi khi lấy thông tin người dùng:', err)
            });
        }

        function fetchDiscounts() {
            $.ajax({
                url: `/Booking/GetDiscounts?stadiumId=${bookingData.stadiumId}`,
                type: 'GET',
                success: (discounts) => {
                    renderDiscounts(discounts.length > 0 ? discounts : []);
                },
                error: (xhr) => {
                    const msg = xhr.responseJSON?.message || 'Lỗi khi lấy danh sách mã giảm giá.';
                    $('#discount-list').html(`<p class="text-red-500 italic">${msg}</p>`);
                }
            });
        }

        function fetchAndDisplayAppliedDiscount(discountId) {
            $. ajax({
                url: `/Booking/GetDiscountById? id=${discountId}`,
                type: 'GET',
                success: function (discount) {
                    if (discount) {
                        $('#selected-code-name').text(discount. code);
                        $('#selected-code-amount').text(`Giảm ${formatCurrency(discountAmount)}`);
                        $('#no-discount-selected').addClass('hidden');
                        $('#discount-selected'). removeClass('hidden');
                    }
                },
                error: function () {
                    $('#selected-code-name').text('Mã giảm giá');
                    $('#selected-code-amount').text(`Giảm ${formatCurrency(discountAmount)}`);
                    $('#no-discount-selected').addClass('hidden');
                    $('#discount-selected'). removeClass('hidden');
                }
            });
        }

        function updateInvoiceDetails() {
            if (bookingData.courtNames) {
                $('#checkout-court-names').text(bookingData.courtNames);
            } else {
                if (!stadiumData || !stadiumData.Courts) {
                    console.log("Đang chờ dữ liệu stadiumData hoặc danh sách Courts...");
                    return;
                };

                // 2. Lọc và lấy tên sân
                const courtNames = bookingData.selectedCourtIds.map(selectedId => {
                    // Tìm sân trong mảng stadiumData.Courts
                    // Lưu ý: Dùng c.Id (I viết hoa) và ép kiểu Number để so sánh cho chắc chắn
                    const court = stadiumData.Courts.find(c => c.Id === Number(selectedId));

                    // Nếu tìm thấy sân thì lấy c.Name (N viết hoa), ngược lại hiển thị tạm ID
                    return court ? court.Name : `Sân #${selectedId}`;
                }).join(', '); // Nối các tên bằng dấu phẩy

                // 3. Cập nhật lên giao diện
                $('#checkout-stadium-name').text(stadiumData.Name); // Dùng .Name (N viết hoa)

                // Nếu map ra chuỗi rỗng thì báo chưa chọn, ngược lại hiển thị tên các sân
                $('#checkout-court-names').text(courtNames || 'Chưa chọn sân');
            }

            if (stadiumData) {
                $('#checkout-stadium-name').text(stadiumData.Name);
            }

            // --- Các phần hiển thị thời gian, giá tiền giữ nguyên ---
            $('#checkout-time').text(`${bookingData.startTime}:00 - ${bookingData.endTime}:00`);
            $('#checkout-month-year').text(`Tháng ${bookingData.month} / ${bookingData.year}`);
            $('#checkout-selected-days').text(bookingData.selectedDays.join(', '));
            $('#checkout-original-price').text(formatCurrency(originalPrice));
            $('#checkout-total-price').text(formatCurrency(finalPrice));

            if (discountAmount > 0) {
                $('#discount-amount-row').removeClass('hidden');
                $('#checkout-discount-amount').text(`- ${formatCurrency(discountAmount)}`);
            } else {
                $('#discount-amount-row').addClass('hidden');
            }
        }

        function renderDiscounts(discounts) {
            const listContainer = $('#discount-list');
            listContainer.empty();
            if (discounts.length === 0) {
                listContainer.html('<p class="text-gray-500 italic">Không có mã giảm giá nào cho sân này.</p>');
                return;
            }
            discounts.forEach(d => {
                listContainer.append(`
                    <div class="p-4 bg-gray-100 rounded-lg border flex flex-col hover:bg-gray-200 transition-colors cursor-pointer"
                         data-id="${d.id}" data-percent="${d.percentValue}" data-min="${d.minOrderAmount}" data-max="${d.maxDiscountAmount}" data-code="${d.code}">
                        <div class="flex justify-between items-start">
                            <span class="text-lg font-bold text-indigo-600">${d.code}</span>
                            <span class="text-sm font-semibold text-green-600">${d.percentValue}% giảm</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">${d.description || 'Không có mô tả'}</p>
                        <p class="text-xs text-gray-500 mt-1">Áp dụng cho đơn từ ${formatCurrency(d.minOrderAmount)} | Tối đa ${formatCurrency(d.maxDiscountAmount)}</p>
                        <button type="button" class="apply-discount-btn mt-2 px-4 py-2 bg-green-500 text-white rounded-lg text-sm self-end">Áp dụng</button>
                    </div>
                `);
            });
        }

        function updateHiddenFields() {
            $('#StadiumId').val(bookingData.stadiumId);
            $('#DiscountId').val(selectedDiscountId || '');
            $('#OriginalPrice').val(originalPrice);
            $('#TotalPrice').val(finalPrice);
            $('#PaymentMethod').val($('input[name="payment-method"]:checked').val());
            $('#StartTime').val(`${pad(bookingData.startTime)}:00`);
            $('#EndTime').val(`${pad(bookingData.endTime)}:00`);
            $('#Month').val(bookingData.month);
            $('#Year').val(bookingData.year);

            const datesContainer = $('#dates-container');
            datesContainer.empty();
            bookingData.selectedDays.forEach((day, index) => {
                datesContainer.append(`<input type="hidden" name="Dates[${index}]" value="${day}" />`);
            });

            const courtIdsContainer = $('#courtids-container');
            courtIdsContainer.empty();
            bookingData.selectedCourtIds.forEach((id, index) => {
                courtIdsContainer.append(`<input type="hidden" name="CourtIds[${index}]" value="${id}" />`);
            });
        }

                // Apply & Remove Discount Functions
        function applyDiscount(id, percent, minAmount, maxAmount, code) {
            if (originalPrice < minAmount) {
                showModal('Lỗi', `Đơn hàng phải có giá trị tối thiểu là ${formatCurrency(minAmount)} để áp dụng mã này.`);
                return;
            }

            const calculatedDiscount = originalPrice * (percent / 100);
            discountAmount = Math. min(calculatedDiscount, maxAmount);
            finalPrice = originalPrice - discountAmount;
            selectedDiscountId = id;

            // Cập nhật UI
            $('#selected-code-name').text(code);
            $('#selected-code-amount').text(`Giảm ${formatCurrency(discountAmount)}`);
            $('#no-discount-selected'). addClass('hidden');
            $('#discount-selected'). removeClass('hidden');

            updateInvoiceDetails();
            updateHiddenFields();
            hideDiscountModal();
            showModal('Thành công', `Mã giảm giá "${code}" đã được áp dụng! `);
        }

        function removeDiscount() {
            // Reset các giá trị
            discountAmount = 0;
            finalPrice = originalPrice;
            selectedDiscountId = null;

            // Cập nhật UI
            $('#no-discount-selected').removeClass('hidden');
            $('#discount-selected').addClass('hidden');

            updateInvoiceDetails();
            updateHiddenFields();
        }

        $(document).ready(function() {
            fetchStadiumData(bookingData.stadiumId);
            loadUserProfile();
            updateHiddenFields();

            if (selectedDiscountId) {
                fetchAndDisplayAppliedDiscount(selectedDiscountId);
            }

            if (bookingData.type === 'month') {
                console.log("Hiding discount and payment sections for monthly booking view.");
                $('#discount-section').hide();
                $('#payment-section').hide();

                const actionContainer = $('#action-buttons-container');
                actionContainer.empty();
                actionContainer.append(`<button type="button" id="back-button" class="w-full px-8 py-3 rounded-xl font-bold text-indigo-600 border border-indigo-600">Quay lại Lịch chơi</button>`);

                $('#back-button').click(() => window.location.href = '@Url.Action("BookingSchedule", "Booking")');
            }

            if (bookingData.type !== 'month') {
                $('#back-button').off('click').on('click', function(e) {
                    e.preventDefault();
                    const { stadiumId, year, month, selectedDays, selectedCourtIds, startTime, endTime } = bookingData;
                    const backUrl = `/Booking/MonthlyBooking?stadiumId=${stadiumId}&year=${year}&month=${month}&selectedDays=${selectedDays.join(',')}&selectedCourtIds=${selectedCourtIds.join(',')}&startTime=${startTime}&endTime=${endTime}`;
                    window.location.href = backUrl;
                });
            }
                // Modal buttons
        $('#modal-close-btn').click(hideModal);
        $('#close-discount-modal').click(hideDiscountModal);
        $('#back-button').click(() => window.history.back());

        // Discount buttons
        $('#select-discount-button').click(() => { fetchDiscounts(); showDiscountModal(); });
        $('#change-discount-button'). click(() => { fetchDiscounts(); showDiscountModal(); });
        $('#remove-discount-button').click(removeDiscount);

        // Apply discount từ modal
        $('#discount-list').on('click', '.apply-discount-btn', function() {
            const card = $(this).closest('[data-id]');
            applyDiscount(
                card.data('id'),
                card.data('percent'),
                card.data('min'),
                card.data('max'),
                card. data('code')
            );
        });

            $('input[name="payment-method"]').change(updateHiddenFields);

            $('#booking-form').submit(function(e) {
                if (bookingData.type === 'month') {
                    e.preventDefault();
                    return;
                }
                updateHiddenFields();
            });
        });
    </script>
</body>
</html>