@{
    ViewData["Title"] = "Quản Lý Sân";
    string name = ViewBag.Name;
    var currentUser = Context.Session.GetString("FullName"); // You can get this from your auth system
    DateTime time = DateTime.UtcNow;
    TimeZoneInfo vnTimeZone = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time");
    DateTime currentUtc = TimeZoneInfo.ConvertTimeFromUtc(time, vnTimeZone);

}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>

    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
    <link href="~/css/stadium/court.css" rel="stylesheet" />
    <!-- Libraries -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Your existing styles remain the same -->
    <style>
        /* Your existing CSS styles here */
    </style>
</head>
<body>
    
    <div class="container py-5">
        <div class="card p-4">
            <!-- Add user info and datetime -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="user-info">
                        <span class="text-muted">
                            <i class="ri-user-line me-1"></i>@currentUser
                        </span>
                        <span class="mx-2">|</span>
                        <span class="text-muted">
                            <i class="ri-time-line me-1"></i>@currentUtc.ToString("yyyy-MM-dd HH:mm:ss UTC")
                        </span>
                    </div>
                    <div class="stadium-info">
                        <span class="badge bg-primary">
                            <i class="ri-building-line me-1"></i>Sân vận động #@name
                        </span>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Danh Sách Sân</h2>
        
            </div>

            <div class="table-responsive">
                <table class="table table-hover" id="courtsTable">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Tên Sân</th>
                            <th scope="col">Loại Thể Thao</th>
                            <th scope="col">Giá/Giờ</th>
                            <th scope="col">Trạng Thái</th>
                            <th scope="col">Ngày Tạo</th>
                            <th scope="col">Ngày Cập Nhật</th>
                            <th scope="col">Hành Động</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const stadiumId = sessionStorage.getItem('currentStadiumId');
        const currentUser = '@currentUser';
        const currentDateTime = '@currentUtc.ToString("yyyy-MM-dd HH:mm:ss")';
        let selectedSportType = '';
        let selectedStatus = true;

        $(document).ready(function () {
            // Initial load
            loadCourts(stadiumId);

            // Load Courts Function
                    function loadCourts(stadiumId) {
            $.ajax({
                url: '/Court/GetAllCourts',
                type: 'GET',
                dataType: 'json',
                data: { stadiumId: stadiumId },
                success: function (data) {
                    // Kiểm tra nếu không có data hoặc data rỗng
                    if (!data || data.length === 0) {
                        $('#courtsTable tbody').html(`
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <div class="py-5">
                                        <i class="ri-basketball-line" style="font-size: 3rem; opacity: 0.3;"></i>
                                        <div class="mt-3">
                                            <h5 class="text-muted">Không có sân nào</h5>
                                            <p class="mb-0">Chưa có sân nào được tạo cho sân vận động này.</p>
                                        </div>
                                    </div>
                                </td>
                            </tr>`);
                        return;
                    }

                    // Xử lý khi có data
                    let rows = '';
                    data.forEach(court => {
                        let formattedPrice = Number(court.pricePerHour).toLocaleString('vi-VN') + ' VND';
                        let statusBadge = court.isAvailable
                            ? '<span class="badge badge-available">Có Sẵn</span>'
                            : '<span class="badge badge-unavailable">Không Có Sẵn</span>';
                        let actionButtons = ``;
                        if (court.sportType === 'Bóng đá sân 7' || court.sportType === "Bóng đá sân 11") {
                            actionButtons += `
                                <button class="btn btn-sm btn-outline-info" onclick="viewCourtRelation(${court.id})" title="Liên kết các sân">
                                    <i class="ri-links-line"></i>
                                </button>`;
                        }
                        rows += `
                            <tr>
                                <td>${court.id}</td>
                                <td>${court.name}</td>
                                <td>${court.sportType}</td>
                                <td>${formattedPrice}</td>
                                <td>${statusBadge}</td>
                                <td>${new Date(court.createdAt).toLocaleString('vi-VN')}</td>
                                <td>${new Date(court.updatedAt).toLocaleString('vi-VN')}</td>
                                <td>${actionButtons}</td>
                            </tr>`;
                    });
                    $('#courtsTable tbody').html(rows);
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi khi tải danh sách sân:', error);
                    $('#courtsTable tbody').html(`
                        <tr>
                            <td colspan="8" class="text-center text-danger">
                                <div class="py-4">
                                    <i class="ri-error-warning-line me-2" style="font-size: 2rem;"></i>
                                    <div class="mt-2">
                                        <h6 class="text-danger mb-1">Lỗi khi tải danh sách sân</h6>
                                        <p class="mb-2 text-muted">Vui lòng thử lại sau.</p>
                                        <button class="btn btn-sm btn-outline-danger" onclick="loadCourts(${stadiumId})">
                                            <i class="ri-refresh-line me-1"></i>
                                            Thử lại
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>`);
                }
            });
        }

            

            // Edit Court Function
            window.editCourt = function(courtId) {
                $.ajax({
                    url: '/CourtsManager/GetCourtById',
                    type: 'GET',
                    data: { id: courtId },
                    success: function(court) {
                        selectedSportType = court.sportType;


                        Swal.fire({
                            title: '<i class="ri-edit-2-line"></i> Chỉnh Sửa Sân',
                            html: getCourtFormHtml(court),
                            showCancelButton: true,
                            confirmButtonText: '<i class="ri-save-line me-1"></i>Lưu Thay Đổi',
                            cancelButtonText: '<i class="ri-close-line me-1"></i>Hủy',
                            confirmButtonColor: '#3b82f6',
                            cancelButtonColor: '#6b7280',
                            focusConfirm: false,
                            width: '1000px',
                            allowOutsideClick: true,
                            allowEscapeKey: true,
                            showCloseButton: true,
                            didOpen: () => {
                                initializeSportTypeGrid();

                                updatePriceDisplay(court.pricePerHour);
                            },
                            preConfirm: () => validateCourtForm(courtId)
                        }).then((result) => {
                            if (result.isConfirmed) {
                                const courtData = result.value;
                                courtData.updatedAt = currentDateTime;
                                courtData.updatedBy = currentUser;
                                const formData = new FormData();
                        // add value to form data
                        formData.append("Id", courtData.id);
                        formData.append("StadiumId", courtData.stadiumId);
                        formData.append("Name", courtData.name);
                        formData.append("SportType", courtData.sportType.trim());
                        formData.append("PricePerHour", courtData.pricePerHour);
                        formData.append("IsAvailable", true);
                        formData.append("CreatedAt", courtData.createdAt);
                        formData.append("UpdatedAt", courtData.updatedAt);
                        formData.append("CreatedBy", courtData.createdBy);

                                $.ajax({
                                    url: '/CourtsManager/UpdateCourt',
                                    type: 'PUT',
                                    processData: false,
                                    contentType: false,
                                    data: formData,
                                    success: function(response) {
                                        showSuccessMessage('Cập Nhật Thành Công', 'Sân đã được cập nhật thành công');
                                        loadCourts(stadiumId);
                                    },
                                    error: function(xhr, status, error) {
                                        showErrorMessage('Không thể cập nhật sân. Vui lòng thử lại.');
                                    }
                                });
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        showErrorMessage('Không thể lấy thông tin sân. Vui lòng thử lại.');
                    }
                });
            };

                    // Lock Court Function
        window.lockCourt = function(courtId) {
            Swal.fire({
                title: '<i class="ri-lock-line"></i> Bạn có chắc chắn?',
                html: `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 4rem; color: #f59e0b; margin-bottom: 16px;">
                            <i class="ri-lock-line"></i>
                        </div>
                        <p style="font-size: 1.1rem; color: #374151; margin-bottom: 8px;">
                            Sân sẽ bị khóa tạm thời!
                        </p>
                        <p style="color: #6b7280;">
                            Sân sẽ không thể sử dụng cho đến khi được mở khóa.
                        </p>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#f59e0b',
                cancelButtonColor: '#6b7280',
                confirmButtonText: '<i class="ri-lock-line me-1"></i>Có, khóa sân!',
                cancelButtonText: '<i class="ri-close-line me-1"></i>Hủy',
                width: '400px',
                allowOutsideClick: true,
                allowEscapeKey: true,
                showCloseButton: true
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/CourtsManager/DeleteCourt?id=${courtId}`,
                        type: 'POST',
                        data: {
                            id: courtId
                        },
                        success: function(response) {
                            showSuccessMessage('Đã Khóa!', 'Sân đã được khóa thành công');
                            loadCourts(stadiumId);
                        },
                        error: function(xhr, status, error) {
                            showErrorMessage('Không thể khóa sân. Vui lòng thử lại.');
                        }
                    });
                }
            });
        };

        // Unlock Court Function
        window.unlockCourt = function(courtId) {
            Swal.fire({
                title: '<i class="ri-lock-unlock-line"></i> Bạn có chắc chắn?',
                html: `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 4rem; color: #10b981; margin-bottom: 16px;">
                            <i class="ri-lock-unlock-line"></i>
                        </div>
                        <p style="font-size: 1.1rem; color: #374151; margin-bottom: 8px;">
                            Sân sẽ được mở khóa!
                        </p>
                        <p style="color: #6b7280;">
                            Sân sẽ có thể sử dụng bình thường trở lại.
                        </p>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280',
                confirmButtonText: '<i class="ri-lock-unlock-line me-1"></i>Có, mở khóa!',
                cancelButtonText: '<i class="ri-close-line me-1"></i>Hủy',
                width: '400px',
                allowOutsideClick: true,
                allowEscapeKey: true,
                showCloseButton: true
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/CourtsManager/DeleteCourt?id=${courtId}`,
                        type: 'GET',

                        success: function(response) {
                            showSuccessMessage('Đã Mở Khóa!', 'Sân đã được mở khóa thành công');
                            loadCourts(stadiumId);
                        },
                        error: function(xhr, status, error) {
                            showErrorMessage('Không thể mở khóa sân. Vui lòng thử lại.');
                        }
                    });
                }
            });
        };
                    // Edit Court Relation Function
                      function validateCourtRelationForm(parentCourtId) {
            const parentId = document.getElementById('parentCourtId').value;
            const parentCourtType = document.getElementById('parentCourtType').value;

            // Lấy tất cả checkbox con đã được checked
            const childCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="childCourt_"]:checked:not([disabled])');
            const childCourtIds = Array.from(childCheckboxes).map(cb => parseInt(cb.value));

            // Khởi tạo mảng quan hệ sân 7
            let court7Relations = [];

            // Nếu sân cha là sân 11, kiểm tra các sân 7 đã chọn và sân 5 tương ứng
            if (parentCourtType === "Bóng đá sân 11") {
                childCourtIds.forEach(courtId => {
                    // Lấy tất cả checkbox sân 5 đã chọn cho sân 7 này
                    const selectedCourt5s = document.querySelectorAll(`input[name="court5_${courtId}"]:checked`);

                    if (selectedCourt5s.length > 0) {
                        // Tạo mảng childCourtIds cho sân 7 này
                        const court5Ids = Array.from(selectedCourt5s).map(cb => parseInt(cb.value));

                        court7Relations.push({
                            parentCourtId: courtId, // Sân 7 làm parent
                            childCourtIds: court5Ids // Mảng sân 5 làm child
                        });
                    }
                });
            }

            console.log('Parent Court ID:', parentId);
            console.log('Child Court IDs:', childCourtIds);
            console.log('Court 7 Relations:', court7Relations);

            return {
                parentCourtId: parseInt(parentId),
                childCourtIds: childCourtIds,
                court7Relations: court7Relations
            };
        }

        // Cập nhật phần gửi AJAX request
                                                   /**
         * HIỂN THỊ CỬA SỔ XEM QUAN HỆ SÂN (CHẾ ĐỘ CHỈ XEM)
         * @@param {number} courtId ID của sân cha
         */
        window.viewCourtRelation = function(courtId) {
            $.ajax({
                url: '/Court/GetAllCourtRelationsByParentId',
                type: 'GET',
                data: { parentId: courtId },
                success: function(courtRelation) {
                    let relations = (courtRelation && courtRelation.length > 0) ? courtRelation : [];

                    $. ajax({
                        url:  '/Court/GetAllCourts',
                        type: 'GET',
                        data:  { stadiumId: stadiumId },
                        success: function(courts) {
                            Swal.fire({
                                title: '<i class="ri-eye-line"></i> Xem Quan Hệ Sân',
                                html: getCourtRelationFormHtml(courtId, relations, courts),
                                showCancelButton: true,
                                showConfirmButton: false,
                                cancelButtonText: '<i class="ri-close-line me-1"></i>Đóng',
                                cancelButtonColor: '#6b7280',
                                width: '1000px',
                                heightAuto: false,
                                customClass: {
                                    popup: 'extra-wide-court-popup view-only-popup',
                                    container: 'extra-wide-container'
                                },
                                padding: '2rem'
                            });

                            // Thêm CSS cho court
                            addLinkedCourtStyles();
                        },
                        error: function() {
                            showErrorMessage('Không thể tải danh sách sân.  Vui lòng thử lại.');
                        }
                    });
                },
                error: function() {
                    showErrorMessage('Không thể lấy thông tin quan hệ sân. Vui lòng thử lại.');
                }
            });
        };

        /**
         * THÊM CSS CHO COURT
         */
        function addLinkedCourtStyles() {
            if (document.getElementById('linked-court-styles')) return;

            const styleElement = document.createElement('style');
            styleElement.id = 'linked-court-styles';
            styleElement.textContent = `
                /* ===== STYLE CHO COURT ĐÃ LIÊN KẾT (MÀU XANH) ===== */
                .court-linked {
                    background:  linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%) ! important;
                    border: 2px solid #0ea5e9 !important;
                    border-radius: 12px ! important;
                    padding: 12px 16px ! important;
                    margin-bottom: 12px !important;
                    box-shadow:  0 2px 8px rgba(14, 165, 233, 0.15) !important;
                    transition: all 0.3s ease !important;
                }

                .court-linked:hover {
                    background: linear-gradient(135deg, #bae6fd 0%, #7dd3fc 100%) !important;
                    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.25) !important;
                    transform: translateY(-2px) !important;
                }

                .court-linked .link-icon {
                    color: #0284c7 !important;
                }

                .linked-badge {
                    background: linear-gradient(135deg, #0ea5e9, #0284c7) !important;
                    color: white ! important;
                    padding: 4px 10px !important;
                    border-radius:  20px !important;
                    font-size:  0.75rem !important;
                    font-weight:  600 !important;
                    display: inline-flex ! important;
                    align-items: center ! important;
                    gap: 4px ! important;
                    box-shadow: 0 2px 4px rgba(14, 165, 233, 0.3) !important;
                }

                /* ===== STYLE CHO COURT CHƯA LIÊN KẾT (MÀU XÁM) ===== */
                .court-not-linked {
                    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%) !important;
                    border: 2px solid #d1d5db ! important;
                    border-radius: 12px !important;
                    padding: 12px 16px ! important;
                    margin-bottom: 12px !important;
                    box-shadow:  0 1px 3px rgba(0, 0, 0, 0.05) !important;
                    transition: all 0.3s ease !important;
                    opacity: 0.8 !important;
                }

                .court-not-linked:hover {
                    background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%) !important;
                    opacity: 1 ! important;
                }

                .court-not-linked .link-icon {
                    color: #9ca3af !important;
                }

                .court-not-linked . court-name {
                    color: #6b7280 ! important;
                }

                .not-linked-badge {
                    background: linear-gradient(135deg, #9ca3af, #6b7280) !important;
                    color: white ! important;
                    padding: 4px 10px !important;
                    border-radius: 20px ! important;
                    font-size: 0.75rem !important;
                    font-weight: 600 !important;
                    display: inline-flex !important;
                    align-items: center !important;
                    gap: 4px !important;
                }

                /* ===== STYLE CHO SÂN 5 TRONG DROPDOWN ===== */
                .court5-linked {
                    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%) !important;
                    border: 1px solid #10b981 !important;
                    border-radius: 8px !important;
                    padding: 8px 12px ! important;
                    margin:  6px 0 ! important;
                }

                .court5-not-linked {
                    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%) !important;
                    border: 1px solid #e5e7eb ! important;
                    border-radius: 8px !important;
                    padding: 8px 12px ! important;
                    margin: 6px 0 !important;
                    opacity: 0.7 !important;
                }

                .linked-badge-small {
                    background:  linear-gradient(135deg, #10b981, #059669) !important;
                    color: white !important;
                    padding: 2px 8px !important;
                    border-radius:  12px !important;
                    font-size:  0.7rem !important;
                    font-weight:  500 !important;
                }

                .not-linked-badge-small {
                    background: linear-gradient(135deg, #9ca3af, #6b7280) !important;
                    color: white !important;
                    padding:  2px 8px !important;
                    border-radius:  12px !important;
                    font-size: 0.7rem !important;
                    font-weight: 500 ! important;
                }

                /* ===== CONTAINER DROPDOWN SÂN 7 ===== */
                .court7-dropdown {
                    background: rgba(255, 255, 255, 0.7) !important;
                    border-radius: 8px !important;
                    padding: 10px ! important;
                    margin-top: 10px ! important;
                    border-left: 3px solid #0ea5e9 ! important;
                }

                .court7-dropdown. not-linked {
                    border-left:  3px solid #d1d5db ! important;
                }

                /* ===== HEADER CỦA GROUP ===== */
                .group-section h6 {
                    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%) !important;
                    padding: 10px 15px !important;
                    border-radius:  8px !important;
                    border-left: 4px solid #0ea5e9 !important;
                }

                /* ===== ANIMATION ===== */
                @@keyframes fadeInUp {
                    from {
                        opacity: 0;
                        transform: translateY(10px);
                    }
                    to {
                        opacity: 1;
                        transform:  translateY(0);
                    }
                }

                .court-linked, .court-not-linked {
                    animation: fadeInUp 0.4s ease forwards;
                }
            `;
            document.head. appendChild(styleElement);
        }

        /**
         * TẠO HTML CHO FORM XEM QUAN HỆ SÂN
         */
        function getCourtRelationFormHtml(parentCourtId, relations, courts) {
            const parentCourt = courts.find(c => c. id === parentCourtId);

            const availableCourts = courts
                .filter(c => c.id !== parentCourtId)
                .filter(c => {
                    if (! ["Bóng đá sân 5", "Bóng đá sân 7", "Bóng đá sân 11"]. includes(c.sportType)) {
                        return false;
                    }
                    if (parentCourt && parentCourt.sportType === "Bóng đá sân 11") {
                        return c.sportType === "Bóng đá sân 7" || c.sportType === "Bóng đá sân 5";
                    }
                    if (parentCourt && parentCourt.sportType === "Bóng đá sân 7") {
                        return c. sportType === "Bóng đá sân 5";
                    }
                    return true;
                });

            const court5Options = courts.filter(c =>
                c.sportType === "Bóng đá sân 5" && c.id !== parentCourtId
            );

            let childCheckboxes = `
                <div id="courtsContainer">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang kiểm tra...</span>
                        </div>
                        <p class="text-muted mt-2 mb-0">Đang kiểm tra trạng thái sân... </p>
                    </div>
                </div>
            `;

            setTimeout(() => {
                loadCourtsAsync(availableCourts, parentCourtId, court5Options, parentCourt);
            }, 100);

            return `
                <div class="text-left">
                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="ri-home-4-line me-1 text-primary"></i>Sân Cha</label>
                        <input type="text" class="form-control bg-light" value="${parentCourt ?  parentCourt.name : ''}" disabled />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="ri-links-line me-1 text-primary"></i>Danh Sách Các Sân Con</label>
                        <div class="border rounded p-3 courts-container" style="max-height: 60vh; overflow-y:  auto; background: #fafafa;">
                            ${childCheckboxes}
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * TẢI DỮ LIỆU VÀ HIỂN THỊ TẤT CẢ CÁC SÂN CON
         */
        async function loadCourtsAsync(availableCourts, parentCourtId, court5Options, parentCourt) {
            const container = document.getElementById('courtsContainer');
            if (!container) return;

            try {
                const courtPromises = availableCourts.map(async (court) => {
                    const response = await $.ajax({
                        url: '/Court/GetAllCourtRelationsByChildId', type: 'GET', data: { childId: court.id }
                    });
                    const allRelations = response || [];
                    const isLinkedToCurrentParent = allRelations.some(r => r.parentCourtId === parentCourtId);
                    return { court:  court, isLinkedToCurrentParent:  isLinkedToCurrentParent };
                });
                const courtResults = await Promise. all(courtPromises);

                const allCourt5Relations = await Promise.all(
                    court5Options.map(async (c5) => {
                        const response = await $. ajax({
                            url: '/Court/GetAllCourtRelationsByChildId', type: 'GET', data: { childId: c5.id }
                        });
                        return { court5Id: c5.id, relations: response || [] };
                    })
                );

                // HÀM HELPER ĐỂ RENDER MỘT SÂN CON (CẢ LIÊN KẾT VÀ CHƯA LIÊN KẾT)
                const renderCourtItem = (result) => {
                    const court = result.court;
                    const isLinked = result.isLinkedToCurrentParent;

                    // Xác định class và style dựa vào trạng thái liên kết
                    const containerClass = isLinked ? 'court-linked' : 'court-not-linked';
                    const iconClass = isLinked ? 'ri-checkbox-circle-fill text-primary' : 'ri-checkbox-blank-circle-line text-muted';
                    const badgeHtml = isLinked
                        ? '<span class="linked-badge"><i class="ri-link"></i> Đã liên kết</span>'
                        :  '<span class="not-linked-badge"><i class="ri-link-unlink"></i> Chưa liên kết</span>';
                    const nameClass = isLinked ? 'fw-bold' : 'fw-bold court-name';

                    // Render dropdown cho sân 7
                    let court7Dropdown = '';
                    if (court.sportType === "Bóng đá sân 7") {
                        const dropdownOptions = court5Options. map(c5 => {
                            const c5RelationData = allCourt5Relations.find(cr => cr.court5Id === c5.id);
                            const isLinkedToThisCourt7 = c5RelationData && c5RelationData.relations.some(r => r.parentCourtId === court.id);

                            // Xác định style cho sân 5
                            const c5ContainerClass = isLinkedToThisCourt7 ? 'court5-linked' : 'court5-not-linked';
                            const c5IconClass = isLinkedToThisCourt7 ?  'ri-checkbox-circle-fill text-success' : 'ri-checkbox-blank-circle-line text-muted';
                            const c5BadgeHtml = isLinkedToThisCourt7
                                ? '<span class="linked-badge-small"><i class="ri-link me-1"></i>Đã liên kết</span>'
                                : '<span class="not-linked-badge-small"><i class="ri-link-unlink me-1"></i>Chưa liên kết</span>';

                            return `
                                <div class="${c5ContainerClass} d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <i class="${c5IconClass} me-2"></i>
                                        <span class="fw-medium">${c5.name}</span>
                                    </div>
                                    ${c5BadgeHtml}
                                </div>`;
                        }).join('');

                        if (dropdownOptions.trim() !== '') {
                            const dropdownClass = isLinked ? 'court7-dropdown' : 'court7-dropdown not-linked';
                            court7Dropdown = `
                                <div class="${dropdownClass}">
                                    <label class="form-label text-muted small mb-2 d-flex align-items-center">
                                        <i class="ri-corner-down-right-line me-1"></i> Sân 5 thuộc ${court.name}:
                                    </label>
                                    <div class="court5-options">${dropdownOptions}</div>
                                </div>`;
                        }
                    }

                    return `
                        <div class="${containerClass}" data-court-id="${court.id}">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <i class="${iconClass} link-icon me-3" style="font-size: 1.5rem;"></i>
                                    <div>
                                        <span class="${nameClass}" style="font-size: 1.05rem;">${court.name}</span>
                                        <small class="text-muted d-block">${court.sportType}</small>
                                    </div>
                                </div>
                                ${badgeHtml}
                            </div>
                            ${court7Dropdown}
                        </div>`;
                };

                // PHÂN NHÓM VÀ RENDER - SẮP XẾP:  ĐÃ LIÊN KẾT LÊN TRƯỚC
                const group7 = courtResults
                    .filter(r => r.court. sportType === "Bóng đá sân 7")
                    .sort((a, b) => (b.isLinkedToCurrentParent ? 1 : 0) - (a.isLinkedToCurrentParent ? 1 : 0));

                const group5 = courtResults
                    .filter(r => r.court. sportType === "Bóng đá sân 5")
                    .sort((a, b) => (b.isLinkedToCurrentParent ? 1 :  0) - (a.isLinkedToCurrentParent ?  1 : 0));

                let finalHtml = '';
                const group7Html = group7.map(renderCourtItem).join('');
                const group5Html = group5.map(renderCourtItem).join('');

                if (group7Html) {
                    finalHtml += `<div class="group-section mb-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3 fw-bold">
                            <i class="ri-layout-grid-line me-1"></i>Sân 7 (Chứa Sân 5)
                        </h6>
                        ${group7Html}
                    </div>`;
                }
                if (group5Html) {
                    finalHtml += `<div class="group-section mb-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3 fw-bold">
                            <i class="ri-football-line me-1"></i>Sân 5 (Trực tiếp)
                        </h6>
                        ${group5Html}
                    </div>`;
                }

                if (finalHtml. trim() === '') {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="ri-information-line" style="font-size: 3rem; color: #d1d5db;"></i>
                            <p class="text-muted mb-0 mt-3 fw-medium">Không có sân con nào khả dụng. </p>
                        </div>`;
                } else {
                    container.innerHTML = finalHtml;
                }

            } catch (error) {
                console.error('❌ Lỗi khi tải dữ liệu sân:', error);
                container. innerHTML = `
                    <div class="text-center py-4 text-danger">
                        <i class="ri-error-warning-line" style="font-size:  2.5rem;"></i>
                        <p class="mb-0 mt-2">Lỗi khi tải danh sách sân</p>
                    </div>`;
            }
        }

            // Helper Functions (your existing helper functions remain the same)
            function getCourtFormHtml(court = null) {
                return `
                    <div class="custom-form-container">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="ri-text me-1"></i>Tên Sân
                            </label>
                            <div class="input-group">
                                <i class="ri-football-line input-icon"></i>
                                <input id="courtName" class="form-control-custom with-icon"
                                       placeholder="Nhập tên sân" maxlength="255"
                                       value="${court ? court.name : ''}">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="ri-basketball-line me-1"></i>Loại Thể Thao
                            </label>
                            <div class="sport-type-grid" id="sportTypeGrid">
                                <div class="sport-option ${court && court.sportType === 'Bóng đá sân 11' ? 'selected' : ''}"
                                     data-value="Bóng đá sân 11">
                                    <i class="ri-football-line"></i>
                                    <div>Bóng đá sân 11</div>
                                </div>
                                <div class="sport-option ${court && court.sportType === 'Bóng đá sân 7' ? 'selected' : ''}"
                                     data-value="Bóng đá sân 7">
                                    <i class="ri-football-line"></i>
                                    <div>Bóng đá sân 7</div>
                                </div>
                                <div class="sport-option ${court && court.sportType === 'Bóng đá sân 5' ? 'selected' : ''}"
                                     data-value="Bóng đá sân 5">
                                    <i class="ri-football-line"></i>
                                    <div>Bóng đá sân 5</div>
                                </div>
                                <div class="sport-option ${court && court.sportType === 'Pickleball' ? 'selected' : ''}"
                                     data-value="Pickleball">
                                    <i class="ri-pickleball-line" style="font-size:24px; color:orange;"></i>
                                    <div>Pickleball</div>
                                </div>
                                <div class="sport-option ${court && court.sportType === 'Bóng rổ' ? 'selected' : ''}"
                                     data-value="Bóng rổ">
                                    <i class="ri-basketball-line"></i>
                                    <div>Bóng rổ</div>
                                </div>
                                <div class="sport-option ${court && court.sportType === 'Tennis' ? 'selected' : ''}"
                                     data-value="Tennis">
                                    <i class="ri-ping-pong-line"></i>
                                    <div>Tennis</div>
                                </div>
                                <div class="sport-option ${court && court.sportType === 'Cầu lông' ? 'selected' : ''}"
                                     data-value="Cầu lông">
                                    <i class="ri-trophy-line"></i>
                                    <div>Cầu lông</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="ri-money-dollar-circle-line me-1"></i>Giá mỗi Giờ (VND)
                            </label>
                            <div class="input-group">
                                <i class="ri-money-dollar-circle-line input-icon"></i>
                                <input id="pricePerHour" class="form-control-custom with-icon"
                                       type="number" step="1000" placeholder="Nhập giá mỗi giờ"
                                       value="${court ? court.pricePerHour : ''}"
                                       oninput="updatePriceDisplay(this.value)">
                            </div>
                            <div class="price-display" id="priceDisplay"></div>
                        </div>

                        <!-- Add metadata display if editing -->
                        ${court ? `
                        <div class="metadata mt-4 pt-3 border-top">
                            <div class="text-muted small">
                                <div><i class="ri-user-line me-1"></i>Tạo bởi: ${court.createdBy || currentUser}</div>
                                <div><i class="ri-time-line me-1"></i>Ngày tạo: ${new Date(court.createdAt || currentDateTime).toLocaleString('vi-VN')}</div>
                                ${court.updatedBy ? `
                                <div><i class="ri-user-line me-1"></i>Cập nhật bởi: ${court.updatedBy}</div>
                                <div><i class="ri-time-line me-1"></i>Ngày cập nhật: ${new Date(court.updatedAt).toLocaleString('vi-VN')}</div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            // Your other helper functions remain the same
            function validateCourtForm(courtId = null) {
                const courtName = document.getElementById('courtName').value;
                const pricePerHour = document.getElementById('pricePerHour').value;

                if (!courtName || courtName.length > 255) {
                    Swal.showValidationMessage('Tên sân bắt buộc và tối đa 255 ký tự.');
                    return false;
                }
                if (!selectedSportType) {
                    Swal.showValidationMessage('Vui lòng chọn loại thể thao.');
                    return false;
                }
                if (!pricePerHour || pricePerHour <= 0) {
                    Swal.showValidationMessage('Giá mỗi giờ phải là số dương.');
                    return false;
                }

                const data = {
                    stadiumId: stadiumId,
                    name: courtName,
                    sportType: selectedSportType,
                    pricePerHour: parseFloat(pricePerHour),
                };

                if (courtId) {
                    data.id = courtId;
                }

                return data;
            }

            function initializeSportTypeGrid() {
                document.querySelectorAll('.sport-option').forEach(option => {
                    option.addEventListener('click', function() {
                        document.querySelectorAll('.sport-option').forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedSportType = this.dataset.value;
                    });
                });
            }

            // function initializeStatusToggle() {
            //     document.querySelectorAll('.status-option').forEach(option => {
            //         option.addEventListener('click', function() {
            //             document.querySelectorAll('.status-option').forEach(opt => {
            //                 opt.classList.remove('active', 'inactive');
            //             });

            //             const isAvailable = this.dataset.value === 'true';
            //             if (isAvailable) {
            //                 this.classList.add('active');
            //             } else {
            //                 this.classList.add('inactive');
            //             }
            //             selectedStatus = isAvailable;
            //         });
            //     });
            // }

                window.updatePriceDisplay = function(value) {
            const priceDisplay = document.getElementById('priceDisplay');
            if (priceDisplay && value && !isNaN(value)) {
                const formattedPrice = Number(value).toLocaleString('vi-VN');
                priceDisplay.textContent = `${formattedPrice} VND`;
                priceDisplay.style.color = '#10b981';
            } else if (priceDisplay) {
                priceDisplay.textContent = '';
            }
        };


            function showSuccessMessage(title, text) {
                Swal.fire({
                    icon: 'success',
                    title: `<i class="ri-check-circle-line"></i> ${title}`,
                    text: text,
                    confirmButtonColor: '#10b981',
                    confirmButtonText: 'Hoàn Tất',
                    timer: 2000,
                    timerProgressBar: true,
                    allowOutsideClick: true,
                    allowEscapeKey: true,
                    showCloseButton: true
                });
            }

            function showErrorMessage(text) {
                Swal.fire({
                    icon: 'error',
                    title: '<i class="ri-error-warning-line"></i> Lỗi',
                    text: text,
                    confirmButtonColor: '#ef4444',
                    allowOutsideClick: true,
                    allowEscapeKey: true,
                    showCloseButton: true
                });
            }
        });
    </script>
</body>
</html>

