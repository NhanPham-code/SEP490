@model DTOs.BookingDTO.ViewModel.BookingManagementViewModel
@using System.Text.Json;
@using DTOs.StadiumDTO

@{
    ViewData["Title"] = "Quản Lý Lịch Đặt Sân";
    var stadiums = ViewBag.Stadiums as List<ReadStadiumDTO> ?? new List<ReadStadiumDTO>();

    var sortedDailyBookings = Model.DailyBookings
        .OrderBy(b => b.Booking.Status.Equals("pending", StringComparison.OrdinalIgnoreCase) ? 0 : 1)
        .ThenByDescending(b => b.Booking.CreatedAt)
        .ToList();

    var sortedMonthlyBookings = Model.MonthlyBookings
        .OrderBy(b => b.MonthlyBooking.Status.Equals("pending", StringComparison.OrdinalIgnoreCase) ? 0 : 1)
        .ThenByDescending(b => b.MonthlyBooking.CreatedAt)
        .ToList();

    var pendingBookings = sortedDailyBookings.Count(b => b.Booking.Status.Equals("pending", StringComparison.OrdinalIgnoreCase)) + sortedMonthlyBookings.Count(mb => mb.MonthlyBooking.Status.Equals("pending", StringComparison.OrdinalIgnoreCase));
    var acceptedBookings = sortedDailyBookings.Count(b => b.Booking.Status.Equals("accepted", StringComparison.OrdinalIgnoreCase)) + sortedMonthlyBookings.Count(mb => mb.MonthlyBooking.Status.Equals("accepted", StringComparison.OrdinalIgnoreCase))
    + sortedDailyBookings.Count(b => b.Booking.Status.Equals("completed", StringComparison.OrdinalIgnoreCase)) + sortedMonthlyBookings.Count(mb => mb.MonthlyBooking.Status.Equals("accepted", StringComparison.OrdinalIgnoreCase));
    var totalRevenue = sortedDailyBookings.Where(b => b.Booking.Status.Equals("completed", StringComparison.OrdinalIgnoreCase) || b.Booking.Status.Equals("completed", StringComparison.OrdinalIgnoreCase)).Sum(b => b.Booking.TotalPrice ?? 0)
                     + sortedMonthlyBookings.Where(mb => mb.MonthlyBooking.Status.Equals("completed", StringComparison.OrdinalIgnoreCase) || mb.MonthlyBooking.Status.Equals("accepted", StringComparison.OrdinalIgnoreCase)).Sum(mb => mb.MonthlyBooking.TotalPrice ?? 0);

    string GetStatusClass(string status) => status.ToLower() switch
    {
        "pending" => "bm-status-pending",
        "accepted" => "bm-status-accepted",
        "completed" => "bm-status-completed",
        "denied" or "cancelled" or "payfail" => "bm-status-cancelled",
        "waiting" => "bm-status-waiting",
        _ => "bm-status-default"
    };

    string TranslateStatus(string status) => status.ToLower() switch
    {
        "pending" => "Chờ xử lý",
        "accepted" => "Đã nhận",
        "completed" => "Đã hoàn thành",
        "cancelled" => "Đã hủy",
        "denied" => "Đã từ chối",
        "waiting" => "Chờ thanh toán",
        "payfail" => "Lỗi thanh toán",
        _ => status
    };

    string GetInitials(string fullName) { if (string.IsNullOrWhiteSpace(fullName)) return "U"; var parts = fullName.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries); return parts.Length > 1 ? $"{parts[0][0]}{parts[parts.Length - 1][0]}".ToUpper() : (fullName.Length > 0 ? $"{fullName[0]}".ToUpper() : "U"); }
}

@section Style {
    <link rel="stylesheet" href="~/css/Booking/BookingManager.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .bm-status-waiting {
            background-color: #e5e7eb;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }
        /* ===== BỔ SUNG CSS CHO CHỨC NĂNG HỦY TÍCH HỢP ===== */
        .bm-child-table th:first-child, .bm-child-table td:first-child {
            width: 40px;
            text-align: center;
        }

        .bm-child-booking-checkbox, .bm-select-all-children {
            transform: scale(1.2);
        }

        .bm-child-cancellation-actions {
            padding: 1rem 1.5rem;
            text-align: right;
            border-top: 1px solid #e5e7eb;
            background-color: #f9fafb;
        }

        .bm-confirm-child-cancel-btn {
            background-color: #dc2626;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }

            .bm-confirm-child-cancel-btn:hover {
                background-color: #b91c1c;
            }

            .bm-confirm-child-cancel-btn:disabled {
                background-color: #fca5a5;
                cursor: not-allowed;
            }

        .cancellation-summary-text {
            font-size: 0.9em;
            color: #4b5563;
            margin-right: 1rem;
        }

        /* ===== CSS CHO GIAO DIỆN THANH TOÁN MỚI ===== */
        .bm-pricing-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Khoảng cách giữa các dòng */
            font-size: 1rem;
        }

        .bm-pricing-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .bm-pricing-line .label {
                color: #4b5563; /* Gray-600 */
            }

            .bm-pricing-line .value {
                font-weight: 600;
                color: #1f2937; /* Gray-800 */
            }

        .bm-pricing-divider {
            border: none;
            border-top: 1px solid #e5e7eb; /* Gray-200 */
            margin: 0.5rem 0;
        }

        .bm-pricing-line.bm-total .label {
            font-size: 1.125rem; /* text-lg */
            font-weight: 700;
            color: #111827; /* Gray-900 */
        }

        .bm-pricing-line.bm-total .value {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700;
            color: #1d4ed8; /* Blue-700 */
        }
    </style>
}

<div class="bm-container">
    <h1 style="font-weight: 800; font-size: 2.5rem; margin-bottom: 2rem;">Quản Lý Lịch Đặt Sân</h1>

    <div class="bm-stats-grid" style="margin-bottom: 2rem;">
        <div class="bm-stat-card bm-yellow"><div class="bm-stat-header">Lịch chờ xử lý</div><div class="bm-stat-value">@pendingBookings</div></div>
        <div class="bm-stat-card bm-blue"><div class="bm-stat-header">Lịch đã nhận</div><div class="bm-stat-value">@acceptedBookings</div></div>
        <div class="bm-stat-card bm-green"><div class="bm-stat-header">Tổng doanh thu</div><div class="bm-stat-value">@totalRevenue.ToString("N0")₫</div></div>
        <div class="bm-stat-card bm-teal"><div class="bm-stat-header">Sân vận động</div><div class="bm-stat-value">@stadiums.Count</div></div>
    </div>

    <div class="bm-filter-section">
        <div class="bm-filter-group">
            <label for="bm-stadiumFilter">Lọc theo sân:</label>
            <select id="bm-stadiumFilter">
                <option value="all">Tất cả các sân</option>
                @foreach (var stadium in stadiums)
                {
                    <option value="@stadium.Id">@stadium.Name</option>
                }
            </select>
        </div>
        <div class="bm-filter-group">
            <label for="bm-bookingTypeFilter">Loại lịch đặt:</label>
            <select id="bm-bookingTypeFilter">
                <option value="all">Tất cả các loại</option>
                <option value="daily">Lịch Hằng Ngày</option>
                <option value="monthly">Lịch Hằng Tháng</option>
            </select>
        </div>
        <div class="bm-filter-group">
            <label for="bm-statusFilter">Trạng thái:</label>
            <select id="bm-statusFilter">
                <option value="all">Tất cả các trạng thái</option>
                <option value="pending">Chờ xử lý</option>
                <option value="accepted">Đã nhận</option>
                <option value="completed">Đã hoàn thành</option>
                <option value="waiting">Chờ thanh toán</option>
                <option value="cancelled-group">Đã hủy / Lỗi</option>
            </select>
        </div>
    </div>

    <div class="bm-booking-section" id="bm-daily-booking-section">
        <div class="bm-section-header">
            <h2 class="bm-section-title">Lịch Đặt Hằng Ngày</h2>
            <div class="bm-filter-group bm-date-filter-container">
                <label for="bm-dateFilter"><i class="fas fa-calendar-alt"></i> Ngày chơi:</label>
                <input type="date" id="bm-dateFilter" placeholder=" " />
                <button class="bm-clear-date-btn" title="Xóa ngày">&times;</button>
            </div>
        </div>
        <div style="overflow-x: auto;">
            <table class="bm-booking-table">
                <thead><tr><th class="bm-align-left">Khách hàng / Sân</th><th>Ngày chơi</th><th>Ngày tạo</th><th>Giá tiền</th><th>Trạng thái</th><th>Hành động</th></tr></thead>
                <tbody>
                    @if (sortedDailyBookings.Any())
                    {
                        @foreach (var dailyVm in sortedDailyBookings)
                        {
                            var booking = dailyVm.Booking;
                            var user = dailyVm.User;
                            var stadium = stadiums.FirstOrDefault(s => s.Id == booking.StadiumId);
                            <tr data-stadium-id="@booking.StadiumId" data-booking-type="daily" data-play-date="@booking.Date.ToString("yyyy-MM-dd")" data-status="@booking.Status.ToLower()">
                                <td class="bm-align-left">
                                    <div class="bm-customer-info">
                                        <div class="bm-customer-avatar">
                                            @if (!string.IsNullOrEmpty(user.AvatarUrl))
                                            {
                                                <img src="https://localhost:7136/@user.AvatarUrl" alt="@user.FullName" />
                                            }
                                            else
                                            {
                                                <span>@GetInitials(user.FullName)</span>
                                            }
                                        </div>
                                        <div class="bm-customer-details">
                                            <span class="bm-customer-name">@user.FullName</span>
                                            <span class="bm-stadium-name">@stadium?.Name</span>
                                        </div>
                                    </div>
                                </td>
                                <td>@booking.Date.ToString("dd/MM/yyyy")</td>
                                <td>@booking.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                <td><span class="bm-price">@((booking.TotalPrice ?? 0).ToString("N0"))₫</span></td>
                                <td><span class="bm-status-badge @GetStatusClass(booking.Status)">@TranslateStatus(booking.Status)</span></td>
                                <td class="bm-actions">
                                    <button class="bm-action-btn details" title="Xem chi tiết" data-booking-id="@booking.Id" data-booking-type="daily"><i class="fas fa-eye"></i></button>
                                    @if (booking.Status.Equals("pending", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="bm-action-btn accept" title="Chấp nhận" data-booking-id="@booking.Id" data-booking-type="daily"><i class="fas fa-check"></i></button> <button class="bm-action-btn deny" title="Từ chối" data-booking-id="@booking.Id" data-booking-type="daily"><i class="fas fa-times"></i></button>
                                    }
                                    @if (booking.Status.Equals("accepted", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="bm-action-btn cancel" title="Hủy lịch" data-booking-id="@booking.Id" data-booking-type="daily"><i class="fas fa-ban"></i></button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="6"><div class="no-data"><p>Không có lịch đặt hằng ngày nào.</p></div></td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="bm-booking-section" id="bm-monthly-booking-section">
        <div class="bm-section-header"> <h2 class="bm-section-title">Lịch Đặt Hằng Tháng</h2> </div>
        <div style="overflow-x: auto;">
            <table class="bm-booking-table">
                <thead><tr><th style="width: 50px;"></th><th class="bm-align-left">Khách hàng / Sân</th><th>Khung giờ / Thời gian</th><th>Ngày tạo</th><th>Giá tiền</th><th>Trạng thái</th><th>Hành động</th></tr></thead>
                <tbody>
                    @if (sortedMonthlyBookings.Any())
                    {
                        @foreach (var monthlyVm in sortedMonthlyBookings)
                        {
                            var booking = monthlyVm.MonthlyBooking;
                            var user = monthlyVm.User;
                            var stadium = stadiums.FirstOrDefault(s => s.Id == booking.StadiumId);
                            <tr class="bm-monthly-parent-row" data-stadium-id="@booking.StadiumId" data-booking-type="monthly" data-monthly-id="@booking.Id" data-status="@booking.Status.ToLower()">
                                <td><i class="fas fa-chevron-down bm-expand-toggle"></i></td>
                                <td class="bm-align-left">
                                    <div class="bm-customer-info">
                                        <div class="bm-customer-avatar">
                                            @if (!string.IsNullOrEmpty(user.AvatarUrl))
                                            {
                                                <img src="https://localhost:7136/@user.AvatarUrl" alt="@user.FullName" />
                                            }
                                            else
                                            {
                                                <span>@GetInitials(user.FullName)</span>
                                            }
                                        </div>
                                        <div class="bm-customer-details">
                                            <span class="bm-customer-name">@user.FullName</span>
                                            <span class="bm-stadium-name">@stadium?.Name</span>
                                        </div>
                                    </div>
                                </td>
                                <td><div style="display: flex; flex-direction: column; align-items: center;"><span style="font-weight: 600;">@booking.StartTime.ToString(@"hh\:mm") - @booking.EndTime.ToString(@"hh\:mm")</span><span style="font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem;">Tháng @booking.Month / @booking.Year</span></div></td>
                                <td>@booking.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                <td><span class="bm-price">@((booking.TotalPrice ?? 0).ToString("N0"))₫</span></td>
                                <td><span class="bm-status-badge @GetStatusClass(booking.Status)">@TranslateStatus(booking.Status)</span></td>
                                <td class="bm-actions">
                                    <button class="bm-action-btn details" title="Xem chi tiết" data-booking-id="@booking.Id" data-booking-type="monthly"><i class="fas fa-eye"></i></button>
                                    @if (booking.Status.Equals("pending", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="bm-action-btn accept" title="Chấp nhận" data-booking-id="@booking.Id" data-booking-type="monthly"><i class="fas fa-check"></i></button> <button class="bm-action-btn deny" title="Từ chối" data-booking-id="@booking.Id" data-booking-type="monthly"><i class="fas fa-times"></i></button>
                                    }
                                </td>
                            </tr>
                            <tr class="bm-child-bookings-row" data-parent-monthly-id="@booking.Id" style="display:none;">
                                <td colspan="7">
                                    <div class="bm-child-table-container">
                                        <h4>Các Lịch Đặt Chi Tiết</h4>
                                        @if (monthlyVm.Bookings.Any())
                                        {
                                            <table class="bm-child-table">
                                                <thead>
                                                    <tr>
                                                        <th><input type="checkbox" class="bm-select-all-children" title="Chọn tất cả" /></th>
                                                        <th>Ngày Chơi</th>
                                                        <th>Sân Con</th>
                                                        <th>Thời Gian</th>
                                                        <th>Giá tiền</th>
                                                        <th>Trạng Thái</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var childBooking in monthlyVm.Bookings.OrderBy(b => b.Date))
                                                    {
                                                        var isCancellable = !childBooking.Status.Equals("completed", StringComparison.OrdinalIgnoreCase) && !childBooking.Status.Equals("cancelled", StringComparison.OrdinalIgnoreCase);
                                                        <tr style="@(isCancellable ? "" : "color: #9ca3af;")">
                                                            <td><input type="checkbox" class="bm-child-booking-checkbox" value="@childBooking.Id" data-price="@childBooking.TotalPrice" @(isCancellable ? "" : "disabled")></td>
                                                            <td>@childBooking.Date.ToString("dd/MM/yyyy")</td>
                                                            <td>@string.Join(", ", childBooking.BookingDetails.Select(d => d.CourtName))</td>
                                                            <td>@if (childBooking.BookingDetails.Any())
                                                                {
                                                                    <span>@childBooking.BookingDetails.First().StartTime.ToString("HH:mm") - @childBooking.BookingDetails.First().EndTime.ToString("HH:mm")</span>
                                                                }</td>
                                                            <td class="bm-price">@((childBooking.TotalPrice ?? 0).ToString("N0"))₫</td>
                                                            <td><span class="bm-status-badge @GetStatusClass(childBooking.Status)">@TranslateStatus(childBooking.Status)</span></td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                            <div class="bm-child-cancellation-actions">
                                                <span class="cancellation-summary-text">Đã chọn: <b class="selected-count">0</b> | Phí hủy: <b class="cancellation-fee">0₫</b></span>
                                                <button class="bm-confirm-child-cancel-btn" disabled>Hủy <span class="selected-count">0</span> mục đã chọn</button>
                                            </div>
                                        }
                                        else
                                        {
                                            <p style="text-align:center; padding: 1rem;">Không có lịch đặt chi tiết nào cho tháng này.</p>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="7"><div class="no-data"><p>Không có lịch đặt hằng tháng nào.</p></div></td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="bm-modal-backdrop" id="bm-bookingDetailModal">
    <div class="bm-modal-content">
        <div class="bm-modal-header" id="bm-modalHeader"></div>
        <div class="bm-modal-body" id="bm-modalBodyContent"></div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/BookingManager.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const viewModel = {
                dailyBookings: @Html.Raw(JsonSerializer.Serialize(sortedDailyBookings, new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase })),
                monthlyBookings: @Html.Raw(JsonSerializer.Serialize(sortedMonthlyBookings, new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase }))
            };
            const stadiums = @Html.Raw(JsonSerializer.Serialize(stadiums));
            initializeBookingManager(viewModel, stadiums);
        });
    </script>
}