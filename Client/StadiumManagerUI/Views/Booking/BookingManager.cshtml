@model DTOs.BookingDTO.ViewModel.BookingManagementViewModel
@using System.Text.Json
@using DTOs.StadiumDTO

@{
    ViewData["Title"] = "Quản Lý Lịch Đặt Sân";
    var stadiums = ViewBag.Stadiums as List<ReadStadiumDTO> ?? new List<ReadStadiumDTO>();
    int currentYear = DateTime.UtcNow.Year;
}

@section Style {
    <link rel="stylesheet" href="~/css/Booking/BookingManager.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS cho phân trang */
        .bm-pagination-container {
            text-align: center;
            margin-top: 1.5rem;
        }

        .bm-pagination {
            display: inline-block;
            padding-left: 0;
            margin: 20px 0;
            border-radius: 4px;
        }

            .bm-pagination > li {
                display: inline;
            }

                .bm-pagination > li > a, .bm-pagination > li > span {
                    position: relative;
                    float: left;
                    padding: 6px 12px;
                    margin-left: -1px;
                    line-height: 1.42857143;
                    color: #1d4ed8;
                    text-decoration: none;
                    background-color: #fff;
                    border: 1px solid #ddd;
                }

                    .bm-pagination > li > a:hover, .bm-pagination > li > span:hover {
                        z-index: 2;
                        color: #1e40af;
                        background-color: #eee;
                        border-color: #ddd;
                    }

            .bm-pagination > .active > a, .bm-pagination > .active > span {
                z-index: 3;
                color: #fff;
                cursor: default;
                background-color: #1d4ed8;
                border-color: #1d4ed8;
            }

            .bm-pagination > .disabled > span, .bm-pagination > .disabled > a {
                color: #777;
                cursor: not-allowed;
                background-color: #fff;
                border-color: #ddd;
            }

        /* Style cho form lọc mới */
        .bm-filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem 2rem;
            align-items: flex-end;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .bm-filter-group {
            display: flex;
            flex-direction: column;
        }

            .bm-filter-group label {
                margin-bottom: 0.5rem;
                font-weight: 600;
                color: #374151;
            }

            .bm-filter-group select, .bm-filter-group input {
                min-width: 180px;
                padding: 0.5rem;
                border-radius: 0.375rem;
                border: 1px solid #d1d5db;
            }

        #bm-apply-filter-btn {
            background-color: #16a34a;
            color: white;
            margin-bottom: 0;
            border: none;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-radius: 0.375rem;
        }

            #bm-apply-filter-btn:hover {
                background-color: #15803d;
            }


        /* Các style khác giữ nguyên từ file gốc của bạn */
        .bm-header-with-action {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .bm-create-booking-btn {
            background-color: #1d4ed8;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }

            .bm-create-booking-btn:hover {
                background-color: #1e40af;
            }

        .bm-stat-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border-top: 5px solid transparent; /* Viền trong suốt mặc định */
        }

            .bm-stat-card.bm-red {
                border-top-color: #ef4444; /* Màu đỏ cho thẻ "Hủy" */
            }

            .bm-stat-card.bm-blue {
                border-top-color: #3b82f6; /* Màu xanh dương */
            }

            .bm-stat-card.bm-green {
                border-top-color: #22c55e; /* Màu xanh lá */
            }

            .bm-stat-card.bm-teal {
                border-top-color: #14b8a6; /* Màu xanh mòng két */
            }
    </style>
}

<div class="bm-container">
    <div class="bm-header-with-action">
        <h1 style="font-weight: 800; font-size: 2.5rem; margin: 0;">Quản Lý Lịch Đặt Sân</h1>
        <a asp-controller="Booking" asp-action="CreateBooking" class="bm-create-booking-btn">
            <i class="fas fa-plus"></i> Tạo Lịch Đặt Mới
        </a>
    </div>

    <!-- Thống kê: "Lịch chờ xử lý" đã được thay bằng "Lịch đã hủy" -->
    <div class="bm-stats-grid" style="margin-bottom: 2rem;">
        <div class="bm-stat-card bm-red"><div class="bm-stat-header">Lịch đã hủy (Tháng này)</div><div class="bm-stat-value">@ViewBag.CancelledBookingsThisMonth</div></div>
        <div class="bm-stat-card bm-blue"><div class="bm-stat-header">Lịch đã nhận (Tháng này)</div><div class="bm-stat-value">@ViewBag.AcceptedBookingsThisMonth</div></div>
        <div class="bm-stat-card bm-green"><div class="bm-stat-header">Doanh thu (Tháng này)</div><div class="bm-stat-value">@(((decimal)(ViewBag.TotalRevenueThisMonth ?? 0m)).ToString("N0"))₫</div></div>
        <div class="bm-stat-card bm-teal"><div class="bm-stat-header">Sân vận động</div><div class="bm-stat-value">@stadiums.Count</div></div>
    </div>

    <!-- KHU VỰC LỌC MỚI -->
    <form class="bm-filter-section" id="bm-main-filter-form" method="get">
        <div class="bm-filter-group">
            <label for="bm-bookingTypeFilter">Loại lịch đặt:</label>
            <select id="bm-bookingTypeFilter" name="type">
                <option value="daily" selected>Lịch Hằng Ngày</option>
                <option value="monthly">Lịch Hằng Tháng</option>
            </select>
        </div>
        <div class="bm-filter-group">
            <label for="bm-stadiumFilter">Sân:</label>
            <select id="bm-stadiumFilter" name="stadiumId">
                <option value="">Tất cả các sân</option>
                @foreach (var stadium in stadiums)
                {
                    <option value="@stadium.Id" selected="@(stadium.Id == ViewBag.CurrentStadiumId ? "selected" : null)">@stadium.Name</option>
                }
            </select>
        </div>
        <div class="bm-filter-group">
            <label for="bm-statusFilter">Trạng thái:</label>
            <select id="bm-statusFilter" name="status">
                <option value="all" selected="@("all" == ViewBag.CurrentStatus ? "selected" : null)">Tất cả</option>
                <option value="accepted" selected="@("accepted" == ViewBag.CurrentStatus ? "selected" : null)">Đã nhận</option>
                <option value="completed" selected="@("completed" == ViewBag.CurrentStatus ? "selected" : null)">Đã hoàn thành</option>
                <option value="waiting" selected="@("waiting" == ViewBag.CurrentStatus ? "selected" : null)">Chờ thanh toán</option>
                <option value="cancelled-group" selected="@("cancelled-group" == ViewBag.CurrentStatus ? "selected" : null)">Đã hủy / Lỗi</option>
            </select>
        </div>
        <div class="bm-filter-group">
            <label for="bm-monthFilter">(Ngày chơi)Tháng:</label>
            <select id="bm-monthFilter" name="filterMonth">
                <option value="0">Tất cả</option>
                @for (int i = 1; i <= 12; i++)
                {
                    <option value="@i" selected="@(i == ViewBag.CurrentFilterMonth ? "selected" : null)">Tháng @i</option>
                }
            </select>
        </div>
        <div class="bm-filter-group">
            <label for="bm-yearFilter">(Ngày chơi)Năm:</label>
            <select id="bm-yearFilter" name="filterYear">
                <option value="0">Tất cả</option>
                @for (int i = currentYear - 3; i <= currentYear + 1; i++)
                {
                    <option value="@i" selected="@(i == ViewBag.CurrentFilterYear ? "selected" : null)">Năm @i</option>
                }
            </select>
        </div>
        <div class="bm-filter-group">
            <button id="bm-apply-filter-btn" type="submit" class="bm-create-booking-btn"><i class="fas fa-filter"></i> Lọc</button>
        </div>
    </form>

    <!-- Container để cập nhật AJAX -->
    <div id="booking-tables-container">
        @await Html.PartialAsync("_BookingTablesPartial", Model)
    </div>
</div>

<div class="bm-modal-backdrop" id="bm-bookingDetailModal">
    <div class="bm-modal-content">
        <div class="bm-modal-header" id="bm-modalHeader"></div>
        <div class="bm-modal-body" id="bm-modalBodyContent"></div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/BookingManager.js" asp-append-version="true"></script>
}