@{
    ViewData["Title"] = "Quản lý Mã giảm giá";
}

<! DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link href="https://cdnjs. cloudflare.com/ajax/libs/font-awesome/6. 0.0/css/all. min.css" rel="stylesheet">

    <link href="~/css/Discount/discount.css" rel="stylesheet" />
</head>
<body>
    <div class="discount-management-container">
        <div class="page-container">
            <div class="page-header">
                <h1 class="page-title">Quản lý Mã giảm giá</h1>
                <button class="create-btn" onclick="openDiscountModal()">
                    <i class="fas fa-plus"></i> Tạo Mã Mới
                </button>
            </div>

            <div class="filters-card">
                <div class="filter-row">
                    <div class="form-group">
                        <label class="form-label">Tìm kiếm mã giảm giá</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Tìm theo mã... ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sân vận động</label>
                        <select class="form-control" id="stadiumFilter">
                            <option value="">Tất cả sân</option>
                            <!-- Options will be added by JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Trạng thái</label>
                        <select class="form-control" id="statusFilter">
                            <option value="">Tất cả</option>
                            <option value="true">Mở</option> <!-- Đã sửa nhãn -->
                            <option value="false">Khóa</option> <!-- Đã sửa nhãn -->
                        </select>
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn" onclick="applyFilters()">
                            <i class="fas fa-search"></i> Tìm kiếm
                        </button>
                        <button class="reset-btn" onclick="resetFilters()">
                            <i class="fas fa-undo-alt"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="discounts-container">
                <div class="table-header">
                    <h3 class="table-title">Danh sách mã giảm giá</h3>
                    <span class="results-count" id="resultsCount">Đang tải...</span>
                </div>
                <table class="discount-table">
                    <thead>
                        <tr>
                            <th>Mã</th>
                            <th>Giá trị</th>
                            <th>Thời gian áp dụng</th>
                            <th>Loại</th>
                            <th>Đối tượng áp dụng</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="discountTableBody">
                        <!-- Data will be rendered by JS -->
                    </tbody>
                </table>
                <div class="pagination-container" id="paginationControls">
                    <!-- Pagination will be rendered by JS -->
                </div>
            </div>
        </div>

        <!-- Modal HTML -->
        <div class="modal-overlay" id="discountModal">
            <div class="modal modal-wide">
                <div class="modal-header">
                    <h2 class="modal-title" id="modalTitle">Tạo Mã Mới</h2>
                    <button class="modal-close" onclick="closeDiscountModal()"><i class="fas fa-times"></i></button>
                </div>
                <form id="discountForm">
                    <input type="hidden" id="discountId" />
                    <div class="form-section">
                        <h3 class="section-title"><i class="fas fa-info-circle"></i> Thông tin cơ bản</h3>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Mã Discount *</label><input type="text" class="form-control" id="discountCode" required></div>
                            <div class="form-group">
                                <label class="form-label">Loại Discount *</label>
                                <select class="form-control" id="codeType" required onchange="toggleSections()">
                                    <option value="">Chọn loại</option>
                                    <option value="Stadium">Mã theo sân</option>
                                    <option value="Unique">Mã cá nhân</option>
                                </select>
                            </div>
                            <div class="form-group"><label class="form-label">Giá trị giảm (%) *</label><input type="number" class="form-control" id="percentValue" min="1" max="100" step="1" required> </div>
                            <div class="form-group"><label class="form-label">Số tiền giảm tối đa</label><input type="number" class="form-control" id="maxDiscountAmount" min="0">
                                <small class="form-text text-muted" style="font-size: 0.8rem; color: #6b7280; font-style: italic;">
                                    * Nhập 0 để không giới hạn số tiền giảm.
                                </small>
                            </div>
                            <div class="form-group"><label class="form-label">Giá trị đơn hàng tối thiểu</label><input type="number" class="form-control" id="minOrderAmount" min="0"></div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Ngày bắt đầu *</label><input type="date" class="form-control" id="startDate" required></div>
                            <div class="form-group"><label class="form-label">Ngày kết thúc *</label><input type="date" class="form-control" id="endDate" required></div>
                        </div>
                        <div class="form-group form-group-full"><label class="form-label">Mô tả</label><textarea class="form-control" id="description"></textarea></div>
                    </div>

                    <div class="form-section" id="userSelectionSection" style="display:none;">
                        <h3 class="section-title"><i class="fas fa-user"></i> Chọn người dùng mục tiêu</h3>
                        <div class="user-search-container">
                            <div class="user-search-bar">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="userSearchInput" class="form-control" placeholder="Nhập SĐT hoặc Email để tìm... ">
                                <button type="button" class="search-btn" onclick="searchUsers()">
                                    <i class="fas fa-search"></i> Tìm kiếm
                                </button>
                            </div>
                            <div class="user-search-info">Nhập thông tin và nhấn tìm kiếm để hiển thị kết quả</div>
                        </div>
                        <div class="user-selection-grid" id="userSelectionResults">
                            <!-- User search results will be rendered here -->
                        </div>
                    </div>

                    <div class="form-section" id="stadiumSelectionSection" style="display:none;">
                        <h3 class="section-title"><i class="fas fa-futbol"></i> Chọn sân vận động áp dụng</h3>
                        <div class="stadium-actions">
                            <button type="button" class="btn-select-all" onclick="selectAllStadiums(true)">
                                <i class="fas fa-check-double"></i> Chọn tất cả
                            </button>
                            <span class="selected-count" id="stadiumsSelectedCount">0 sân được chọn</span>
                            <button type="button" class="btn-deselect-all" onclick="selectAllStadiums(false)">
                                <i class="fas fa-times"></i> Bỏ chọn tất cả
                            </button>
                        </div>
                        <div class="stadium-grid" id="stadiumSelectionGroup">
                            <!-- Stadiums will be added by JS -->
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" onclick="closeDiscountModal()">Hủy</button>
                        <button type="submit" class="btn-save"><i class="fas fa-save"></i> <span id="saveButtonText">Lưu</span></button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="statusPopup" class="status-popup-overlay" style="display: none;">
        <div class="status-popup">
            <div class="status-icon-box">
                <i id="statusIcon" class="fas fa-spinner fa-spin"></i>
            </div>
            <!-- Đây là 2 cái ID mà code đang tìm nhưng chưa thấy -->
            <h3 id="statusTitle">Đang xử lý</h3>
            <p id="statusMessage">Vui lòng đợi trong giây lát...</p>
        </div>
    </div>

    <!-- Popup Xác nhận (Yes/No) -->
    <div id="confirmPopup" class="status-popup-overlay" style="display: none;">
        <div class="status-popup">
            <div class="status-icon-box">
                <i class="fas fa-question-circle" style="color: #f59e0b;"></i>
            </div>
            <h3 id="confirmTitle">Xác nhận</h3>
            <p id="confirmMessage">Bạn có chắc chắn muốn thực hiện?</p>
            <div class="modal-actions" style="justify-content: center; margin-top: 20px;">
                <button class="btn-cancel" onclick="closeConfirmPopup(false)">Hủy</button>
                <button class="btn-save" id="btnConfirmYes" style="background-color: #3b82f6;">Đồng ý</button>
            </div>
        </div>
    </div>

    @section Scripts {
        <script>
            // === STATE MANAGEMENT ===
            let allStadiums = [];
            let allUsers = [];
            let currentEditingId = null;
            let currentPage = 1;
            let pageSize = 5;
            let currentDiscounts = [];
            let userSearchTimeout;
            let confirmCallback = null;

            // === INITIALIZATION ===
            document.addEventListener('DOMContentLoaded', function () {
                fetchAndRenderDiscounts();
                document.getElementById('discountForm').addEventListener('submit', handleFormSubmit);
                document. getElementById('startDate').addEventListener('change', handleStartDateChange);
                document.getElementById('endDate').addEventListener('change', validateDates);
                document.getElementById('userSearchInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchUsers();
                    }
                });
            });

            // === HELPER FUNCTION: Lấy ngày hôm nay theo format YYYY-MM-DD ===
            function getTodayDate() {
                return new Date().toISOString(). slice(0, 10);
            }

            // === HELPER FUNCTION: Set min date cho các input ===
            function setMinDates() {
                const today = getTodayDate();
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');

                startDateInput.setAttribute('min', today);
                endDateInput.setAttribute('min', today);
            }

            // === HELPER FUNCTION: Xử lý khi thay đổi ngày bắt đầu ===
            function handleStartDateChange() {
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                const today = getTodayDate();

                // Cập nhật min của endDate = max(today, startDate)
                const startDateValue = startDateInput.value;
                if (startDateValue && startDateValue > today) {
                    endDateInput.setAttribute('min', startDateValue);
                } else {
                    endDateInput.setAttribute('min', today);
                }

                // Nếu endDate < startDate thì reset endDate
                if (endDateInput.value && endDateInput.value < startDateValue) {
                    endDateInput.value = startDateValue;
                }

                validateDates();
            }

            // === DATA FETCHING & RENDERING ===
            function fetchAndRenderDiscounts(page = 1) {
                currentPage = page;

                // Lấy giá trị và trim khoảng trắng để an toàn
                const searchCode = document.getElementById('searchInput').value.trim();
                const stadiumId = document.getElementById('stadiumFilter').value;
                const status = document.getElementById('statusFilter').value;

                let query = `?page=${currentPage}&pageSize=${pageSize}`;

                if (searchCode) query += `&searchByCode=${encodeURIComponent(searchCode)}`;
                if (stadiumId) query += `&stadiumId=${stadiumId}`;

                // LOGIC FILTER TRẠNG THÁI
                // ASP.NET Core sẽ tự map chuỗi "true"/"false" sang bool
                if (status && status !== "") {
                    query += `&isActive=${status}`;
                }

                setLoadingState(true);

                fetch(`/Discount/GetDiscountPageData${query}`)
                    .then(response => {
                        if (!response.ok) throw new Error(response.statusText);
                        return response.json();
                    })
                    .then(data => {
                         let processedDiscounts = data.discounts;

                        // 2. THÊM LOGIC: Nếu đang lọc "Mở" (true), dùng JS loại bỏ các mã đã hết hạn
                        // (Vì server chỉ trả về isActive=true nhưng có thể bao gồm cả mã hết hạn)
                        if (status === 'true') {
                            processedDiscounts = processedDiscounts.filter(d => {
                                const isExpired = new Date() > new Date(d.endDate);
                                // Giữ lại nếu: isActive là true VÀ chưa hết hạn
                                return d.isActive && !isExpired;
                            });
                        }


                         currentDiscounts = processedDiscounts;


                        // Load danh sách sân nếu chưa có (cho dropdown filter)
                        if (allStadiums.length === 0 && data.stadiums) {
                            allStadiums = data.stadiums;
                            renderFilterOptions(allStadiums);
                            renderStadiumSelectionModal(allStadiums);
                        }

                        // Cache user data nếu có
                        if (data.targetUsers && data.targetUsers.length > 0) {
                            cacheUserData(data.targetUsers);
                        }

                        renderTable(currentDiscounts);
                        renderPagination(currentDiscounts.length); // Hoặc dùng data.count nếu API trả về tổng số bản ghi
                    })
                    .catch(error => {
                        console.error('Lỗi tải dữ liệu:', error);
                        document.getElementById('discountTableBody').innerHTML = `<tr><td colspan="7" class="text-center text-danger">Lỗi tải dữ liệu. Vui lòng thử lại.</td></tr>`;
                        document.getElementById('resultsCount').textContent = 'Lỗi';
                    })
                    .finally(() => setLoadingState(false));
            }

            function setLoadingState(isLoading) {
                const tableBody = document.getElementById('discountTableBody');
                const resultsCount = document.getElementById('resultsCount');
                if (isLoading) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Đang tải...</td></tr>';
                    resultsCount.textContent = 'Đang tải...';
                }
            }

            function renderTable(discounts) {
                const tableBody = document.getElementById('discountTableBody');
                const resultsCount = document.getElementById('resultsCount');
                tableBody.innerHTML = '';
                if (! discounts || discounts.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 20px;">Không tìm thấy discount nào phù hợp.</td></tr>`;
                    resultsCount.textContent = 'Tìm thấy 0 kết quả';
                } else {
                    discounts.forEach(d => tableBody.appendChild(createTableRow(d)));
                    resultsCount.textContent = `Hiển thị ${discounts.length} kết quả`;
                }
            }

            function renderPagination(currentItemCount) {
                const container = document.getElementById('paginationControls');
                container.innerHTML = '';
                const hasPrevious = currentPage > 1;
                const hasNext = currentItemCount === pageSize;
                if (! hasPrevious && !hasNext) return;
                container.innerHTML = `
                    <button class="pagination-btn" onclick="fetchAndRenderDiscounts(${currentPage - 1})" ${! hasPrevious ? 'disabled' : ''}>
                        <i class="fas fa-chevron-left"></i> Trước
                    </button>
                    <span class="pagination-info">Trang ${currentPage}</span>
                    <button class="pagination-btn" onclick="fetchAndRenderDiscounts(${currentPage + 1})" ${! hasNext ? 'disabled' : ''}>
                        Sau <i class="fas fa-chevron-right"></i>
                    </button>
                `;
            }

            function applyFilters() { fetchAndRenderDiscounts(1); }
            function resetFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('stadiumFilter').value = '';
                document.getElementById('statusFilter').value = '';
                fetchAndRenderDiscounts(1);
            }

            function createTableRow(discount) {
                const tr = document.createElement('tr');
                tr.id = `discount-row-${discount.id}`;
                const isExpired = new Date() > new Date(discount.endDate);
                const isActive = discount.isActive && !isExpired;
                const statusClass = isActive ? 'status-active' : 'status-inactive';
                const statusText = isActive ? 'Mở' : 'Khóa';
                const remainingDays = Math.ceil((new Date(discount.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                const codeTypeLabels = { 'Stadium': 'Mã theo sân', 'Unique': 'Mã cá nhân' };
                const codeTypeDisplay = codeTypeLabels[discount.codeType] || discount.codeType;

                let targetDisplay = '';
                const hasStadiums = discount.stadiumIds && discount.stadiumIds.length > 0;
                const stadiumTag = hasStadiums
                    ? `<span class="stadium-tag">${discount.stadiumIds.length} sân</span>`
                    : `<span class="stadium-tag" style="background: var(--danger-red);">Chưa áp dụng</span>`;

                if (discount.codeType === 'Stadium') {
                    targetDisplay = stadiumTag;
                } else if (discount.codeType === 'Unique') {
                    targetDisplay = `<div class="target-display-flex">${stadiumTag}</div>`;
                } else {
                    targetDisplay = '<span class="stadium-tag">Tất cả</span>';
                }

                tr.innerHTML = `
                    <td><span class="discount-code">${discount.code}</span></td>
                    <td><span class="discount-value">${discount.percentValue}%</span></td>
                    <td>
                        <div class="discount-dates">
                            <div><strong>${new Date(discount.startDate).toLocaleDateString('vi-VN')} - ${new Date(discount.endDate).toLocaleDateString('vi-VN')}</strong></div>
                            <div style="font-size: 0.8rem; color: ${isExpired ? 'var(--danger-red)' : 'var(--text-muted)'};">
                                ${isExpired ? 'Đã hết hạn' : (remainingDays > 0 ? `Còn ${remainingDays} ngày` : 'Hết hạn hôm nay')}
                            </div>
                        </div>
                    </td>
                    <td><span class="code-type-badge type-${discount.codeType. toLowerCase()}">${codeTypeDisplay}</span></td>
                    <td>${targetDisplay}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" title="Chỉnh sửa" onclick="openDiscountModal(${discount.id})"><i class="fas fa-edit"></i></button>
                            <button class="action-btn toggle-btn" style="background: ${isActive ? '#F7665E' : '#22c55e' };" title="${isActive ? 'Khóa' : 'Mở khóa'}" onclick="openToggleStatusConfirm(${discount.id})">
                                <i class="fas ${isActive ? 'fa-lock' : 'fa-lock-open'}"></i>
                            </button>
                        </div>
                    </td>`;
                return tr;
            }

            // === MODAL & FORM LOGIC ===
            function openDiscountModal(discountId = null) {
                document.getElementById('discountForm').reset();
                document.getElementById('userSelectionResults').innerHTML = '';
                document. getElementById('userSearchInput').value = '';
                document.getElementById('endDate').setCustomValidity('');
                const modalTitle = document.getElementById('modalTitle');
                const saveBtnText = document.getElementById('saveButtonText');
                document.getElementById('discountCode').readOnly = false;
                currentEditingId = discountId;
                let selectedStadiumIds = [], isActiveValue = true, targetUserId = null;

                const today = getTodayDate();

                // Set min date cho cả tạo mới và chỉnh sửa
                setMinDates();

                if (discountId) {
                    modalTitle.textContent = 'Chỉnh sửa Mã giảm giá';
                    saveBtnText. textContent = 'Cập nhật';
                    const data = currentDiscounts.find(d => d.id === discountId);
                    if (data) {
                        document.getElementById('discountId').value = data.id;
                        document. getElementById('discountCode').value = data.code;
                        document.getElementById('discountCode').readOnly = true;
                        document.getElementById('description').value = data.description || '';
                        document.getElementById('percentValue').value = data.percentValue;
                        document.getElementById('maxDiscountAmount').value = data.maxDiscountAmount;
                        document.getElementById('minOrderAmount').value = data.minOrderAmount;

                        // Xử lý ngày bắt đầu: nếu ngày cũ < today thì set = today
                        const existingStartDate = data.startDate. slice(0, 10);
                        const existingEndDate = data.endDate.slice(0, 10);

                        if (existingStartDate < today) {
                            document.getElementById('startDate').value = today;
                        } else {
                            document.getElementById('startDate').value = existingStartDate;
                        }

                        // Xử lý ngày kết thúc: nếu ngày cũ < today thì set = today
                        if (existingEndDate < today) {
                            document.getElementById('endDate').value = today;
                        } else {
                            document.getElementById('endDate').value = existingEndDate;
                        }

                        // Cập nhật min của endDate dựa trên startDate
                        handleStartDateChange();

                        document.getElementById('codeType').value = data.codeType;
                        selectedStadiumIds = data.stadiumIds || [];
                        isActiveValue = data.isActive;
                        targetUserId = data.targetUserId;
                        if (data.codeType === 'Unique' && targetUserId) {
                             const user = allUsers.find(u => u.userId == targetUserId);
                             if (user) renderUserSelectionResults([user], targetUserId);
                        }
                    }
                } else {
                    modalTitle.textContent = 'Tạo Mã Mới';
                    saveBtnText.textContent = 'Lưu';
                    document.getElementById('startDate').value = today;

                    // Cập nhật min của endDate
                    handleStartDateChange();
                }
                renderStadiumSelectionModal(allStadiums, selectedStadiumIds);
                toggleSections();
                document.getElementById('discountForm'). dataset.isActive = isActiveValue;
                document.getElementById('discountModal').classList.add('active');
            }
            function showConfirmPopup(title, message, callback) {
                const popup = document.getElementById('confirmPopup');
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;

                // Lưu hành động cần làm vào biến
                confirmCallback = callback;

                // Gán sự kiện cho nút Đồng ý
                document.getElementById('btnConfirmYes').onclick = function() {
                    closeConfirmPopup(true);
                };

                popup.style.display = 'flex';
            }

            function closeConfirmPopup(isConfirmed) {
                document.getElementById('confirmPopup').style.display = 'none';

                // Nếu người dùng bấm Đồng ý và có hành động đang chờ -> Thực hiện nó
                if (isConfirmed && confirmCallback) {
                    confirmCallback();
                }

                // Reset biến
                if (isConfirmed) confirmCallback = null;
            }

            function showStatusPopup(type, title, message) { // Lưu ý: hàm này nhận 3 tham số để linh hoạt hơn
                const overlay = document.getElementById('statusPopup');
                const icon = document.getElementById('statusIcon');
                const titleEl = document.getElementById('statusTitle');
                const msgEl = document.getElementById('statusMessage');

                // 1. Hiển thị overlay
                overlay.style.display = 'flex'; // Dùng style.display thay vì class active để khớp với HTML style="display: none"

                // 2. Reset class icon (giữ lại class gốc fas)
                icon.className = 'fas';

                // 3. Cập nhật icon và màu sắc dựa trên type
                if (type === 'loading') {
                    icon.classList.add('fa-spinner', 'fa-spin', 'status-loading');
                } else if (type === 'success') {
                    icon.classList.add('fa-check-circle', 'status-success');
                } else if (type === 'error') {
                    icon.classList.add('fa-times-circle', 'status-error');
                }

                // 4. Cập nhật nội dung (Đây là chỗ bị lỗi null trước đó)
                // Nếu tham số title bị bỏ qua (undefined), tự động điền tiêu đề mặc định
                if (!title) {
                    if (type === 'loading') title = 'Đang xử lý';
                    else if (type === 'success') title = 'Thành công';
                    else if (type === 'error') title = 'Lỗi';
                }

                // Xử lý trường hợp gọi hàm chỉ với 2 tham số (type, message) như code cũ
                // Nếu 'title' thực ra là nội dung thông báo dài, ta gán nó vào message
                if (arguments.length === 2) {
                    message = title;
                    title = (type === 'loading') ? 'Đang xử lý' : (type === 'success' ? 'Thành công' : 'Thông báo');
                }

                if (titleEl) titleEl.textContent = title;
                if (msgEl) msgEl.textContent = message;
            }

            // Hàm ẩn popup cần sửa lại để khớp với style.display
            function hideStatusPopup() {
                document.getElementById('statusPopup').style.display = 'none';
            }

            // === HÀM MỚI: Fix lỗi đà trượt (Momentum Scroll) ===
            // Hàm này sẽ "đóng băng" thanh cuộn trong tích tắc để triệt tiêu lực quán tính
            function stopScrollMomentumAndTop() {
                const modal = document.querySelector('.modal'); // Lấy element có thanh cuộn

                // 1. Khóa cuộn tạm thời để cắt đà quán tính
                modal.classList.add('no-scroll-momentum');

                // 2. Đưa về đầu trang ngay lập tức
                modal.scrollTop = 0;

                // 3. Mở lại cuộn bình thường sau 1 khoảng thời gian cực ngắn
                setTimeout(() => {
                    modal.classList.remove('no-scroll-momentum');
                }, 50);
            }

            async function handleFormSubmit(event) {
                event.preventDefault();
                const percentInput = document.getElementById('percentValue');
                const percentVal = parseFloat(percentInput.value);

                // --- Validation cơ bản ---
                if (percentVal < 1 || percentVal > 100) {
                    // FIX SCROLL: Dừng đà trượt trước khi hiện lỗi
                    stopScrollMomentumAndTop();

                    // Thay alert bằng popup lỗi
                    showStatusPopup('error', 'Giá trị giảm (%) phải từ 1 đến 100.');
                    setTimeout(hideStatusPopup, 1500); // Tự tắt sau 1.5s

                    // Focus lại sau khi tắt popup (tùy chọn)
                    setTimeout(() => percentInput.focus(), 1600);
                    return;
                }

                const today = getTodayDate();
                const startDateValue = document.getElementById('startDate').value;
                const endDateValue = document.getElementById('endDate').value;

                if (startDateValue < today) {
                    stopScrollMomentumAndTop();
                    showStatusPopup('error', 'Ngày bắt đầu không được trong quá khứ.');
                    setTimeout(hideStatusPopup, 1500);
                    return;
                }

                if (endDateValue < today) {
                    stopScrollMomentumAndTop();
                    showStatusPopup('error', 'Ngày kết thúc không được trong quá khứ.');
                    setTimeout(hideStatusPopup, 1500);
                    return;
                }

                if (!validateDates()) {
                    stopScrollMomentumAndTop();
                    showStatusPopup('error', 'Ngày kết thúc phải lớn hơn ngày bắt đầu.');
                    setTimeout(hideStatusPopup, 1500);
                    return;
                }

                const saveButton = event.target.querySelector('.btn-save');
                saveButton.disabled = true;

                // --- Validation Logic ---
                const payload = getFormData();
                const codeType = payload.codeType;

                if (codeType === 'Stadium' || codeType === 'Unique') {
                    payload.stadiumIds = Array.from(document.querySelectorAll('#stadiumSelectionGroup input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));
                    if (payload.stadiumIds.length === 0) {
                        stopScrollMomentumAndTop();
                        showStatusPopup('error', 'Vui lòng chọn ít nhất một sân vận động.');
                        setTimeout(hideStatusPopup, 1500);
                        saveButton.disabled = false;
                        return;
                    }
                }

                if (codeType === 'Unique') {
                    const selectedUser = document.querySelector('#userSelectionResults input[name="targetUser"]:checked');
                    if (!selectedUser) {
                        stopScrollMomentumAndTop();
                        showStatusPopup('error', 'Vui lòng chọn người dùng mục tiêu.');
                        setTimeout(hideStatusPopup, 1500);
                        saveButton.disabled = false;
                        return;
                    }
                    payload.targetUserId = selectedUser.value;
                }

                payload.isActive = (event.target.dataset.isActive === "true");
                const url = currentEditingId ? '/Discount/UpdateDiscount' : '/Discount/CreateDiscount';

                // === BẮT ĐẦU GỌI API ===
                try {
                    // 1. Hiện popup loading
                    showStatusPopup('loading', currentEditingId ? 'Đang cập nhật...' : 'Đang tạo mới...');

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.success) {
                        // 2. Hiện popup thành công
                        showStatusPopup('success', currentEditingId ? 'Cập nhật thành công!' : 'Tạo mới thành công!');

                        // Đợi 1.5 giây để người dùng đọc thông báo rồi mới đóng modal và reload
                        setTimeout(() => {
                            hideStatusPopup();
                            closeDiscountModal();
                            fetchAndRenderDiscounts(currentEditingId ? currentPage : 1);
                        }, 1500);
                    } else {
                        showStatusPopup('error', 'Lỗi: ' + (result.message || 'Thao tác thất bại.'));
                        setTimeout(hideStatusPopup, 2000);
                    }
                } catch (err) {
                    console.error("Submit Error:", err);
                    showStatusPopup('error', 'Lỗi kết nối đến server.');
                    setTimeout(hideStatusPopup, 2000);
                } finally {
                    saveButton.disabled = false;
                }
            }

            function getFormData() {
                return {
                    id: currentEditingId ?  parseInt(document.getElementById('discountId').value) : 0,
                    code: document.getElementById('discountCode').value. trim(),
                    description: document.getElementById('description').value,
                    percentValue: Math.round(parseFloat(document.getElementById('percentValue').value)),
                    maxDiscountAmount: parseFloat(document.getElementById('maxDiscountAmount').value) || 0,
                    minOrderAmount: parseFloat(document. getElementById('minOrderAmount').value) || 0,
                    startDate: new Date(document.getElementById('startDate').value + 'T00:00:00Z'),
                    endDate: new Date(document.getElementById('endDate').value + 'T23:59:59Z'),
                    codeType: document.getElementById('codeType').value,
                    stadiumIds: [],
                    targetUserId: null
                };
            }

            async function openToggleStatusConfirm(discountId) {
                const discount = currentDiscounts.find(d => d.id === discountId);
                if (!discount) return;

                const actionText = discount.isActive ? 'khóa' : 'mở khóa';
                const message = `Bạn có chắc chắn muốn ${actionText} mã giảm giá "${discount.code}" không?`;

                // Gọi Popup xác nhận thay vì confirm() mặc định
                showConfirmPopup('Xác nhận thay đổi', message, async function() {
                    // --- Code bên trong này chỉ chạy khi bấm "Đồng ý" ---
                    try {
                        // Hiện loading
                        showStatusPopup('loading', 'Đang xử lý', 'Đang cập nhật trạng thái...');

                        const payload = { ...discount, isActive: !discount.isActive };

                        const response = await fetch('/Discount/UpdateDiscount', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await response.json();

                        if (result.success) {
                            showStatusPopup('success', 'Thành công', `Đã ${actionText} thành công!`);
                            setTimeout(() => {
                                hideStatusPopup();
                                fetchAndRenderDiscounts(currentPage);
                            }, 1000);
                        } else {
                            showStatusPopup('error', 'Lỗi', result.message || 'Thất bại.');
                            setTimeout(hideStatusPopup, 2000);
                        }
                    } catch (err) {
                        showStatusPopup('error', 'Lỗi kết nối', 'Không thể kết nối đến server.');
                        setTimeout(hideStatusPopup, 2000);
                    }
                });
            }

            function renderFilterOptions(stadiums) {
                const stadiumFilter = document.getElementById('stadiumFilter');
                stadiums.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = s.name;
                    stadiumFilter.appendChild(option);
                });
            }

            function renderStadiumSelectionModal(stadiums, selectedIds = []) {
                const container = document.getElementById('stadiumSelectionGroup');
                container.innerHTML = '';
                stadiums.forEach(s => {
                    const checked = selectedIds.includes(s. id) ?  'checked' : '';
                    container.innerHTML += `
                        <div class="stadium-card">
                            <div class="stadium-card-header">
                                <div class="stadium-info">
                                    <i class="fas fa-futbol stadium-icon"></i>
                                    <div><h4>${s.name}</h4><p>${s.address}</p></div>
                                </div>
                                <label class="custom-checkbox"><input type="checkbox" name="stadiumIds" value="${s.id}" ${checked} onchange="updateStadiumCount()"><span class="checkmark"></span></label>
                            </div>
                        </div>`;
                });
                updateStadiumCount();
            }

            function updateStadiumCount() {
                const selectedCount = document.querySelectorAll('#stadiumSelectionGroup input[type="checkbox"]:checked').length;
                document.getElementById('stadiumsSelectedCount').textContent = `${selectedCount} sân được chọn`;
            }

            function selectAllStadiums(select) {
                const checkboxes = document.querySelectorAll('#stadiumSelectionGroup input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = select;
                });
                updateStadiumCount();
            }

            function closeDiscountModal() { document.getElementById('discountModal'). classList.remove('active'); }

            function toggleSections() {
                const codeType = document.getElementById('codeType').value;
                document.getElementById('stadiumSelectionSection').style.display = (codeType === 'Stadium' || codeType === 'Unique') ? 'block' : 'none';
                document. getElementById('userSelectionSection').style.display = codeType === 'Unique' ? 'block' : 'none';
            }

            function validateDates() {
                const startDate = document.getElementById('startDate').value;
                const endDateInput = document.getElementById('endDate');
                if (startDate && endDateInput. value && startDate > endDateInput.value) {
                    endDateInput. setCustomValidity('Ngày kết thúc không được nhỏ hơn ngày bắt đầu.');
                    endDateInput.reportValidity();
                    return false;
                }
                endDateInput.setCustomValidity('');
                return true;
            }

            async function searchUsers() {
                const searchTerm = document.getElementById('userSearchInput').value;
                const resultsContainer = document.getElementById('userSelectionResults');
                if (! searchTerm. trim()) {
                    resultsContainer.innerHTML = '<p class="user-search-message">Nhập SĐT hoặc Email để tìm người dùng. </p>';
                    return;
                }
                resultsContainer.innerHTML = '<p class="user-search-message"><i class="fas fa-spinner fa-spin"></i> Đang tìm...</p>';
                try {
                    const response = await fetch(`/Discount/SearchUsers?searchTerm=${encodeURIComponent(searchTerm)}`);
                    const result = await response.json();
                    if (result.success && result.users) {
                        cacheUserData(result.users);
                        renderUserSelectionResults(result.users, document.querySelector('#userSelectionResults input[name="targetUser"]:checked')?.value);
                    } else {
                        resultsContainer. innerHTML = `<p class="user-search-message">${result.message || 'Không tìm thấy người dùng.'}</p>`;
                    }
                } catch (error) {
                    console.error('Lỗi tìm kiếm người dùng:', error);
                    resultsContainer.innerHTML = '<p class="user-search-message">Lỗi kết nối server.</p>';
                }
            }

            function renderUserSelectionResults(users, selectedUserId = null) {
                const container = document.getElementById('userSelectionResults');
                if (users.length === 0 && ! selectedUserId) {
                    container.innerHTML = '<p class="user-search-message">Không tìm thấy người dùng nào.</p>';
                    return;
                }
                container.innerHTML = users.map(user => {
                    const checked = user.userId == selectedUserId ? 'checked' : '';
                    const avatarSrc = user.avatarUrl ? `https://localhost:7136/${user.avatarUrl}` : '/images/default-avatar.png';
                    return `
                        <div class="user-card ${checked ?  'user-card-selected' : ''}">
                           <label class="user-card-content">
                                <img src="${avatarSrc}" alt="Avatar" class="user-avatar" onerror="this.src='/images/default-avatar.png'; this.onerror=null;">
                                <div class="user-info">
                                    <h4>${user.fullName}</h4>
                                    <p><i class="fas fa-envelope"></i> ${user.email || 'N/A'}</p>
                                    <p><i class="fas fa-phone"></i> ${user.phoneNumber || 'N/A'}</p>
                                </div>
                                <input type="radio" name="targetUser" value="${user.userId}" ${checked} onchange="highlightSelectedUser(this)">
                                <span class="radio-checkmark"></span>
                            </label>
                        </div>`;
                }).join('');
            }

            function highlightSelectedUser(radioBtn) {
                document.querySelectorAll('.user-card').forEach(card => {
                    card.classList.remove('user-card-selected');
                });
                if (radioBtn.checked) {
                    radioBtn.closest('.user-card').classList.add('user-card-selected');
                }
            }

            function cacheUserData(users) {
                users.forEach(user => {
                    if (!allUsers.some(u => u. userId === user.userId)) {
                        allUsers.push(user);
                    }
                });
            }
        </script>
    }


</body>
</html>